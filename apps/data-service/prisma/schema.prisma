// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// USERS & AUTHENTICATION
// ========================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String?
  lastName  String?
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  notes         Note[]
  activities    ActivityLog[]
  emailsSent    Email[]       @relation("EmailSender")
  tasksCreated  Task[]        @relation("TaskCreator")
  tasksAssigned Task[]        @relation("TaskAssignee")
  notifications Notification[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ========================================
// LEADS
// ========================================

model Lead {
  id             String         @id @default(uuid())
  source         LeadSource     @default(MANUAL)
  email          String?
  phone          String?
  firstName      String?
  lastName       String?
  street         String?
  city           String?
  state          String?
  zipCode        String?
  country        String?

  // Insurance details - merged from both versions
  insuranceType  InsuranceType?
  insuranceTypes InsuranceType[] @default([])
  currentProvider String?
  policyExpiryDate DateTime?

  // Lead information - enhanced from Phase 2.2
  dateOfBirth    DateTime?
  urgency        Urgency       @default(MEDIUM)
  intent         String?
  qualityScore   Float?

  // AI processing - from Phase 2.2
  aiProcessedAt   DateTime?
  aiScoreReason   String?
  similarityScore Float?
  enrichedData    Json?

  // Status and metadata
  status         LeadStatus    @default(RECEIVED)
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations - merged from both versions
  notes         Note[]
  activities    ActivityLog[]
  emails        Email[]
  tasks         Task[]
  assignments   LeadAssignment[]
  events        LeadEvent[]
  
  // New relations for Phase 16.3.8
  experimentAssignments ExperimentAssignment[]
  campaignLeads        CampaignLead[]
  state                LeadState?
  attributionLogs      AttributionLog[]
  orchestrationEvents  OrchestrationEvent[]
  customerTouchpoints  CustomerTouchpoint[]
  engagement           CustomerEngagement?

  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([source])
  @@index([urgency])
  @@map("leads")
}

enum LeadSource {
  WEB_FORM
  PHONE
  EMAIL
  REFERRAL
  PARTNER_API
  MANUAL
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
  RENTERS
  UMBRELLA
  DISABILITY
  LONG_TERM_CARE
  PET
}

enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONTACTED
  CONVERTED
  REJECTED
  DUPLICATE
  INVALID
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ========================================
// LEAD EVENTS (from Phase 2.2)
// ========================================

model LeadEvent {
  id          String   @id @default(uuid())
  leadId      String
  eventType   String
  eventData   Json?
  source      String?
  createdAt   DateTime @default(now())

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([eventType])
  @@index([createdAt])
  @@map("lead_events")
}

// ========================================
// NOTES & COMMENTS
// ========================================

model Note {
  id         String           @id @default(uuid())
  leadId     String
  authorId   String
  content    String           @db.Text
  visibility NoteVisibility   @default(TEAM)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  lead        Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  author      User            @relation(fields: [authorId], references: [id])
  attachments NoteAttachment[]

  @@index([leadId])
  @@index([authorId])
  @@index([createdAt])
  @@map("notes")
}

enum NoteVisibility {
  PRIVATE
  TEAM
  PUBLIC
}

model NoteAttachment {
  id        String   @id @default(uuid())
  noteId    String
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())

  // Relations
  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@map("note_attachments")
}

// ========================================
// ACTIVITY LOG & TIMELINE
// ========================================

model ActivityLog {
  id          String       @id @default(uuid())
  leadId      String
  userId      String?
  activityType ActivityType
  action      String
  description String?
  metadata    Json?
  createdAt   DateTime     @default(now())

  // Relations
  lead Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@map("activity_logs")
}

enum ActivityType {
  LEAD_CREATED
  LEAD_UPDATED
  STATUS_CHANGED
  ASSIGNMENT_CREATED
  ASSIGNMENT_UPDATED
  NOTE_CREATED
  NOTE_UPDATED
  NOTE_DELETED
  EMAIL_SENT
  EMAIL_RECEIVED
  TASK_CREATED
  TASK_UPDATED
  TASK_COMPLETED
  SYSTEM_ACTION
  WORKFLOW_TRIGGERED
}

// ========================================
// EMAIL COMMUNICATION
// ========================================

model Email {
  id          String      @id @default(uuid())
  leadId      String
  senderId    String
  to          String[]
  cc          String[]    @default([])
  bcc         String[]    @default([])
  subject     String
  body        String      @db.Text
  bodyHtml    String?     @db.Text
  templateId  String?
  threadId    String?
  status      EmailStatus @default(PENDING)
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  scheduledFor DateTime?
  error       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  lead        Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  sender      User             @relation("EmailSender", fields: [senderId], references: [id])
  template    EmailTemplate?   @relation(fields: [templateId], references: [id])
  attachments EmailAttachment[]

  @@index([leadId])
  @@index([senderId])
  @@index([threadId])
  @@index([status])
  @@index([createdAt])
  @@map("emails")
}

enum EmailStatus {
  PENDING
  SCHEDULED
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

model EmailTemplate {
  id          String   @id @default(uuid())
  name        String
  subject     String
  body        String   @db.Text
  bodyHtml    String?  @db.Text
  variables   String[] @default([])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  emails Email[]

  @@map("email_templates")
}

model EmailAttachment {
  id        String   @id @default(uuid())
  emailId   String
  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())

  // Relations
  email Email @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@map("email_attachments")
}

// ========================================
// TASKS & FOLLOW-UPS
// ========================================

model Task {
  id          String       @id @default(uuid())
  leadId      String
  creatorId   String
  assigneeId  String?
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(OPEN)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  recurrence  String?
  metadata    Json?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  lead     Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  creator  User  @relation("TaskCreator", fields: [creatorId], references: [id])
  assignee User? @relation("TaskAssignee", fields: [assigneeId], references: [id])

  @@index([leadId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@map("tasks")
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ========================================
// NOTIFICATIONS
// ========================================

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  entityType String?
  entityId  String?
  isRead    Boolean            @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime           @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE_SOON
  TASK_OVERDUE
  NOTE_MENTION
  EMAIL_RECEIVED
  LEAD_ASSIGNED
  LEAD_UPDATED
  SYSTEM_ALERT
}

// ========================================
// AGENTS
// ========================================

model Agent {
  id                  String      @id @default(uuid())
  firstName           String
  lastName            String
  email               String      @unique
  phone               String
  licenseNumber       String
  specializations     InsuranceType[]
  city                String
  state               String
  country             String
  zipCode             String?

  // Performance metrics - enhanced from Phase 2.2
  rating              Float       @default(0)
  averageResponseTime Int         @default(0)
  conversionRate      Float       @default(0)
  totalLeadsAssigned  Int         @default(0)
  totalLeadsConverted Int         @default(0)

  // Capacity management - enhanced from Phase 2.2
  maxLeadCapacity     Int         @default(10)
  currentLeadCount    Int         @default(0)

  // Status and authentication - enhanced from Phase 2.2
  status              AgentStatus @default(ACTIVE)
  isActive            Boolean     @default(true)
  passwordHash        String?
  lastLoginAt         DateTime?

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relations
  assignments         LeadAssignment[]

  // Phase 9.6c: VIP & Community
  vipStatus           AgentVIPStatus?
  communityPosts      CommunityPost[]
  communityComments   CommunityComment[]
  communityLikes      CommunityLike[]

  // Phase 12.5: Groups, Events, Badges, Profiles, Connections, Mentorship
  createdGroups       CommunityGroup[]        @relation("GroupCreator")
  groupMemberships    CommunityGroupMember[]

  hostedEvents        CommunityEvent[]        @relation("EventHost")
  eventAttendances    CommunityEventAttendee[]

  badges              AgentBadge[]
  profile             AgentProfile?

  followingConnections AgentConnection[]      @relation("Follower")
  followerConnections  AgentConnection[]      @relation("Following")

  mentorshipAsMentor  MentorshipRelationship[] @relation("Mentor")
  mentorshipAsMentee  MentorshipRelationship[] @relation("Mentee")

  @@index([email])
  @@index([isActive])
  @@index([status])
  @@index([state])
  @@map("agents")
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model LeadAssignment {
  id         String               @id @default(uuid())
  leadId     String
  agentId    String
  status     LeadAssignmentStatus @default(PENDING)

  // Enhanced matching fields from Phase 2.2
  matchScore  Float?
  matchReason String?
  priority    Int                  @default(0)

  // Timestamps
  assignedAt DateTime             @default(now())
  acceptedAt DateTime?
  rejectedAt DateTime?
  viewedAt   DateTime?

  // Conversion tracking from Phase 2.2
  convertedAt DateTime?
  conversionValue Float?

  notes      String?

  // Relations
  lead  Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id])

  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@map("lead_assignments")
}

enum LeadAssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
  EXPIRED
}

// ========================================
// CUSTOMERS & POLICIES
// ========================================

model Customer {
  id                      String      @id @default(uuid())
  leadId                  String      @unique
  agentId                 String?
  firstName               String
  lastName                String
  email                   String      @unique
  phoneNumber             String?
  isVerified              Boolean     @default(false)
  lastLoginAt             DateTime?
  customerSince           DateTime    @default(now())
  totalPolicies           Int         @default(0)
  activePolicies          Int         @default(0)
  lifetimeValue           Float       @default(0.0)
  satisfactionScore       Float?
  healthScore             Float       @default(50.0)
  churnRisk               ChurnRisk   @default(LOW)
  lastContactDate         DateTime?
  nextRenewalDate         DateTime?
  preferredContactMethod  String?
  tags                    String[]
  metadata                Json?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  // Relations
  lead                    Lead        @relation(fields: [leadId], references: [id])
  profile                 CustomerProfile?
  documents               CustomerDocument[]
  messages                CustomerMessage[]
  policies                Policy[]
  ltvSegments             LTVSegment[]
  churnRiskScores         ChurnRiskScore[]

  @@map("customers")
}

model CustomerProfile {
  id                String   @id @default(uuid())
  customerId        String   @unique
  dateOfBirth       DateTime?
  preferredContact  String   @default("email")
  address           Json?
  emergencyContact  Json?
  preferences       Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_profiles")
}

model CustomerDocument {
  id            String   @id @default(uuid())
  customerId    String
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  documentType  String
  status        String   @default("pending")
  verifiedBy    String?
  verifiedAt    DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_documents")
}

model CustomerMessage {
  id            String   @id @default(uuid())
  customerId    String
  agentId       String?
  senderType    String   // customer, agent, system
  subject       String?
  message       String   @db.Text
  isRead        Boolean  @default(false)
  readAt        DateTime?
  createdAt     DateTime @default(now())

  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_messages")
}

model Policy {
  id                  String        @id @default(uuid())
  customerId          String
  agentId             String?
  policyNumber        String        @unique
  insuranceType       InsuranceType
  status              PolicyStatus  @default(ACTIVE)
  premiumAmount       Float
  premiumFrequency    String
  premiumCurrency     String        @default("USD")
  coverageType        String
  coverageAmount      Float
  coverageDeductible  Float?
  coverageLimits      Json?
  effectiveDate       DateTime
  expirationDate      DateTime
  renewalDate         DateTime
  lastRenewalDate     DateTime?
  renewalCount        Int           @default(0)
  totalPaid           Float         @default(0.0)
  claimsCount         Int           @default(0)
  totalClaimAmount    Float         @default(0.0)
  underwriter         String?
  documents           String[]
  metadata            Json?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  customer            Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("policies")
}

enum ChurnRisk {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum PolicyStatus {
  ACTIVE
  CANCELLED
  LAPSED
  EXPIRED
  NON_RENEWED
}

// ========================================
// PREDICTIVE ANALYTICS (Phase 27.1)
// ========================================

model MLModel {
  id                String   @id @default(uuid())
  name              String
  modelType         String   // conversion, ltv, churn, roi
  version           Int
  trainingDate      DateTime
  evaluationDate    DateTime?
  performanceMetrics Json?    // {accuracy, precision, recall, auc, rmse}
  featureImportance Json?
  isActive          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  predictions       LeadPrediction[]

  @@map("ml_models")
}

model LeadPrediction {
  id              String   @id @default(uuid())
  leadId          String
  modelId         String   @map("model_version_id")
  predictionType  String   // conversion, ltv, churn, roi_source
  predictedValue  Float
  confidence      Float?
  explanation     Json?    // feature contributions
  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  model           MLModel  @relation(fields: [modelId], references: [id])

  @@unique([leadId, predictionType, modelId])
  @@index([leadId])
  @@index([predictionType])
  @@index([expiresAt])
  @@map("lead_predictions")
}

model LTVSegment {
  id                String   @id @default(uuid())
  customerId        String
  segmentTier       Int      // 1-4
  calculatedLTV     Decimal  @db.Decimal(12, 2)
  confidence        Float?
  lastCalculated    DateTime?
  nextRecalculation DateTime?
  updatedAt         DateTime @updatedAt

  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([segmentTier])
  @@map("ltv_segments")
}

model ChurnRiskScore {
  id                    String   @id @default(uuid())
  customerId            String
  churnProbability      Float
  riskLevel             String?  // High, Medium, Low
  daysToChurn           Int?
  contributingFactors   Json?
  interventionRecommended Boolean?
  lastScored            DateTime?
  createdAt             DateTime @default(now())

  customer              Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([churnProbability])
  @@map("churn_risk_scores")
}

model ROIMetric {
  id                    String   @id @default(uuid())
  leadSource            String
  period                DateTime @db.Date
  totalLeads            Int?
  convertedLeads        Int?
  conversionRate        Float?
  totalAcquisitionCost  Decimal? @db.Decimal(12, 2)
  totalLTV              Decimal? @db.Decimal(12, 2)
  roiPercentage         Float?
  paybackDays           Int?
  forecastRevenue30d    Decimal? @db.Decimal(12, 2)
  forecastRevenue60d    Decimal? @db.Decimal(12, 2)
  forecastRevenue90d    Decimal? @db.Decimal(12, 2)
  updatedAt             DateTime @updatedAt

  @@unique([leadSource, period])
  @@index([leadSource, period])
  @@map("roi_metrics")
}

model ModelTrainingJob {
  id                String   @id @default(uuid())
  modelType         String
  status            String   // pending, running, completed, failed
  trainingStart     DateTime?
  trainingEnd       DateTime?
  trainingSamples   Int?
  testSamples       Int?
  validationSamples Int?
  performanceMetrics Json?
  errorLog          String?  @db.Text
  createdAt         DateTime @default(now())

  @@map("model_training_jobs")
}

model PredictionAuditLog {
  id                  String   @id @default(uuid())
  leadId              String
  modelType           String
  actualOutcome       String?
  predictedValue      Float?
  predictionTimestamp DateTime?
  outcomeTimestamp    DateTime?
  accuracyError       Float?   // |actual - predicted|
  createdAt           DateTime @default(now())

  lead                Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("prediction_audit_log")
}

// ========================================
// SYSTEM CONFIGURATION (from Phase 2.2)
// ========================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  category  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("system_config")
}

// ========================================
// PARTNER MANAGEMENT (Phase 15.2)
// ========================================

model Partner {
  id                String               @id @default(uuid())
  name              String
  code              String               @unique
  website           String?
  logoUrl           String?
  contactEmail      String?
  contactPhone      String?

  // Partner details
  businessType      PartnerType          @default(AGENCY)
  licenseNumber     String?
  ein               String?
  businessAddress   Json?
  billingAddress    Json?

  // Partnership details
  partnershipTier   PartnershipTier      @default(BASIC)
  partnershipStatus PartnershipStatus    @default(ACTIVE)
  contractStartDate DateTime
  contractEndDate   DateTime?
  commissionRate    Float                @default(0.0)

  // Integration details
  integrationType   IntegrationType      @default(REST_API)
  apiKey            String?
  apiSecret         String?
  apiVersion        String?
  webhookUrl        String?

  // Configuration
  isActive          Boolean              @default(true)
  priority          Int                  @default(0)

  // Performance metrics
  performanceScore    Float               @default(0.0)
  conversionRate      Float               @default(0.0)
  averageResponseTime Float               @default(0.0)
  totalLeadsReceived  Int                 @default(0)
  totalLeadsConverted Int                 @default(0)

  // Rate limiting
  rateLimit         Int                  @default(100)
  rateLimitWindow   Int                  @default(60)

  // Metadata
  metadata          Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  users             PartnerUser[]
  trainingProgress  PartnerTrainingProgress[]
  certifications    PartnerCertification[]
  performanceMetrics PartnerPerformanceMetric[]
  supportTickets    PartnerSupportTicket[]

  @@index([code])
  @@index([isActive])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@map("partners")
}

model PartnerUser {
  id                String               @id @default(uuid())
  partnerId         String
  firstName         String
  lastName          String
  email             String               @unique
  phone             String?
  role              PartnerUserRole      @default(USER)
  status            PartnerUserStatus    @default(ACTIVE)
  lastLoginAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  partner           Partner              @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  trainingProgress  PartnerTrainingProgress[]
  certifications    PartnerCertification[]

  @@index([partnerId])
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("partner_users")
}

model PartnerTrainingProgress {
  id                String               @id @default(uuid())
  partnerId         String
  userId            String
  trainingModuleId  String
  status            TrainingStatus       @default(NOT_STARTED)
  progress          Float                @default(0.0)
  startedAt         DateTime?
  completedAt       DateTime?
  score             Float?
  notes             String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  partner           Partner              @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user              PartnerUser          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([userId])
  @@index([trainingModuleId])
  @@index([status])
  @@map("partner_training_progress")
}

model PartnerCertification {
  id                String               @id @default(uuid())
  partnerId         String
  userId            String
  certificationType CertificationType    @default(BASIC)
  status            CertificationStatus  @default(NOT_STARTED)
  examScore         Float?
  certifiedAt       DateTime?
  expiresAt         DateTime?
  renewalRequired   Boolean              @default(false)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  partner           Partner              @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user              PartnerUser          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([userId])
  @@index([certificationType])
  @@index([status])
  @@map("partner_certifications")
}

model PartnerPerformanceMetric {
  id                    String               @id @default(uuid())
  partnerId             String
  month                 Int
  year                  Int
  leadsReceived         Int                  @default(0)
  leadsConverted        Int                  @default(0)
  conversionRate        Float                @default(0.0)
  averageResponseTime   Float                @default(0.0)
  averageQuoteValue     Float                @default(0.0)
  customerSatisfaction  Float                @default(0.0)
  onTimeDeliveryRate    Float                @default(0.0)
  createdAt             DateTime             @default(now())

  // Relations
  partner              Partner              @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([partnerId, year, month])
  @@map("partner_performance_metrics")
}

model PartnerSupportTicket {
  id                String               @id @default(uuid())
  partnerId         String
  userId            String?
  title             String
  description       String                @db.Text
  status            SupportTicketStatus   @default(OPEN)
  priority          SupportTicketPriority @default(MEDIUM)
  category          SupportTicketCategory @default(GENERAL)
  assignedTo        String?
  resolutionNotes   String?               @db.Text
  resolvedAt        DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  partner           Partner              @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user              PartnerUser?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([partnerId])
  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@map("partner_support_tickets")
}

model TrainingModule {
  id                String               @id @default(uuid())
  title             String
  description       String                @db.Text
  moduleType        TrainingModuleType    @default(FUNDAMENTALS)
  contentUrl        String?
  videoUrl          String?
  durationMinutes   Int                  @default(30)
  isActive          Boolean              @default(true)
  order             Int                  @default(0)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([moduleType])
  @@index([isActive])
  @@index([order])
  @@map("training_modules")
}

// ========================================
// INSURANCE CARRIER & BROKER INTEGRATIONS (Phase 8.6)
// ========================================

model InsuranceCarrier {
  id                String               @id @default(uuid())
  name              String
  code              String               @unique
  website           String?
  logoUrl           String?
  contactEmail      String?
  contactPhone      String?

  // Carrier capabilities
  supportedProducts InsuranceType[]
  apiEndpoint       String?
  webhookUrl        String?
  documentationUrl  String?

  // Integration details
  integrationType   IntegrationType      @default(REST_API)
  apiKey            String?
  apiSecret         String?
  apiVersion        String?

  // Configuration
  isActive          Boolean              @default(true)
  isPrimary         Boolean              @default(false)
  priority          Int                  @default(0)

  // Rate limiting
  rateLimit         Int                  @default(100)
  rateLimitWindow   Int                  @default(60) // seconds

  // Metadata
  metadata          Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  brokers           Broker[]
  configs           IntegrationConfig[]
  logs              IntegrationLog[]

  @@index([code])
  @@index([isActive])
  @@index([integrationType])
  @@map("insurance_carriers")
}

model Broker {
  id                String               @id @default(uuid())
  name              String
  code              String               @unique
  website           String?
  logoUrl           String?
  contactEmail      String?
  contactPhone      String?

  // Broker details
  licenseNumber     String?
  ein               String?
  businessAddress   Json?

  // Carrier relationships
  carrierId         String?
  carrier           InsuranceCarrier?    @relation(fields: [carrierId], references: [id])

  // Integration details
  integrationType   IntegrationType      @default(REST_API)
  apiKey            String?
  apiSecret         String?
  apiVersion        String?

  // Configuration
  isActive          Boolean              @default(true)
  priority          Int                  @default(0)

  // Rate limiting
  rateLimit         Int                  @default(100)
  rateLimitWindow   Int                  @default(60)

  // Metadata
  metadata          Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relations
  configs           IntegrationConfig[]
  logs              IntegrationLog[]

  @@index([code])
  @@index([isActive])
  @@index([integrationType])
  @@map("brokers")
}

model IntegrationConfig {
  id          String               @id @default(uuid())
  name        String
  description String?

  // Entity references
  carrierId   String?
  carrier     InsuranceCarrier?    @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  brokerId    String?
  broker      Broker?              @relation(fields: [brokerId], references: [id], onDelete: Cascade)

  // Configuration
  configType  IntegrationConfigType
  config      Json                 // Configuration data (endpoints, mappings, etc.)

  // Status
  isActive    Boolean              @default(true)
  isEnabled   Boolean              @default(true)

  // Metadata
  metadata    Json?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relations
  logs        IntegrationLog[]

  @@index([configType])
  @@index([isActive])
  @@index([isEnabled])
  @@map("integration_configs")
}

model IntegrationLog {
  id          String             @id @default(uuid())
  entityType  IntegrationEntityType
  entityId    String

  // Entity references
  carrierId   String?
  carrier     InsuranceCarrier?  @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  brokerId    String?
  broker      Broker?            @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  configId    String?
  config      IntegrationConfig? @relation(fields: [configId], references: [id], onDelete: Cascade)

  // Log details
  action      IntegrationAction
  direction   Direction          @default(OUTBOUND)
  requestData Json?
  responseData Json?
  statusCode  Int?
  success     Boolean
  error       String?

  // Performance
  duration    Int?               // milliseconds

  // Metadata
  metadata    Json?
  createdAt   DateTime           @default(now())

  @@index([entityType, entityId])
  @@index([action])
  @@index([success])
  @@index([createdAt])
  @@map("integration_logs")
}

// Enums for partner management

enum PartnerType {
  AGENCY
  BROKERAGE
  INDEPENDENT_AGENT
  MGU
  MGA
  WHOLSALE_BROKER
  REINSURANCE_BROKER
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

enum PartnerUserRole {
  USER
  MANAGER
  ADMIN
  EXECUTIVE
  TRAINING_ADMIN
  SUPPORT_CONTACT
}

enum PartnerUserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum CertificationType {
  BASIC
  ADVANCED
  EXPERT
  PLATFORM_PROFESSIONAL
  INTEGRATION_SPECIALIST
}

enum CertificationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  REVOKED
}

enum TrainingModuleType {
  FUNDAMENTALS
  LEAD_MANAGEMENT
  INTEGRATION
  ADVANCED_FEATURES
  COMPLIANCE
  BEST_PRACTICES
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  REOPENED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportTicketCategory {
  GENERAL
  TECHNICAL
  TRAINING
  BILLING
  INTEGRATION
  PERFORMANCE
}

// Enums for integrations

enum IntegrationType {
  REST_API
  SOAP_API
  WEBHOOK
  FTP
  SFTP
  FILE_IMPORT
  FILE_EXPORT
}

enum IntegrationConfigType {
  API_ENDPOINTS
  MAPPING_RULES
  VALIDATION_RULES
  TRANSFORMATION_RULES
  NOTIFICATION_SETTINGS
  RATE_LIMITING
  AUTHENTICATION
}

enum IntegrationEntityType {
  INSURANCE_CARRIER
  BROKER
  LEAD
  POLICY
  CLAIM
  QUOTE
}

enum IntegrationAction {
  LEAD_SUBMITTED
  LEAD_STATUS_UPDATE
  QUOTE_REQUESTED
  QUOTE_RECEIVED
  POLICY_CREATED
  POLICY_UPDATED
  CLAIM_SUBMITTED
  CLAIM_STATUS_UPDATE
  WEBHOOK_RECEIVED
  DATA_SYNC
  VALIDATION_CHECK
  ERROR_RETRY
}

enum Direction {
  INBOUND
  OUTBOUND
}

// ========================================
// BROKER EDUCATION & COMPETENCY (Phase 12.3)
// ========================================

model Course {
  id              String       @id @default(uuid())
  title           String
  description     String       @db.Text
  category        String
  level           CompetencyLevel
  status          CourseStatus @default(DRAFT)
  thumbnailUrl    String?
  estimatedHours  Int
  prerequisites   String[]
  tags            String[]
  objectives      String[]
  instructorName  String?
  version         Int          @default(1)
  publishedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  relations       Module[]
  enrollments     Enrollment[]
  assessments     Assessment[]
  certificates    Certificate[]

  @@index([status])
  @@index([category])
  @@index([level])
  @@map("courses")
}

model Module {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String   @db.Text
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([courseId])
  @@index([order])
  @@map("modules")
}

model Lesson {
  id              String   @id @default(uuid())
  moduleId        String
  title           String
  content         String   @db.Text
  videoUrl        String?
  resourcesUrl    String?
  order           Int
  durationMinutes Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  module          Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        LessonProgress[]

  @@index([moduleId])
  @@index([order])
  @@map("lessons")
}

model Assessment {
  id               String         @id @default(uuid())
  courseId         String
  title            String
  description      String?        @db.Text
  type             AssessmentType
  timeLimitMinutes Int?
  passingScore     Int
  maxAttempts      Int
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  course           Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions        Question[]
  attempts         AssessmentAttempt[]
  certificates     Certificate[]

  @@index([courseId])
  @@index([type])
  @@map("assessments")
}

model Question {
  id            String       @id @default(uuid())
  assessmentId  String
  type          QuestionType
  text          String       @db.Text
  options       String[]
  correctAnswer String
  explanation   String?      @db.Text
  points        Int
  order         Int

  assessment    Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([order])
  @@map("questions")
}

model AssessmentAttempt {
  id            String   @id @default(uuid())
  assessmentId  String
  agentId       String
  attemptNumber Int
  score         Int
  passed        Boolean
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  answers       Json

  assessment    Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([agentId])
  @@index([passed])
  @@map("assessment_attempts")
}

model Enrollment {
  id               String         @id @default(uuid())
  courseId         String
  agentId          String
  status           EnrollmentStatus @default(NOT_STARTED)
  progress         Int            @default(0)
  currentLessonId  String?
  enrolledAt       DateTime       @default(now())
  completedAt      DateTime?
  lastAccessedAt   DateTime?

  course           Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress   LessonProgress[]

  @@unique([courseId, agentId])
  @@index([agentId])
  @@index([status])
  @@map("enrollments")
}

model LessonProgress {
  id               String   @id @default(uuid())
  enrollmentId     String
  lessonId         String
  completed        Boolean  @default(false)
  timeSpentMinutes Int      @default(0)
  completedAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  enrollment       Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson           Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model Competency {
  id          String           @id @default(uuid())
  name        String
  description String           @db.Text
  category    String
  level       CompetencyLevel
  skills      String[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  agentCompetencies AgentCompetency[]

  @@index([category])
  @@index([level])
  @@map("competencies")
}

model AgentCompetency {
  id               String           @id @default(uuid())
  agentId          String
  competencyId     String
  level            CompetencyLevel
  assessedAt       DateTime         @default(now())
  evidence         String[]
  assessmentMethod String?

  competency       Competency       @relation(fields: [competencyId], references: [id], onDelete: Cascade)

  @@unique([agentId, competencyId])
  @@index([agentId])
  @@index([competencyId])
  @@map("agent_competencies")
}

model LearningPath {
  id                String         @id @default(uuid())
  title             String
  description       String         @db.Text
  category          String
  targetRole        String?
  targetLevel       CompetencyLevel
  estimatedWeeks    Int
  requiredCourses   String[]
  electiveCourses   String[]
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  pathEnrollments   PathEnrollment[]

  @@index([category])
  @@index([targetRole])
  @@index([isActive])
  @@map("learning_paths")
}

model PathEnrollment {
  id               String         @id @default(uuid())
  learningPathId   String
  agentId          String
  status           EnrollmentStatus @default(NOT_STARTED)
  progress         Int            @default(0)
  enrolledAt       DateTime       @default(now())
  completedAt      DateTime?
  completedCourses String[]

  learningPath     LearningPath   @relation(fields: [learningPathId], references: [id], onDelete: Cascade)

  @@unique([learningPathId, agentId])
  @@index([agentId])
  @@index([status])
  @@map("path_enrollments")
}

model Certificate {
  id               String           @id @default(uuid())
  agentId          String
  courseId         String?
  assessmentId     String?
  certificateNumber String          @unique
  title            String
  description      String          @db.Text
  issueDate        DateTime         @default(now())
  expiryDate       DateTime?
  status           CertificateStatus @default(ACTIVE)
  verificationUrl  String?
  credentialId     String?

  course           Course?          @relation(fields: [courseId], references: [id], onDelete: SetNull)
  assessment       Assessment?      @relation(fields: [assessmentId], references: [id], onDelete: SetNull)

  @@index([agentId])
  @@index([certificateNumber])
  @@index([status])
  @@map("certificates")
}

// Enums for Education

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum EnrollmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
  DROPPED
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum AssessmentType {
  QUIZ
  EXAM
  CERTIFICATION
}

enum CompetencyLevel {
  NOVICE
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CertificateStatus {
  ACTIVE
  EXPIRED
  REVOKED
}
