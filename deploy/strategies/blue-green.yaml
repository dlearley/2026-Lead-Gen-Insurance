# Blue-Green Deployment Strategy Configuration
# This strategy maintains two identical production environments and switches traffic between them

strategy:
  name: "blue-green"
  description: "Zero-downtime deployment with instant rollback capability"

# Blue-Green Environment Configuration
environments:
  blue:
    label: "blue"
    color: "#007bff"
    is_active: false
    traffic_percentage: 0
    health_check_endpoint: "/health"
    
  green:
    label: "green"
    color: "#28a745"
    is_active: true
    traffic_percentage: 100
    health_check_endpoint: "/health"

# Deployment Configuration
deployment:
  # Replica configuration for each environment
  replicas:
    blue: 3
    green: 3
    
  # Resource allocation per environment
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2000m"
      memory: "2Gi"
  
  # Deployment strategy settings
  strategy:
    type: "RollingUpdate"
    rolling_update:
      max_surge: 1
      max_unavailable: 0
  
  # Health check configuration
  health_check:
    initial_delay: 60
    period: 30
    timeout: 10
    failure_threshold: 3
    success_threshold: 1

# Traffic Management
traffic_management:
  # Traffic switching method
  switching_method: "service_selector"
  
  # Service configuration for traffic routing
  services:
    api:
      blue_selector:
        app: "api"
        version: "blue"
      green_selector:
        app: "api"
        version: "green"
      port: 3000
    
    backend:
      blue_selector:
        app: "backend"
        version: "blue"
      green_selector:
        app: "backend"
        version: "green"
      port: 3001
    
    frontend:
      blue_selector:
        app: "frontend"
        version: "blue"
      green_selector:
        app: "frontend"
        version: "green"
      port: 80
  
  # Load balancer configuration
  load_balancer:
    type: "nginx"
    upstream_config      upstream api: |
_backend {
          least_conn;
          server api-blue.production.svc.cluster.local:3000 weight=1 max_fails=3 fail_timeout=30s;
          server api-green.production.svc.cluster.local:3000 weight=1 max_fails=3 fail_timeout=30s;
      }
      
      upstream frontend_backend {
          least_conn;
          server frontend-blue.production.svc.cluster.local:80 weight=1 max_fails=3 fail_timeout=30s;
          server frontend-green.production.svc.cluster.local:80 weight=1 max_fails=3 fail_timeout=30s;
      }

# Rollback Configuration
rollback:
  # Automatic rollback triggers
  triggers:
    error_rate_threshold: 0.01  # 1%
    latency_threshold: 2000     # 2 seconds
    health_check_failures: 3
    availability_threshold: 0.99  # 99%
  
  # Rollback timing
  timing:
    monitoring_period: 300      # 5 minutes
    rollback_delay: 30          # 30 seconds
    verification_time: 120      # 2 minutes
  
  # Rollback procedure
  procedure:
    1. "Stop new traffic to green environment"
    2. "Switch all traffic back to blue environment"
    3. "Verify blue environment health"
    4. "Keep green environment for investigation"
    5. "Send rollback notifications"

# Pre-deployment Validation
pre_deployment:
  # Validation checks before deployment
  checks:
    - "Verify blue environment is healthy"
    - "Check resource availability"
    - "Validate image signatures"
    - "Confirm backup status"
    - "Test deployment scripts"
  
  # Backup creation
  backup:
    enabled: true
    type: "snapshot"
    scope: "full_environment"
    retention: "24h"
  
  # Resource pre-allocation
  resource_allocation:
    cpu_reservation: "2000m"
    memory_reservation: "2Gi"
    storage_reservation: "10Gi"

# Post-deployment Process
post_deployment:
  # Validation period
  validation_period: 600  # 10 minutes
  
  # Health verification steps
  verification:
    - "Verify all services respond to health checks"
    - "Test critical user paths"
    - "Monitor error rates and latency"
    - "Check database connectivity"
    - "Validate external integrations"
  
  # Monitoring configuration
  monitoring:
    metrics:
      - "request_rate"
      - "error_rate"
      - "latency_p95"
      - "cpu_utilization"
      - "memory_utilization"
    
    alerts:
      - "high_error_rate"
      - "high_latency"
      - "service_unavailable"
      - "resource_exhaustion"
  
  # Cleanup procedures
  cleanup:
    enabled: true
    delay: 3600  # 1 hour
    procedure:
      1. "Archive deployment logs"
      2. "Clean up temporary resources"
      3. "Remove old environment if successful"
      4. "Update deployment documentation"

# Environment-specific Configurations
environment_overrides:
  development:
    replicas: 1
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    validation_period: 300
  
  staging:
    replicas: 2
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"
    validation_period: 600
  
  production:
    replicas: 3
    resources:
      requests:
        cpu: "500m"
        memory: "512Mi"
      limits:
        cpu: "2000m"
        memory: "2Gi"
    validation_period: 900

# Security Considerations
security:
  # Network policies
  network_policies:
    enabled: true
    rules:
      - "restrict_traffic_between_environments"
      - "allow_only_health_check_traffic"
      - "require_mutual_tls"
  
  # Secrets management
  secrets:
    rotation: "before_deployment"
    encryption: "aes256"
    access_control: "rbac"
  
  # Audit logging
  audit:
    enabled: true
    events:
      - "deployment_start"
      - "traffic_switch"
      - "rollback_trigger"
      - "deployment_complete"

# Performance Considerations
performance:
  # Deployment impact minimization
  impact_minimization:
    connection_draining: true
    draining_timeout: 30s
    grace_period: 10s
  
  # Resource optimization
  resource_optimization:
    pre_warming: true
    cache_warming: true
    database_connection_pooling: true
  
  # Traffic optimization
  traffic_optimization:
    load_balancing_algorithm: "least_conn"
    session_affinity: "cookie"
    compression: "gzip"

# Automation Configuration
automation:
  # Deployment automation
  deployment:
    automated: true
    approval_required: true
    approval_timeout: 1800  # 30 minutes
  
  # Rollback automation
  rollback:
    automated: true
    conditions:
      - "health_check_failure"
      - "high_error_rate"
      - "performance_degradation"
  
  # Notification automation
  notifications:
    channels:
      - "slack"
      - "email"
      - "pagerduty"
    events:
      - "deployment_started"
      - "deployment_completed"
      - "rollback_initiated"
      - "rollback_completed"

# Cost Management
cost_management:
  # Resource optimization
  optimization:
    right_sizing: true
    spot_instances: false  # Disabled for blue-green
    reserved_instances: true
  
  # Monitoring
  cost_monitoring:
    enabled: true
    alerts:
      - "cost_threshold_exceeded"
      - "resource_waste_detected"

# Compliance and Governance
compliance:
  # Change management
  change_management:
    approval_required: true
    change_window: "maintenance_window"
    documentation_required: true
  
  # Audit requirements
  audit_requirements:
    deployment_logs: "7y"
    approval_records: "7y"
    performance_metrics: "1y"

# Disaster Recovery
disaster_recovery:
  # Backup strategy
  backup_strategy:
    environment_snapshot: true
    database_backup: true
    configuration_backup: true
  
  # Recovery procedures
  recovery_procedures:
    environment_recovery: true
    data_recovery: true
    configuration_recovery: true

# Monitoring and Observability
observability:
  # Metrics collection
  metrics:
    collection_interval: "15s"
    retention_period: "30d"
    aggregation: "prometheus"
  
  # Logging
  logging:
    level: "info"
    format: "json"
    retention: "90d"
    aggregation: "elasticsearch"
  
  # Tracing
  tracing:
    enabled: true
    sampling_rate: 0.1
    backend: "jaeger"

# Documentation
documentation:
  runbook: "blue-green-deployment.md"
  troubleshooting_guide: "blue-green-troubleshooting.md"
  rollback_procedures: "blue-green-rollback.md"