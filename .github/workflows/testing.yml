name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript type check
        run: pnpm type-check

      - name: Run ESLint
        run: pnpm lint

      - name: Check formatting
        run: pnpm format:check

  # ========================================
  # UNIT TESTS
  # ========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API unit tests
        run: pnpm test --filter=@insurance-lead-gen/api
        env:
          NODE_ENV: test

      - name: Run Data Service unit tests
        run: pnpm test --filter=@insurance-lead-gen/data-service
        env:
          NODE_ENV: test

      - name: Run Orchestrator unit tests
        run: pnpm test --filter=@insurance-lead-gen/orchestrator
        env:
          NODE_ENV: test

      - name: Run Frontend unit tests
        run: pnpm test --filter=insurance-leads-platform-frontend
        env:
          NODE_ENV: test

      - name: Upload API coverage
        uses: codecov/codecov-action@v4
        with:
          directory: ./apps/api/coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: api

      - name: Upload Data Service coverage
        uses: codecov/codecov-action@v4
        with:
          directory: ./apps/data-service/coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: data-service

      - name: Upload Frontend coverage
        uses: codecov/codecov-action@v4
        with:
          directory: ./apps/frontend/coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: frontend

      - name: Check coverage thresholds
        run: |
          echo "Checking coverage thresholds..."
          # Add logic to check coverage against thresholds

  # ========================================
  # INTEGRATION TESTS
  # ========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:2.9-alpine
        ports:
          - 4222:4222
        options: >-
          --health-cmd "nats -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup test database
        run: |
          pnpm db:generate
          pnpm db:push
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/testdb

      - name: Run integration tests
        run: pnpm test:integration
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379
          NATS_URL: nats://localhost:4222
          NODE_ENV: test

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: test-results/
          retention-days: 7

  # ========================================
  # BUILD
  # ========================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/api/dist
            apps/data-service/dist
            apps/orchestrator/dist
            apps/frontend/.next
          retention-days: 7

  # ========================================
  # E2E TESTS
  # ========================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Install Playwright browsers
        run: pnpm test:e2e:install

      - name: Build frontend for E2E
        run: pnpm build
        env:
          NODE_ENV: test

      - name: Start application
        run: |
          docker-compose up -d
          sleep 30

      - name: Run E2E tests on Chrome
        run: pnpm test:e2e --project=chromium
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          NODE_ENV: test

      - name: Run E2E tests on Firefox
        run: pnpm test:e2e --project=firefox
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          NODE_ENV: test

      - name: Run E2E tests on Webkit
        run: pnpm test:e2e --project=webkit
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000
          NODE_ENV: test

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            apps/frontend/playwright-report
            apps/frontend/test-results
          retention-days: 14

      - name: Upload E2E screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-failure-screenshots
          path: apps/frontend/test-results/screenshots
          retention-days: 7

      - name: Cleanup
        run: docker-compose down

  # ========================================
  # PERFORMANCE TESTS
  # ========================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Start application
        run: |
          docker-compose up -d
          sleep 30

      - name: Run baseline load test
        run: k6 run -e SCENARIO=baseline testing/performance/load-test.js
        env:
          BASE_URL: http://localhost:3000
          K6_OUT: json=k6-results-baseline.json

      - name: Run peak load test
        run: k6 run -e SCENARIO=peak_load testing/performance/load-test.js
        env:
          BASE_URL: http://localhost:3000
          K6_OUT: json=k6-results-peak.json

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            k6-results-baseline.json
            k6-results-peak.json
          retention-days: 30

      - name: Cleanup
        run: docker-compose down

  # ========================================
  # SECURITY TESTS
  # ========================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --production --audit-level=high

      - name: Run dependency check
        run: |
          npm install -g @aspect-build/rules_ts
          pnpm run security:dependencies

      - name: Run SAST with eslint security plugins
        run: pnpm lint -- --ext .ts --rule 'no-console: error'

      - name: Start application for DAST
        run: |
          docker-compose up -d
          sleep 30

      - name: Run OWASP ZAP Scan
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            zap_report.html
            zap_report.json
          retention-days: 30

      - name: Cleanup
        run: docker-compose down

  # ========================================
  # ACCESSIBILITY TESTS
  # ========================================
  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm build

      - name: Start application
        run: |
          docker-compose up -d
          sleep 30

      - name: Install Playwright
        run: pnpm test:e2e:install

      - name: Run accessibility tests
        run: pnpm test:accessibility
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: apps/frontend/accessibility-report
          retention-days: 30

      - name: Cleanup
        run: docker-compose down

  # ========================================
  # FINAL STATUS
  # ========================================
  final-status:
    name: Final Status
    runs-on: ubuntu-latest
    needs:
      - lint
      - unit-tests
      - integration-tests
      - build
      - e2e-tests
      - performance-tests
      - security-tests
      - accessibility-tests

    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "CI Pipeline completed"
          echo "Check the workflow logs for details"
