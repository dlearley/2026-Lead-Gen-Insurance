name: Dependency Scanning

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  npm-audit:
    name: npm Audit - Node.js Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        package:
          - apps/api
          - apps/backend
          - apps/data-service
          - apps/orchestrator
          - apps/frontend
          - apps/frontend-vite
          - packages/core
          - packages/types
          - packages/config
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Run npm audit
        working-directory: ${{ matrix.package }}
        run: |
          pnpm install --frozen-lockfile
          pnpm audit --audit-level=moderate --json > npm-audit.json || true
          pnpm audit --audit-level=critical

      - name: Upload npm audit results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ matrix.package }}/npm-audit.json
          category: npm-audit-${{ matrix.package }}

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-${{ matrix.package }}
          path: ${{ matrix.package }}/npm-audit.json

  pip-audit:
    name: pip Audit - Python Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --desc --format json --output pip-audit.json || true
          pip-audit --desc --strict || true

      - name: Convert to SARIF
        run: |
          pip install safety
          safety check --json > safety-report.json || true

      - name: Upload pip-audit results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: pip-audit.json
          category: pip-audit

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-results
          path: |
            pip-audit.json
            safety-report.json

  snyk-scan:
    name: Snyk Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json --sarif-file-output=snyk-sarif.json

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-sarif.json
          category: snyk-node

      - name: Upload Snyk artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-results
          path: snyk-sarif.json

  lock-file-validation:
    name: Lock File Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Validate lock files
        run: |
          # Check if pnpm-lock.yaml exists and is valid
          if [ ! -f "pnpm-lock.yaml" ]; then
            echo "Error: pnpm-lock.yaml not found"
            exit 1
          fi

          # Verify lock file integrity
          pnpm install --frozen-lockfile --prefer-offline

          # Check for duplicate dependencies
          pnpm ls --depth=0

      - name: Check for lock file poisoning
        run: |
          # Verify no unexpected URLs in lock file
          if grep -q 'http://\|git://' pnpm-lock.yaml; then
            echo "Warning: Found insecure protocol in lock file"
            exit 1
          fi

          echo "Lock file validation passed"

  dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.10/dependency-check-9.0.10-release.zip
          unzip dependency-check-9.0.10-release.zip

      - name: Run Dependency-Check
        run: |
          ./dependency-check/bin/dependency-check.sh \
            --scan packages \
            --scan apps \
            --format JSON \
            --format SARIF \
            --out dependency-check-results \
            --failOnCVSS 7 \
            --enableExperimental || true

      - name: Upload Dependency-Check results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: dependency-check-results/dependency-check-report.sarif
          category: dependency-check

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-results
          path: dependency-check-results

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install license checker
        run: |
          pnpm add -D license-checker
          npm install -g license-checker

      - name: Check licenses
        run: |
          license-checker --production --json --out license-report.json || true
          license-checker --production --failOn "GPL;AGPL"

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: license-report.json

  dependency-scan-summary:
    name: Dependency Scan Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, pip-audit, snyk-scan, lock-file-validation, dependency-check, license-check]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Dependency Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| npm Audit | ${{ needs.npm-audit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| pip Audit | ${{ needs.pip-audit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Scan | ${{ needs.snyk-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lock File Validation | ${{ needs.lock-file-validation.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency-Check | ${{ needs.dependency-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
