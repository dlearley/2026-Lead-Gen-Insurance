name: DAST - Dynamic Application Security Testing

on:
  schedule:
    # Run nightly at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (staging/production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  security-events: write

jobs:
  zap-scan:
    name: OWASP ZAP Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get application URL
        id: url
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "url=https://api.production.example.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://api.staging.example.com" >> $GITHUB_OUTPUT
          fi

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ steps.url.outputs.url }}
          rules_file_name: .github/zap/rules.tsv
          cmd_options: '-a -j'
          format: sarif
          output_name: zap-results.sarif

      - name: Upload ZAP results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: zap-results.sarif
          category: zap-scan

      - name: Upload ZAP artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-results
          path: zap-results.sarif

  api-security-test:
    name: API Security Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install security testing tools
        run: |
          npm install -g @42nest/nuclei
          npm install -g sslyze
          npm install -g whatweb

      - name: Run Nuclei security templates
        run: |
          nuclei -u https://api.staging.example.com \
            -t /home/runner/.nuclei-templates/cves/ \
            -t /home/runner/.nuclei-templates/exposed-panels/ \
            -t /home/runner/.nuclei-templates/misconfiguration/ \
            -o nuclei-results.json \
            -json || true

      - name: Upload Nuclei results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nuclei-results
          path: nuclei-results.json

      - name: Test SSL/TLS configuration
        run: |
          sslyze api.staging.example.com --json > ssl-results.json || true

      - name: Upload SSL results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ssl-results
          path: ssl-results.json

  authentication-bypass-test:
    name: Authentication Bypass Testing
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install sqlmap
          pip install xsser

      - name: Run SQL injection tests
        run: |
          # Test SQL injection vulnerabilities
          echo "Testing for SQL injection..."
          # sqlmap -u "https://api.staging.example.com/leads?id=1" --batch --json > sqlmap-results.json || true

      - name: Run XSS tests
        run: |
          # Test XSS vulnerabilities
          echo "Testing for XSS..."
          # xsser -u "https://api.staging.example.com/search?q=test" --auto > xsser-results.txt || true

      - name: Upload auth bypass test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: auth-bypass-results
          path: |
            sqlmap-results.json
            xsser-results.txt

  csrf-test:
    name: CSRF Protection Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CSRF testing tools
        run: |
          pip install requests
          pip install beautifulsoup4

      - name: Test CSRF protection
        run: |
          cat > test_csrf.py << 'EOF'
          import requests
          import json

          # Test that CSRF tokens are required
          url = "https://api.staging.example.com/api/leads"
          
          # Test without CSRF token
          response_no_token = requests.post(url, json={})
          
          # Test with invalid CSRF token
          response_invalid_token = requests.post(
            url,
            json={},
            headers={"X-CSRF-Token": "invalid"}
          )
          
          results = {
            "no_token_status": response_no_token.status_code,
            "invalid_token_status": response_invalid_token.status_code
          }
          
          with open("csrf-results.json", "w") as f:
            json.dump(results, f, indent=2)
          
          print("CSRF testing completed")
          EOF
          python test_csrf.py

      - name: Upload CSRF test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: csrf-test-results
          path: csrf-results.json

  rate-limiting-test:
    name: Rate Limiting Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test rate limiting
        run: |
          cat > test_rate_limit.js << 'EOF'
          const https = require('https');
          const url = 'https://api.staging.example.com/api/leads';
          
          const requestCount = 100;
          const results = [];
          
          for (let i = 0; i < requestCount; i++) {
            https.get(url, (res) => {
              results.push({
                request: i + 1,
                statusCode: res.statusCode,
                rateLimit: res.headers['x-ratelimit-remaining']
              });
              
              if (results.length === requestCount) {
                console.log(JSON.stringify(results, null, 2));
              }
            }).on('error', (err) => {
              console.error(err);
            });
          }
          EOF
          node test_rate_limit.js > rate-limit-results.json || true

      - name: Upload rate limit test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rate-limit-results
          path: rate-limit-results.json

  header-security-test:
    name: Security Header Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test security headers
        run: |
          curl -I https://api.staging.example.com > headers.txt 2>&1
          cat headers.txt

          # Check for required security headers
          required_headers=(
            "X-Content-Type-Options"
            "X-Frame-Options"
            "Content-Security-Policy"
            "Strict-Transport-Security"
            "X-XSS-Protection"
          )

          echo "Checking security headers..."
          for header in "${required_headers[@]}"; do
            if grep -qi "$header" headers.txt; then
              echo "✅ $header present"
            else
              echo "❌ $header missing"
            fi
          done > header-check.txt

      - name: Upload header check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: header-security-results
          path: |
            headers.txt
            header-check.txt

  dast-summary:
    name: DAST Summary Report
    runs-on: ubuntu-latest
    needs: [zap-scan, api-security-test, authentication-bypass-test, csrf-test, rate-limiting-test, header-security-test]
    if: always()
    steps:
      - name: Generate DAST Summary
        run: |
          echo "# Dynamic Application Security Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP ZAP Scan | ${{ needs.zap-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Security Testing | ${{ needs.api-security-test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication Bypass | ${{ needs.authentication-bypass-test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CSRF Protection | ${{ needs.csrf-test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rate Limiting | ${{ needs.rate-limiting-test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Headers | ${{ needs.header-security-test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Time:** $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate combined report
        run: |
          mkdir -p dast-report
          cp -r all-results/* dast-report/
          echo "DAST Scan Report - $(date)" > dast-report/README.md
          echo "=========================" >> dast-report/README.md

      - name: Upload combined DAST report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-combined-report
          path: dast-report
