// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// AI-POWERED ROUTING & OPTIMIZATION (Phase 20)
// ========================================

model BrokerPerformanceMetrics {
  id                    String   @id @default(uuid())
  brokerId              String   @unique
  conversionRate        Float    @default(0)
  avgLeadValue          Float    @default(0)
  avgProcessingTime     Int      @default(0) // in minutes
  slaComplianceRate     Float    @default(0)
  totalLeadsAssigned    Int      @default(0)
  totalLeadsConverted   Int      @default(0)
  revenueGenerated      Float    @default(0)
  customerSatisfaction  Float    @default(0)
  responseTimeAvg       Int      @default(0) // in minutes
  lastPerformanceUpdate DateTime @default(now())
  metrics               Json?    // Extended metrics
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([brokerId])
  @@index([conversionRate])
  @@index([slaComplianceRate])
  @@map("broker_performance_metrics")
}

model RoutingProfile {
  id               String   @id @default(uuid())
  leadId           String   @unique
  brokerAssignedId String
  routingScore     Float
  reasoning        Json?    // Detailed reasoning for the routing decision
  routingFactors   Json?    // Factor weights used in decision
  performanceData  Json?    // Expected performance outcomes
  createdAt        DateTime @default(now())

  @@index([leadId])
  @@index([brokerAssignedId])
  @@index([routingScore])
  @@map("routing_profiles")
}

model RoutingDecision {
  id                   String   @id @default(uuid())
  leadId               String
  brokerId             String
  score                Float
  reason               String
  routingMethod        String   // 'ml_prediction', 'specialty_match', 'capacity_based', etc.
  confidence           Float    @default(0)
  alternativeBrokers   Json?    // List of alternative brokers considered
  performanceOutcome   Json?    // Actual performance metrics after assignment
  optimizationApplied  Boolean  @default(false)
  experimentId         String?
  timestamp            DateTime @default(now())

  @@index([leadId])
  @@index([brokerId])
  @@index([routingMethod])
  @@index([timestamp])
  @@index([experimentId])
  @@map("routing_decisions")
}

model RoutingExperiment {
  id                    String               @id @default(uuid())
  name                  String
  description           String?
  status                ExperimentStatus     @default(ACTIVE)
  
  // Experiment configuration
  controlGroup          Json                 // Control routing strategy
  treatmentGroup        Json                 // Treatment routing strategy
  segmentRules          Json?                // Lead segmentation rules
  trafficAllocation     Float                @default(0.5) // 50% control, 50% treatment
  
  // Results and analytics
  controlMetrics        Json?                // Control group performance
  treatmentMetrics      Json?                // Treatment group performance
  statisticalSignificance Float?
  confidenceLevel       Float                @default(0.95)
  power                 Float                @default(0.8)
  
  // Winner determination
  winner                String?              // 'control', 'treatment', or 'inconclusive'
  winnerReason          String?
  improvement           Float?               // % improvement of winner
  rolloutStrategy       String?
  
  // Metadata
  startDate             DateTime             @default(now())
  endDate               DateTime?
  targetSampleSize      Int?
  currentSampleSize     Int                  @default(0)
  metadata              Json?
  
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("routing_experiments")
}

model BrokerCapacity {
  id                    String   @id @default(uuid())
  brokerId              String   @unique
  currentLoadPercentage Float    @default(0)
  activeLeadCount       Int      @default(0)
  maxCapacity           Int      @default(10)
  avgProcessingTime     Int      @default(0) // in minutes
  slaComplianceRate     Float    @default(0)
  lastUpdated           DateTime @default(now())
  capacityTrend         Json?    // Historical capacity trends
  predictedCapacity     Json?    // ML-based capacity predictions
  overloadThreshold     Float    @default(0.85) // % of max capacity considered overloaded
  underloadThreshold    Float    @default(0.5)  // % of max capacity considered underutilized
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([brokerId])
  @@index([currentLoadPercentage])
  @@map("broker_capacity")
}

model RoutingOptimization {
  id            String   @id @default(uuid())
  brokerId      String
  specialties   String[] // Broker specialties for vector matching
  expertise     Json?    // Detailed expertise breakdown
  weights       Json?    // Performance weights for different factors
  
  // Optimization settings
  roiWeights    Json?    // Weights for ROI optimization
  fairnessRules Json?    // Broker fairness constraints
  exclusions    String[] // Lead types to avoid assigning to this broker
  preferences   Json?    // Broker routing preferences
  
  // Machine learning model parameters
  modelVersion  String?
  embeddingVector Json? // Vector representation of broker profile
  performanceModel Json? // Trained model parameters
  
  metadata      Json?
  updatedAt     DateTime @updatedAt

  @@index([brokerId])
  @@map("routing_optimization")
}

model LeadEmbedding {
  id          String   @id @default(uuid())
  leadId      String   @unique
  vector      Json     // Lead vector representation
  embeddingModel String // Model used for embedding
  features    Json?    // Extracted features
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([leadId])
  @@map("lead_embeddings")
}

model SpecialtyMatching {
  id                String   @id @default(uuid())
  leadId            String
  brokerId          String
  specialtyMatch    Float    // Similarity score between lead and broker specialties
  semanticMatch     Float    // Vector similarity score
  weightedScore     Float    // Final weighted matching score
  matchingFactors   Json?    // Breakdown of matching factors
  createdAt         DateTime @default(now())

  @@index([leadId])
  @@index([brokerId])
  @@index([weightedScore])
  @@map("specialty_matching")
}

enum ExperimentStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ROLLED_BACK
  CANCELLED
}