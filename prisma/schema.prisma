// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  
  // New relations for Phase 16.3.8
  experimentAssignments ExperimentAssignment[]
  campaignLeads        CampaignLead[]
  state                LeadState?
  attributionLogs      AttributionLog[]
  orchestrationEvents  OrchestrationEvent[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Document Management Models

// Document Registry model
model Document {
  id                String      @id @default(cuid())
  documentId        String      @unique // External identifier for audit
  leadId            String?     // Associated lead
  agentId           String?     // Associated agent
  documentType      String      // "Quote", "Policy", "Claim", "ID", "ProofOfAddress", "IncomeVerification", "ConsentForm", "Disclosure", "Other"
  category          String      // "Financial", "Identity", "Medical", "Legal", "Regulatory", "Operational"
  filename          String      // Original filename
  fileSize          Int         // Size in bytes
  mimeType          String      // Content type
  storageLocation   String      // Path in S3/MinIO
  storageProvider   String      // "S3", "MinIO", "LocalStorage"
  encryptionKey     String?     // Reference to encryption key
  checksum          String      // SHA-256 hash for integrity
  description       String?     // Human description
  tags              String[]    // Array of tags for organization
  jurisdiction      String?     // Relevant jurisdiction/state
  status            String      @default("Active") // "Active", "Archived", "Deleted", "PendingDeletion"
  
  // Lifecycle Management
  uploadedDate      DateTime    @default(now())
  uploadedBy        String      // User/system that uploaded
  lastAccessedDate  DateTime?
  archivedDate      DateTime?
  deletionScheduledDate DateTime?
  deletionDate      DateTime?
  
  // Retention
  retentionCategory String      // Reference to retention policy
  retentionPeriodDays Int?      // Override global retention if set
  expiryDate        DateTime?   // Auto-calculated from retention policy
  legalHoldApplied  Boolean     @default(false)
  legalHoldReason   String?
  
  // Metadata
  version           Int         @default(1) // Document version
  parentDocumentId  String?     // For versioned documents
  relatedDocuments  String[]    // Array of related document IDs
  
  // Classification
  sensitivity       String      // "Public", "Internal", "Confidential", "Secret"
  piiDetected       Boolean     @default(false) // PII detected by scanning
  piiFields        String[]    // Array of detected PII fields
  requiresRedaction Boolean     @default(false)
  redacted          Boolean     @default(false)
  
  // Compliance
  complianceRelevant Boolean    @default(false) // Subject to specific regulation
  regulations       String[]    // Array of applicable regulations
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  versions          DocumentVersion[]
  accessLogs        DocumentAccessLog[]
  shares            DocumentShare[]
  integrityChecks   DocumentIntegrityCheck[]
  retentionPolicy   DocumentRetentionPolicy? @relation(fields: [retentionCategory], references: [policyName])
  deletionRequests  DocumentDeletionRequest[]
  expirationEvents  DocumentExpirationEvent[]

  @@index([leadId])
  @@index([agentId])
  @@index([documentType])
  @@index([status])
  @@index([expiryDate])
  @@index([legalHoldApplied])
  @@index([retentionCategory])
}

// Document Access Audit Trail
model DocumentAccessLog {
  id                String      @id @default(cuid())
  documentId        String
  userId            String
  action            String      // "View", "Download", "Print", "Share", "Delete", "Restore"
  ipAddress         String?
  userAgent         String?
  accessReason      String?     // Why they accessed
  timestamp         DateTime    @default(now())
  success           Boolean     @default(true)
  failureReason     String?     // If access denied

  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([timestamp])
}

// Document Versions
model DocumentVersion {
  id                String      @id @default(cuid())
  documentId        String
  versionNumber     Int
  storageLocation   String      // Where this version is stored
  checksum          String      // SHA-256 of this version
  uploadedDate      DateTime    @default(now())
  uploadedBy        String
  changeDescription String?
  changes           String?     // JSON of what changed
  fileSize          Int

  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber])
  @@index([documentId])
}

// Document Classification Rules
model DocumentClassificationRule {
  id                String      @id @default(cuid())
  name              String      @unique
  description       String?
  pattern           String      // Regex pattern to match filenames
  documentType      String?     // Associated document type
  category          String      // Document category
  sensitivity       String      // "P", "I", "C", "S" for Public, Internal, Confidential, Secret
  requiresRedaction Boolean     @default(false)
  retentionCategory String?     // Reference to retention policy
  jurisdiction      String[]    // Applicable jurisdictions
  status            String      @default("Active")
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  retentionPolicy   DocumentRetentionPolicy? @relation(fields: [retentionCategory], references: [policyName])

  @@index([status])
  @@index([category])
}

// PII (Personally Identifiable Information) Detection Rules
model PIIDetectionRule {
  id                String      @id @default(cuid())
  fieldName         String      @unique // e.g., "SSN", "CreditCard", "BankAccount", "DriversLicense"
  pattern           String      // Regex pattern to detect
  dataType          String      // "Number", "Email", "Phone", "Address", "Name"
  severity          String      // "Critical", "High", "Medium"
  redactionMethod   String      // "Mask", "Hash", "Remove", "Encrypt"
  redactionFormat   String?     // e.g., "XXX-XX-1234" for SSN
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Document Retention Policies (Enhanced)
model DocumentRetentionPolicy {
  id                String      @id @default(cuid())
  policyName        String      @unique
  documentTypes     String[]    // Document types covered
  retentionDays     Int         // Days to retain
  archiveDays       Int?        // Days before archiving
  jurisdiction      String      // State code or "Federal"
  reason            String      // Why retention required
  regulations       String[]    // Applicable regulations
  legalHolds        String[]    // Legal hold reasons
  deletionMethod    String      // "SecureDelete", "Shred", "Anonymize"
  notificationDays  Int         // Days before expiry to notify
  status            String      @default("Active")
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  documents         Document[]
  classificationRules DocumentClassificationRule[]

  @@index([status])
}

// Encryption Keys Management
model EncryptionKey {
  id                String      @id @default(cuid())
  keyId             String      @unique
  keyType           String      // "AES256", "RSA2048", "RSA4096"
  algorithm         String      // "AES-GCM", "RSA-OAEP"
  creationDate      DateTime    @default(now())
  expiryDate        DateTime?
  status            String      @default("Active") // "Active", "Rotated", "Disabled"
  rotationDate      DateTime?
  lastUsedDate      DateTime?
  keySource         String      // "AWS-KMS", "HashiCorp-Vault", "Local"
  metadata          String?     // JSON with additional key info
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Document Sharing/Access Control
model DocumentShare {
  id                String      @id @default(cuid())
  documentId        String
  grantedToUserId   String
  grantedBy         String      // Who gave access
  permission        String      // "View", "Download", "Edit", "Share"
  shareType         String      // "Direct", "Role", "Team", "Public"
  expiryDate        DateTime?   // Access expires
  requiresPassword  Boolean     @default(false)
  password          String?     // Hashed password
  accessCount       Int         @default(0) // Number of times accessed
  status            String      @default("Active")
  
  grantedDate       DateTime    @default(now())
  revokedDate       DateTime?
  revokedReason     String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, grantedToUserId])
  @@index([documentId])
  @@index([grantedToUserId])
}

// Document Search Index (for fast search)
model DocumentIndex {
  id                String      @id @default(cuid())
  documentId        String      @unique
  content           String      // Full text for search
  extractedText     String?     // OCR'd text
  keywords          String[]    // Extracted keywords
  entities          String[]    // Named entities
  lastIndexedDate   DateTime    @default(now())
  
  createdAt         DateTime    @default(now())
  
  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@fulltext([content])
}

// Document Deletion Request & Audit
model DocumentDeletionRequest {
  id                String      @id @default(cuid())
  documentId        String
  documentType      String
  requestedBy       String
  requestReason     String
  status            String      @default("Pending") // "Pending", "Approved", "InProgress", "Completed", "Failed"
  requestDate       DateTime    @default(now())
  approvedDate      DateTime?
  approvedBy        String?
  executionDate     DateTime?
  completionDetails String?     // JSON with deletion proof
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([status])
  @@index([requestDate])
}

// Document Archival
model ArchivedDocument {
  id                String      @id @default(cuid())
  documentId        String      // Reference to original
  originalStorageLocation String
  archiveLocation   String      // Where archived
  archiveFormat     String      // "TAR.GZ", "ZIP", "BAG"
  archiveDate       DateTime    @default(now())
  archivedBy        String
  checksum          String      // Integrity check
  retrievalInstructions String? // How to retrieve
  expiryDate        DateTime?   // When archive can be deleted
  
  createdAt         DateTime    @default(now())

  // Relations
  document          Document?   @relation(fields: [documentId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([archiveDate])
  @@index([expiryDate])
}

// Legal Hold / Litigation Hold
model LitigationHold {
  id                String      @id @default(cuid())
  holdId            String      @unique
  caseNumber        String?     // Related case/matter number
  description       String
  reason            String      // Why hold was placed
  appliedDate       DateTime    @default(now())
  appliedBy         String
  targetDocuments   String[]    // Array of document types or IDs
  jurisdiction      String?     // Jurisdiction of hold
  status            String      @default("Active") // "Active", "Lifted", "Expired"
  liftedDate        DateTime?
  liftedBy          String?
  liftReason        String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([holdId])
  @@index([status])
  @@index([appliedDate])
}

// Document Integrity Verification
model DocumentIntegrityCheck {
  id                String      @id @default(cuid())
  documentId        String
  checkDate         DateTime    @default(now())
  storedChecksum    String      // Original checksum
  currentChecksum   String      // Current computed checksum
  isIntact          Boolean     // Checksums match
  encryptionValid   Boolean     // Encryption still valid
  accessible        Boolean     // Can still be retrieved
  issues            String[]    // Any issues found
  
  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([checkDate])
}

// Document Expiration Events
model DocumentExpirationEvent {
  id                String      @id @default(cuid())
  documentId        String
  eventType         String      // "WillExpireIn30Days", "WillExpireIn7Days", "Expired", "DeletedAfterExpiration"
  scheduledDate     DateTime
  executedDate      DateTime?
  status            String      @default("Scheduled") // "Scheduled", "Executed", "Cancelled"
  notificationSent  Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  
  // Relations
  document          Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([scheduledDate])
  @@index([status])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// Performance Goal model - tracks broker performance goals
model PerformanceGoal {
  id            String            @id @default(uuid())
  brokerId      String
  category      PerformanceGoalCategory
  targetValue   Float
  currentValue  Float             @default(0)
  progress      Float             @default(0)
  deadline      DateTime
  status        PerformanceGoalStatus @default(ON_TRACK)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([brokerId])
  @@index([category])
  @@index([status])
}

enum PerformanceGoalCategory {
  CONVERSION
  RESPONSE_TIME
  REVENUE
  RETENTION
  CUSTOMER_SATISFACTION
}

enum PerformanceGoalStatus {
  ON_TRACK
  AT_RISK
  BEHIND
  ACHIEVED
}

// Broker Network model - tracks broker network relationships
model BrokerNetwork {
  id                String   @id @default(uuid())
  brokerId          String   @unique
  networkTier       NetworkTier @default(BRONZE)
  totalConnections  Int      @default(0)
  activeConnections Int      @default(0)
  networkValue      Float    @default(0.0)
  networkScore      Float    @default(0.0)
  referralMultiplier Float   @default(1.0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

enum NetworkTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// Broker Connection model - tracks connections between brokers
model BrokerConnection {
  id                 String    @id @default(uuid())
  brokerId           String
  connectedBrokerId  String
  relationshipType   BrokerRelationshipType @default(DIRECT_REFERRAL)
  strength           Float     @default(0.5)
  isActive           Boolean   @default(true)
  referralCount      Int       @default(0)
  revenueGenerated   Float     @default(0.0)
  lastReferralAt     DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@unique([brokerId, connectedBrokerId])
  @@index([brokerId])
  @@index([connectedBrokerId])
  @@index([isActive])
}

enum BrokerRelationshipType {
  DIRECT_REFERRAL
  CROSS_REFERRAL
  MENTORSHIP
  PARTNERSHIP
  TEAM_MEMBER
  TEAM_LEADER
  NETWORK_MEMBER
}

// Broker Referral model - tracks referrals between brokers
model BrokerReferral {
  id                  String    @id @default(uuid())
  leadId              String
  referringBrokerId   String
  receivingBrokerId   String
  status              BrokerReferralStatus @default(PENDING)
  commissionRate      Float     @default(0.15)
  commissionAmount    Float?
  referralReason      String?
  notes               String?
  expiresAt           DateTime?
  convertedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([referringBrokerId])
  @@index([receivingBrokerId])
  @@index([status])
}

enum BrokerReferralStatus {
  PENDING
  ACCEPTED
  CONVERTED
  DECLINED
  EXPIRED
}

// Network Effect model - tracks network effects on broker performance
model NetworkEffect {
  id               String    @id @default(uuid())
  sourceBrokerId   String
  affectedBrokerId String
  effectType       NetworkEffectType
  value            Float
  description      String
  timestamp        DateTime  @default(now())
  metadata         Json?

  @@index([sourceBrokerId])
  @@index([affectedBrokerId])
  @@index([effectType])
}

enum NetworkEffectType {
  REFERRAL_BOOST
  KNOWLEDGE_SHARING
  RESOURCE_SHARING
  MARKET_EXPANSION
}