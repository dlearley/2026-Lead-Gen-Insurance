// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// DataConsent model - tracks user consent for data processing (GDPR/CCPA)
model DataConsent {
  id              String           @id @default(uuid())
  leadId          String?
  email           String?
  consentType     ConsentType
  consentGiven     Boolean          @default(false)
  consentText      String
  ipAddress       String?
  userAgent       String?
  version         Int              @default(1)
  withdrawnAt     DateTime?
  expiresAt       DateTime?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Indexes
  @@index([leadId])
  @@index([email])
  @@index([consentType])
  @@index([consentGiven])
  @@index([createdAt])
  @@index([withdrawnAt])
}

// DataDeletionRequest model - handles right to be forgotten requests (GDPR Article 17)
model DataDeletionRequest {
  id                String               @id @default(uuid())
  leadId            String?
  email             String?
  requestType       DeletionRequestType
  status            DeletionRequestStatus @default(PENDING)
  requestedBy       String
  requestedByEmail  String?
  ipAddress         String?
  reason            String?
  verifiedAt        DateTime?
  processedAt       DateTime?
  completedAt       DateTime?
  rejectedReason    String?
  retentionExpiry   DateTime?
  metadata          Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  // Relationships
  auditLogs         ComplianceAuditLog[]

  // Indexes
  @@index([leadId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@index([requestedBy])
}

// ComplianceAuditLog model - comprehensive audit trail for compliance
model ComplianceAuditLog {
  id                String               @id @default(uuid())
  entityType        EntityType
  entityId          String
  actionType        ActionType
  performedBy       String?
  performedByRole   String?
  ipAddress         String?
  userAgent         String?
  oldValue          Json?
  newValue          Json?
  sensitiveFields   String[]
  requestId         String?
  sessionId         String?
  deletionRequestId String?
  metadata          Json?
  createdAt         DateTime             @default(now())

  // Relationships
  deletionRequest    DataDeletionRequest? @relation(fields: [deletionRequestId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([entityType])
  @@index([entityId])
  @@index([actionType])
  @@index([performedBy])
  @@index([createdAt])
  @@index([deletionRequestId])
  @@index([requestId])
}

// ComplianceReport model - generated regulatory reports
model ComplianceReport {
  id                  String              @id @default(uuid())
  reportType          ReportType
  reportFormat        ReportFormat
  status              ReportStatus        @default(PENDING)
  title               String
  description         String?
  generatedBy         String
  periodStart         DateTime?
  periodEnd           DateTime?
  filters             Json?
  metrics             Json?
  fileUrl             String?
  fileSize            Int?
  recordCount         Int?
  encryptionKey       String?
  checksum            String?
  retentionExpiresAt  DateTime?
  publishedAt         DateTime?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Indexes
  @@index([reportType])
  @@index([status])
  @@index([generatedBy])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([createdAt])
  @@index([publishedAt])
}

// DataRetentionPolicy model - define and enforce retention policies
model DataRetentionPolicy {
  id              String                @id @default(uuid())
  entityType      EntityType
  retentionPeriod Int                   // retention period in days
  action          RetentionAction       @default(DELETE)
  condition       String?
  isActive        Boolean               @default(true)
  priority        Int                   @default(0)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  recordsProcessed Int                  @default(0)
  recordsDeleted Int                   @default(0)
  createdBy       String?
  metadata        Json?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Indexes
  @@index([entityType])
  @@index([isActive])
  @@index([nextRunAt])
  @@index([priority])
}

// ComplianceViolation model - track violations and remediation
model ComplianceViolation {
  id                  String              @id @default(uuid())
  violationType       ViolationType
  severity            ViolationSeverity
  status              ViolationStatus     @default(OPEN)
  description         String
  entityId            String?
  entityType          EntityType?
  detectedBy          String?
  detectionMethod     String?
  affectedRecords     Int?
  riskScore           Float?
  remediationAction   String?
  remediationStatus   RemediationStatus  @default(NOT_STARTED)
  remediatedAt        DateTime?
  remediatedBy        String?
  notes               String?
  reportedTo          String?
  reportDate          DateTime?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Indexes
  @@index([violationType])
  @@index([severity])
  @@index([status])
  @@index([entityType])
  @@index([detectedBy])
  @@index([createdAt])
  @@index([riskScore])
}

// DataSubjectRequest model - general data subject rights requests
model DataSubjectRequest {
  id                String                @id @default(uuid())
  leadId            String?
  email             String
  requestType       DataSubjectRequestType
  status            DataSubjectRequestStatus @default(PENDING)
  verificationData  Json?
  identityVerified  Boolean               @default(false)
  verifiedAt        DateTime?
  processedAt       DateTime?
  completedAt       DateTime?
  requestData       Json?
  responseData      Json?
  rejectionReason   String?
  ipAddress         String?
  requestedBy       String
  metadata          Json?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Indexes
  @@index([leadId])
  @@index([email])
  @@index([requestType])
  @@index([status])
  @@index([createdAt])
  @@index([identityVerified])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// Compliance Enums
enum ConsentType {
  MARKETING_COMMUNICATIONS
  DATA_PROCESSING
  DATA_SHARING
  ANALYTICS
  PERSONALIZED_ADS
  LOCATION_TRACKING
  THIRD_PARTY_SHARING
}

enum DeletionRequestType {
  RIGHT_TO_BE_FORGOTTEN
  DATA_PORTABILITY
  ACCOUNT_DELETION
  CONSENT_WITHDRAWAL
}

enum DeletionRequestStatus {
  PENDING
  VERIFIED
  PROCESSING
  COMPLETED
  REJECTED
  EXPIRED
}

enum EntityType {
  LEAD
  AGENT
  CARRIER
  ASSIGNMENT
  CONSENT
  AUDIT_LOG
  REPORT
  POLICY
  VIOLATION
  DATA_SUBJECT_REQUEST
}

enum ActionType {
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
  ACCESS
  SHARE
  ANONYMIZE
  ARCHIVE
  RESTORE
}

enum ReportType {
  DATA_PROCESSING_REGISTRY
  DATA_SUBJECT_REQUESTS
  DATA_BREACH_REPORT
  CONSENT_REGISTRY
  RETENTION_REPORT
  AUDIT_LOG_REPORT
  PRIVACY_IMPACT_ASSESSMENT
  SECURITY_INCIDENT_REPORT
}

enum ReportFormat {
  PDF
  CSV
  JSON
  XML
  HTML
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  EXPIRED
}

enum RetentionAction {
  DELETE
  ANONYMIZE
  ARCHIVE
  TRANSFER
}

enum ViolationType {
  UNAUTHORIZED_ACCESS
  DATA_BREACH
  CONSENT_VIOLATION
  RETENTION_VIOLATION
  DATA_LEAK
  SECURITY_INCIDENT
  POLICY_VIOLATION
  COMPLIANCE_BREACH
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ViolationStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ESCALATED
}

enum RemediationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
  PARTIAL
}

enum DataSubjectRequestType {
  ACCESS_REQUEST
  DELETION_REQUEST
  PORTABILITY_REQUEST
  RECTIFICATION_REQUEST
  OBJECTION_REQUEST
  RESTRICTION_REQUEST
}

enum DataSubjectRequestStatus {
  PENDING
  VERIFIED
  PROCESSING
  COMPLETED
  REJECTED
  EXPIRED
}