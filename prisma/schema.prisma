// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// BEHAVIOR TRACKING MODELS
// ========================================

// BehaviorEvent model - tracks user behavior events
model BehaviorEvent {
  id          String            @id @default(uuid())
  leadId      String?
  sessionId   String
  userId      String?
  eventType   BehaviorEventType
  category    BehaviorCategory
  timestamp   DateTime         @default(now())
  source      String
  page        Json?
  properties  Json
  context     Json?
  value       Float?
  metadata    Json?

  // Indexes
  @@index([leadId])
  @@index([sessionId])
  @@index([eventType])
  @@index([category])
  @@index([timestamp])
  @@index([source])
}

// BehavioralSegment model - stores behavioral segments
model BehavioralSegment {
  id          String        @id @default(uuid())
  name        String
  description String?
  type        SegmentType
  status      SegmentStatus @default(ACTIVE)
  criteria    Json
  leadCount   Int           @default(0)
  isPublic    Boolean       @default(false)
  tags        String[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  lastCalculated DateTime?

  // Indexes
  @@index([type])
  @@index([status])
  @@index([isPublic])
  @@index([createdAt])
}

// PersonalizationRule model - stores personalization rules
model PersonalizationRule {
  id              String                 @id @default(uuid())
  name            String
  description     String?
  type            PersonalizationType
  status          PersonalizationStatus  @default(ACTIVE)
  priority        Int                   @default(0)
  targetSegments  String[]
  conditions      Json
  actions         Json
  startDate       DateTime?
  endDate         DateTime?
  isActive        Boolean               @default(true)
  tags            String[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Indexes
  @@index([type])
  @@index([status])
  @@index([isActive])
  @@index([priority])
  @@index([createdAt])
}

// BehaviorExperiment model - stores A/B testing experiments
model BehaviorExperiment {
  id              String           @id @default(uuid())
  name            String
  description     String?
  type            ExperimentType
  status          ExperimentStatus @default(DRAFT)
  hypothesis      String
  successMetrics  String[]
  targetSegments  String[]
  trafficAllocation Json
  variants        Json
  startDate       DateTime?
  endDate         DateTime?
  metadata        Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Indexes
  @@index([type])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt])
}

// BehavioralTrigger model - stores behavior-based triggers
model BehavioralTrigger {
  id          String       @id @default(uuid())
  name        String
  description String?
  event       TriggerEvent
  status      TriggerStatus @default(ACTIVE)
  conditions  Json
  actions     Json
  targetSegments String[]
  cooldown    Int         @default(0) // in minutes
  priority    Int         @default(0)
  triggerCount Int        @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  lastTriggered DateTime?

  // Indexes
  @@index([event])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([lastTriggered])
}

// TriggerExecution model - tracks trigger executions
model TriggerExecution {
  id          String   @id @default(uuid())
  triggerId   String
  leadId      String
  executedAt  DateTime @default(now())
  actions     Json
  context     Json

  // Relationships
  trigger     BehavioralTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([triggerId])
  @@index([leadId])
  @@index([executedAt])
}

// BehaviorAnalytics model - stores computed analytics
model BehaviorAnalytics {
  id                      String   @id @default(uuid())
  leadId                  String?
  sessionId               String
  totalEvents             Int      @default(0)
  uniqueEventTypes        Int      @default(0)
  totalTimeSpent          Int      @default(0) // in seconds
  averageSessionDuration   Int      @default(0) // in seconds
  engagementScore          Float    @default(0.0)
  interestScore            Float    @default(0.0)
  intentScore             Float    @default(0.0)
  conversionProbability    Float    @default(0.0)
  segments                String[]
  behaviorPattern          String
  lastActivity            DateTime
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Indexes
  @@index([leadId])
  @@index([sessionId])
  @@index([behaviorPattern])
  @@index([lastActivity])
  @@index([engagementScore])
  @@index([conversionProbability])
}

// Enums for behavior tracking
enum BehaviorEventType {
  PAGE_VIEW
  FORM_START
  FORM_SUBMIT
  FORM_ABANDON
  EMAIL_OPEN
  EMAIL_CLICK
  EMAIL_REPLY
  PHONE_CALL
  TEXT_INTERACTION
  SOCIAL_SHARE
  DOWNLOAD
  VIDEO_PLAY
  SCROLL_DEPTH
  TIME_ON_PAGE
  CLICK_OUTBOUND
  SEARCH_QUERY
  FILTER_USAGE
  QUOTE_REQUEST
  APPLICATION_START
  APPLICATION_COMPLETE
}

enum BehaviorCategory {
  ENGAGEMENT
  INTEREST
  INTENT
  CONVERSION
  RETENTION
  ADVOCACY
}

enum SegmentType {
  STATIC
  DYNAMIC
  BEHAVIORAL
}

enum SegmentStatus {
  ACTIVE
  INACTIVE
  DRAFT
}

enum PersonalizationType {
  CONTENT
  OFFER
  MESSAGE
  CTA
  TIMING
  CHANNEL
}

enum PersonalizationStatus {
  ACTIVE
  INACTIVE
  DRAFT
  ARCHIVED
}

enum ExperimentType {
  CONTENT
  OFFER
  LAYOUT
  TIMING
  CHANNEL
}

enum ExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  COMPLETED
  ARCHIVED
}

enum TriggerEvent {
  HIGH_ENGAGEMENT
  LOW_ENGAGEMENT
  FORM_ABANDON
  EMAIL_ENGAGEMENT
  PRICE_VIEW
  APPLICATION_START
  TIME_BASED
  SEQUENCE_COMPLETE
  SEGMENT_ENTER
  SEGMENT_EXIT
}

enum TriggerStatus {
  ACTIVE
  INACTIVE
  PAUSED
}