// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// Compliance Framework Models

// Compliance Policies and Rules
model CompliancePolicy {
  id                String      @id @default(cuid())
  name              String      // e.g., "GDPR Data Processing", "HIPAA Privacy Rules"
  description       String?
  domain            String      // "GDPR", "HIPAA", "CCPA", "GLBA", "Insurance", etc.
  jurisdiction      String?     // "EU", "US", "CA", "state-specific"
  riskLevel         String      // "Critical", "High", "Medium", "Low"
  status            String      @default("Active") // "Active", "Draft", "Archived"
  requirements      RequiredField[]
  violations        ComplianceViolation[]
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([domain])
  @@index([jurisdiction])
  @@index([status])
}

model RequiredField {
  id                String      @id @default(cuid())
  policyId          String
  policy            CompliancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  name              String      // e.g., "Consent Required", "Data Retention"
  description       String?
  validationRule    String      // JSON schema or custom validation logic
  enforcementLevel  String      // "Mandatory", "Recommended"
  createdAt         DateTime    @default(now())

  @@index([policyId])
}

// Compliance Violations and Alerts
model ComplianceViolation {
  id                String      @id @default(cuid())
  policyId          String
  policy            CompliancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  leadId            String?
  agentId           String?
  violationType     String      // "Missing Consent", "Retention Expired", etc.
  severity          String      // "Critical", "High", "Medium", "Low"
  status            String      @default("Open") // "Open", "Resolved", "Waived"
  description       String
  detectedAt        DateTime    @default(now())
  resolvedAt        DateTime?
  resolution        String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([policyId])
  @@index([leadId])
  @@index([agentId])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
}

// Immutable Audit Trail
model ComplianceAuditLog {
  id                String      @id @default(cuid())
  userId            String
  action            String      // "LeadCreated", "ConsentGiven", "DataDeleted", etc.
  entityType        String      // "Lead", "Agent", "Document", etc.
  entityId          String
  changes           String      // JSON of what changed
  compliancePolicies String?    // JSON array of policies involved
  ipAddress         String?
  userAgent         String?
  timestamp         DateTime    @default(now()) // Immutable
  createdAt         DateTime    @default(now())
  
  @@index([userId])
  @@index([entityId])
  @@index([timestamp])
  @@index([action])
}

// Compliance Status Dashboard Data
model ComplianceStatus {
  id                String      @id @default(cuid())
  domain            String      // "GDPR", "HIPAA", etc.
  jurisdiction      String?
  totalPolicies     Int
  activePolicies    Int
  openViolations    Int
  resolvedViolations Int
  complianceScore   Float       // 0-100
  lastAssessment    DateTime
  nextAssessment    DateTime
  updatedAt         DateTime    @updatedAt

  @@index([domain])
  @@index([jurisdiction])
}

// Data Subject Requests (GDPR DSAR, CCPA Requests)
model DataSubjectRequest {
  id                String      @id @default(cuid())
  leadId            String
  requestType       String      // "AccessRequest", "DeletionRequest", "PortabilityRequest"
  jurisdiction      String      // "GDPR", "CCPA", "Other"
  status            String      @default("Pending") // "Pending", "InProgress", "Completed", "Denied"
  requestDate       DateTime
  dueDate           DateTime    // Legal deadline (30-45 days typically)
  completionDate    DateTime?
  documents         String[]    // JSON array of document paths for fulfillment
  notes             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([leadId])
  @@index([status])
  @@index([requestDate])
  @@index([jurisdiction])
}

// Regulatory Requirements Checklist
model RegulatoryRequirement {
  id                String      @id @default(cuid())
  domain            String      // "GDPR", "HIPAA", "Insurance"
  jurisdiction      String      // "EU", "US", "State", etc.
  requirement       String      // Specific requirement text
  description       String?
  status            String      @default("NotStarted") // "NotStarted", "InProgress", "Completed"
  implementedDate   DateTime?
  lastVerified      DateTime?
  verificationNotes String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([domain])
  @@index([jurisdiction])
  @@index([status])
}