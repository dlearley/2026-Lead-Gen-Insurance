// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Organization model - stores company/broker information
model Organization {
  id                String   @id @default(uuid())
  name              String   @unique
  slug              String   @unique
  domain            String?
  logoUrl           String?
  primaryColor      String?  @default("#3B82F6")
  secondaryColor    String?  @default("#10B981")
  
  // Company Info
  companySize       String?  // '1-10', '11-50', '51-200', '201-500', '500+'
  industry          String?  // 'health', 'life', 'property', 'casualty', 'commercial', 'auto'
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String?
  phone             String?
  
  // Status & Configuration
  status            OrganizationStatus @default(PENDING)
  isActive          Boolean @default(false)
  setupComplete     Boolean @default(false)
  verifiedAt        DateTime?
  
  // Subscription
  subscriptionId    String?
  subscriptionStatus SubscriptionStatus @default(PENDING)
  subscriptionPlan  String?  // 'free', 'starter', 'professional', 'enterprise'
  
  // API & Security
  apiKeyHash        String?
  webhookUrl        String?
  
  // Metadata
  preferences       Json?    // Custom notification settings, etc.
  customFields      Json?    // Dynamic schema fields
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  users                 User[]
  teamInvitations       TeamInvitation[]
  auditLogs             AuditLog[]
  
  // Indexes
  @@index([slug])
  @@index([status])
  @@index([isActive])
  @@index([subscriptionStatus])
  @@index([createdAt])
}

// User model - enhanced with organization support
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  firstName         String?
  lastName          String?
  passwordHash      String?
  
  // Organization membership
  organizationId    String?
  role              UserRole @default(USER)
  permissions       Json?    // Custom permissions for fine-grained access control
  
  // Authentication
  isActive          Boolean  @default(false)  // Account is active
  emailVerified     Boolean  @default(false)  // Email verified
  lastLoginAt       DateTime?
  failedLoginCount  Int      @default(0)
  lockoutUntil      DateTime?
  
  // Profile
  avatarUrl         String?
  phone             String?
  jobTitle          String?
  department        String?
  
  // Social Auth
  googleId          String?  @unique
  microsoftId       String?  @unique
  
  // Onboarding & Preferences
  onboardingStep    Int?     @default(0)  // Current step in onboarding wizard
  preferences       Json?    // User preferences (notifications, theme, etc.)
  
  // Security & Tokens
  resetPasswordToken String?  @unique
  resetPasswordExpires DateTime?
  emailVerificationToken String? @unique
  emailVerificationExpires DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  sentInvitations   TeamInvitation[] @relation("inviter")
  receivedInvitations TeamInvitation[] @relation("invitee")
  
  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([role])
  @@index([isActive])
  @@index([emailVerified])
  @@index([lastLoginAt])
  @@index([createdAt])
}

// TeamInvitation model - for inviting team members
model TeamInvitation {
  id              String   @id @default(uuid())

  email           String   // Email of the invited user
  organizationId  String
  role            UserRole @default(USER)  // Role they will have in the organization
  permissions     Json?    // Custom permissions for this invitation
  
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime
  acceptedAt      DateTime?
  
  // Inviter info
  inviterId       String   // Who sent the invitation
  
  // Token for accepting invitation
  token           String   @unique
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter         User @relation("inviter", fields: [inviterId], references: [id])
  invitee         User? @relation("invitee", fields: [email], references: [email])
  
  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([status])
  @@index([token])
  @@index([expiresAt])
}

// AuditLog model - comprehensive audit trail for all actions
model AuditLog {
  id              String   @id @default(uuid())
  organizationId  String?
  userId          String?
  
  entityType      String?  // 'user', 'lead', 'policy', etc.
  entityId        String?
  action          String   // 'create', 'update', 'delete', 'login', etc.
  
  // What changed
  oldValues       Json?    // Previous values (for updates)
  newValues       Json?    // New values
  
  // Additional context
  ipAddress       String?
  userAgent       String?
  metadata        Json?    // Additional context
  
  createdAt       DateTime @default(now())

  // Relationships
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User? @relation(fields: [userId], references: [id])
  
  // Indexes
  @@index([organizationId])
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  organizationId  String?    // Optional: null for global/leads before organization assignment
  
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  attributions    Attribution[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([organizationId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  
  // Organization & User relationship
  userId              String?    @unique      // Links to User if agent is also a platform user
  organizationId      String?                 // Organization this agent belongs to
  
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]
  specializationsDetail AgentSpecialization[]
  availability        AgentAvailability?
  routingHistory      LeadRoutingHistory[]
  performanceMetrics  AgentPerformanceMetrics[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([organizationId])
  @@index([city])
  @@index([state])
} 

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  organizationId String?
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?
  assignedBy    String?    // User who assigned this lead

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([organizationId])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  organizationId String?  // Optional: organization context for events
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([organizationId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  
  organizationId      String?    // Optional: carrier specific to organization
  
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([organizationId])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  organizationId        String?    // Optional: org-specific metrics
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([organizationId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, organizationId, year, month])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Messaging Models
model Conversation {
  id String @id @default(cuid())
  organizationId String
  
  name String? // null for direct messages
  type ConversationType
  
  isArchived Boolean @default(false)
  lastMessageAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  participants ConversationParticipant[]
  messages Message[]
}

model ConversationParticipant {
  id String @id @default(cuid())
  conversationId String
  userId String
  
  role String // member, moderator, admin
  joinedAt DateTime @default(now())
  leftAt DateTime?
  
  lastReadAt DateTime?
  isMuted Boolean @default(false)
  
  conversation Conversation @relation(fields: [conversationId], references: [id])
}

model Message {
  id String @id @default(cuid())
  conversationId String
  authorId String
  
  content String
  contentType MessageContentType
  
  editedAt DateTime?
  deletedAt DateTime?
  
  isPinned Boolean @default(false)
  
  threadId String? // for threaded messages
  
  createdAt DateTime @default(now())
  
  reactions MessageReaction[]
  attachments MessageAttachment[]
  mentions String[] // mentioned user ids
  
  conversation Conversation @relation(fields: [conversationId], references: [id])
  
  @@index([conversationId, createdAt])
}

model MessageReaction {
  id String @id @default(cuid())
  messageId String
  userId String
  emoji String
  
  createdAt DateTime @default(now())
  
  message Message @relation(fields: [messageId], references: [id])
  
  @@unique([messageId, userId, emoji])
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// CUSTOMER SUCCESS MODELS
// ========================================

// Customer model - represents a broker/agency customer (converted from Lead)
model Customer {
  id                    String               @id @default(uuid())
  leadId                String?              @unique
  name                  String
  companyName           String?
  email                 String
  phone                 String?
  industry              String?
  businessType          String?
  employeeCount         Int?
  annualRevenue         Float?
  website               String?
  billingAddress        String?
  billingCity           String?
  billingState          String?
  billingZipCode        String?
  billingCountry        String?
  tier                  CustomerTier        @default(SMALL_BUSINESS)
  status                CustomerStatus       @default(ACTIVE)
  contractStartDate     DateTime
  contractEndDate       DateTime?
  annualContractValue   Float                @default(0.0)
  customerSince         DateTime             @default(now())

  // Metrics
  totalPolicies         Int                  @default(0)
  activePolicies        Int                  @default(0)
  lifetimeValue         Float                @default(0.0)
  healthScore           Int                  @default(0)
  churnRiskLevel        ChurnRiskLevel       @default(LOW)

  // Engagement
  lastContactDate       DateTime?
  nextRenewalDate       DateTime?
  preferredContactMethod String?
  tags                  String[]
  metadata              Json?

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relationships
  successProfile        CustomerSuccessProfile?
  successPlans          SuccessPlan[]
  healthScores          HealthScore[]
  businessReviews       BusinessReview[]
  advocacyActivities    AdvocacyActivity[]
  successMetrics        CustomerSuccessMetrics[]
  policies              Policy[]

  // Indexes
  @@index([email])
  @@index([tier])
  @@index([status])
  @@index([healthScore])
  @@index([churnRiskLevel])
  @@index([customerSince])
}

// CustomerSuccessProfile - detailed customer success profile
model CustomerSuccessProfile {
  id                    String               @id @default(uuid())
  customerId            String               @unique

  // CSM Assignment
  csmId                 String?
  csmName               String?
  csmEmail              String?
  executiveSponsorId    String?
  executiveSponsorName  String?
  executiveSponsorEmail String?
  technicalContactId    String?
  technicalContactName  String?
  technicalContactEmail String?

  // Business Objectives
  primaryObjective      String?
  secondaryObjectives   String[]
  successCriteria       Json?                // Success criteria as JSON object

  // Value Metrics (Baseline and Targets)
  baselineMetrics       Json?
  targetMetrics         Json?
  currentMetrics        Json?

  // Onboarding
  onboardingStartDate   DateTime?
  onboardingEndDate     DateTime?
  onboardingStatus      OnboardingStatus     @default(NOT_STARTED)
  goLiveDate            DateTime?
  timeToValue           Int?                 // Days to first value

  // Integration
  integrationsEnabled   String[]
  dataMigrationStatus   DataMigrationStatus  @default(NOT_STARTED)

  // Training
  usersTrained          Int                  @default(0)
  totalUsers            Int                  @default(0)
  trainingCompleted     Boolean              @default(false)
  trainingDate          DateTime?

  // Adoption
  adoptionRate          Float                @default(0.0)
  featureAdoption       Json?                // Feature adoption data
  loginFrequency        String?              // Daily, Weekly, etc.

  // Satisfaction
  latestNPS             Int?
  latestCSAT            Float?
  latestCES             Int?
  npsHistory            Json?
  csatHistory           Json?
  complaintCount        Int                  @default(0)

  // Financial
  expansionRevenue      Float                @default(0.0)
  expansionProbability  Float?              // 0-1

  // Notes
  csmNotes              String?
  riskNotes             String?
  opportunityNotes      String?

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relationships
  customer              Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([csmId])
  @@index([onboardingStatus])
}

// SuccessPlan - customer success plans with milestones
model SuccessPlan {
  id                    String               @id @default(uuid())
  customerId            String
  title                 String
  description           String?
  planType              SuccessPlanType      @default(ONBOARDING)
  status                SuccessPlanStatus    @default(ACTIVE)

  // Timeline
  startDate             DateTime
  endDate               DateTime?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Success Criteria
  businessObjectives    String[]
  successMetrics        Json?                // KPIs and targets
  baselineValue         Json?

  // Stakeholders
  stakeholders          Json?                // Array of stakeholder objects

  // Milestones
  milestones            SuccessPlanMilestone[]

  // Notes
  notes                 String?

  // Relationships
  customer              Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([status])
  @@index([startDate])
}

// SuccessPlanMilestone - milestones within success plans
model SuccessPlanMilestone {
  id                    String               @id @default(uuid())
  successPlanId         String
  title                 String
  description           String?
  dueDate               DateTime
  completedDate         DateTime?
  status                MilestoneStatus      @default(PENDING)
  owner                 String?
  priority              MilestonePriority    @default(MEDIUM)
  deliverables          String[]

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relationships
  successPlan           SuccessPlan          @relation(fields: [successPlanId], references: [id], onDelete: Cascade)

  @@index([successPlanId])
  @@index([status])
  @@index([dueDate])
}

// HealthScore - historical health score tracking
model HealthScore {
  id                    String               @id @default(uuid())
  customerId            String
  score                 Int                  // 0-100
  healthLevel           HealthLevel

  // Component Scores
  engagementScore       Int                  @default(0)
  successScore          Int                  @default(0)
  satisfactionScore     Int                  @default(0)
  financialScore        Int                  @default(0)

  // Metadata
  factors               Json?                // Factors affecting score
  notes                 String?
  trend                 HealthTrend          @default(STABLE)

  recordedAt            DateTime             @default(now())
  recordedBy            String?

  // Relationships
  customer              Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([score])
  @@index([healthLevel])
  @@index([recordedAt])
  @@unique([customerId, recordedAt])
}

// BusinessReview - business review meetings and outcomes
model BusinessReview {
  id                    String               @id @default(uuid())
  customerId            String
  reviewType            BusinessReviewType
  reviewDate            DateTime
  attendeeNames         String[]
  attendeeTitles        String[]

  // Review Content
  agenda                String[]
  achievements          String[]
  challenges            String[]
  metricsReview         Json?
  goalsProgress         Json?

  // Decisions & Actions
  decisions             String[]
  actionItems           Json?                // Array of action item objects
  nextSteps             String[]

  // Satisfaction
  overallRating         Int?                 // 1-5
  customerFeedback      String?

  // Documentation
  presentationUrl       String?
  notes                 String?
  followUpDate          DateTime?

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relationships
  customer              Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([reviewType])
  @@index([reviewDate])
}

// AdvocacyActivity - customer advocacy and reference activities
model AdvocacyActivity {
  id                    String               @id @default(uuid())
  customerId            String
  activityType          AdvocacyType
  title                 String
  description           String?

  // Activity Details
  status                AdvocacyStatus       @default(PENDING)
  date                  DateTime?
  contactPerson         String?
  contactEmail          String?

  // Outcomes
  outcome               String?
  value                 String?              // Quantified impact

  // Related Content
  caseStudyUrl          String?
  testimonialUrl        String?
  referenceNotes        String?

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relationships
  customer              Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([activityType])
  @@index([status])
}

// CustomerSuccessMetrics - aggregated metrics for reporting
model CustomerSuccessMetrics {
  id                    String               @id @default(uuid())
  customerId            String
  period                String               // YYYY-MM format
  periodType            PeriodType           @default(MONTHLY)

  // Business Metrics
  leadVolume            Int                  @default(0)
  conversionRate        Float                @default(0.0)
  revenueGenerated      Float                @default(0.0)
  costSavings           Float                @default(0.0)
  timeSavings           Int?                 // Hours

  // Adoption Metrics
  activeUsers           Int                  @default(0)
  totalUsers            Int                  @default(0)
  loginFrequency        Float                @default(0.0)
  featureUsage          Json?                // Feature usage breakdown

  // Satisfaction Metrics
  nps                   Int?
  csat                  Float?
  ces                   Int?

  // Support Metrics
  supportTickets        Int                  @default(0)
  ticketResolutionTime  Int?                 // Average in hours
  firstResponseTime     Int?                 // Average in hours

  calculatedAt          DateTime             @default(now())

  // Relationships
  customer              Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([period])
  @@index([periodType])
  @@unique([customerId, period, periodType])
}

// ========================================
// CUSTOMER SUCCESS ENUMS
// ========================================

enum CustomerTier {
  ENTERPRISE
  MID_MARKET
  SMALL_BUSINESS
  TRIAL
}

enum CustomerStatus {
  ACTIVE
  ONBOARDING
  AT_RISK
  CHURNED
  PAUSED
}

enum ChurnRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum DataMigrationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum SuccessPlanType {
  ONBOARDING
  QUARTERLY
  ANNUAL
  EXPANSION
  RECOVERY
}

enum SuccessPlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

enum MilestonePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum HealthLevel {
  POOR      // 0-39
  FAIR      // 40-59
  GOOD      // 60-79
  EXCELLENT // 80-100
}

enum HealthTrend {
  IMPROVING
  STABLE
  DECLINING
  UNKNOWN
}

enum BusinessReviewType {
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  EXECUTIVE
  STRATEGIC
}

enum AdvocacyType {
  CASE_STUDY
  TESTIMONIAL
  REFERENCE_CALL
  SPEAKER_EVENT
  PRESS_RELEASE
  WEBINAR
  USER_GROUP
  ADVISORY_BOARD
}

enum AdvocacyStatus {
  PENDING
  REQUESTED
  IN_PROGRESS
  COMPLETED
  DECLINED
  CANCELLED
}

enum PeriodType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
}