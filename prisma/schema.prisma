// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  importRecords   DataImportRecord[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// CRM Integration model - stores CRM connection configurations
model CrmIntegration {
  id                  String              @id @default(uuid())
  name                String
  provider            CrmProvider
  isActive            Boolean             @default(true)
  isConnected         Boolean             @default(false)
  accessToken         String?
  refreshToken        String?
  tokenExpiresAt      DateTime?
  instanceUrl         String?
  apiKey              String?
  apiSecret           String?
  webhookSecret       String?
  lastSyncAt          DateTime?
  syncStatus          SyncStatus          @default(IDLE)
  syncDirection       SyncDirection       @default(BIDIRECTIONAL)
  syncFrequency       Int                 @default(3600) // seconds
  autoSync            Boolean             @default(true)
  errorCount          Int                 @default(0)
  lastError           String?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relationships
  fieldMappings       CrmFieldMapping[]
  syncLogs            CrmSyncLog[]
  importJobs          DataImportJob[]

  // Indexes
  @@index([provider])
  @@index([isActive])
  @@index([isConnected])
  @@index([syncStatus])
  @@index([createdAt])
}

// CRM Field Mapping model - stores field mapping configurations
model CrmFieldMapping {
  id                  String              @id @default(uuid())
  integrationId       String
  sourceField         String
  targetField         String
  fieldType           FieldType
  isRequired          Boolean             @default(false)
  defaultValue        String?
  transformFunction   String?
  validationRules     Json?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relationships
  integration         CrmIntegration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([integrationId])
  @@index([sourceField])
  @@index([targetField])
  @@unique([integrationId, sourceField, targetField])
}

// CRM Sync Log model - tracks synchronization history
model CrmSyncLog {
  id                  String              @id @default(uuid())
  integrationId       String
  syncType            SyncType
  direction           SyncDirection
  status              SyncLogStatus
  recordsProcessed    Int                 @default(0)
  recordsSuccess      Int                 @default(0)
  recordsFailed       Int                 @default(0)
  recordsSkipped      Int                 @default(0)
  startedAt           DateTime            @default(now())
  completedAt         DateTime?
  duration            Int?                // milliseconds
  errorMessage        String?
  errorDetails        Json?
  metadata            Json?

  // Relationships
  integration         CrmIntegration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([integrationId])
  @@index([syncType])
  @@index([status])
  @@index([startedAt])
  @@index([completedAt])
}

// Data Import Job model - manages bulk data imports
model DataImportJob {
  id                  String              @id @default(uuid())
  integrationId       String?
  name                String
  importType          ImportType
  status              ImportStatus
  fileName            String?
  fileUrl             String?
  fileMimeType        String?
  fileSize            Int?
  totalRows           Int                 @default(0)
  processedRows       Int                 @default(0)
  successRows         Int                 @default(0)
  failedRows          Int                 @default(0)
  skippedRows         Int                 @default(0)
  duplicateRows       Int                 @default(0)
  validationErrors    Json?
  fieldMapping        Json?
  options             Json?
  scheduledFor        DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  duration            Int?                // milliseconds
  errorMessage        String?
  createdBy           String?
  metadata            Json?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relationships
  integration         CrmIntegration?     @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  importRecords       DataImportRecord[]

  // Indexes
  @@index([integrationId])
  @@index([importType])
  @@index([status])
  @@index([createdAt])
  @@index([startedAt])
  @@index([completedAt])
}

// Data Import Record model - stores individual import record details
model DataImportRecord {
  id                  String              @id @default(uuid())
  importJobId         String
  rowNumber           Int
  status              ImportRecordStatus
  leadId              String?
  sourceData          Json
  transformedData     Json?
  validationErrors    Json?
  errorMessage        String?
  isDuplicate         Boolean             @default(false)
  duplicateOfId       String?
  createdAt           DateTime            @default(now())

  // Relationships
  importJob           DataImportJob       @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  lead                Lead?               @relation(fields: [leadId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([importJobId])
  @@index([status])
  @@index([leadId])
  @@index([isDuplicate])
}

// Enums for CRM Integration
enum CrmProvider {
  SALESFORCE
  HUBSPOT
  PIPEDRIVE
  ZOHO
  MICROSOFT_DYNAMICS
}

enum SyncStatus {
  IDLE
  SYNCING
  SUCCESS
  ERROR
  PAUSED
}

enum SyncDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

enum SyncType {
  FULL
  INCREMENTAL
  MANUAL
}

enum SyncLogStatus {
  STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum FieldType {
  STRING
  NUMBER
  BOOLEAN
  DATE
  DATETIME
  EMAIL
  PHONE
  URL
  JSON
}

enum ImportType {
  CSV
  EXCEL
  JSON
  CRM_SYNC
  API
}

enum ImportStatus {
  PENDING
  VALIDATING
  VALIDATED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ImportRecordStatus {
  PENDING
  SUCCESS
  FAILED
  SKIPPED
  DUPLICATE
}