// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}
// Phase 13: Advanced AI & Verticals
// ML model configurations for each insurance vertical
model VerticalAIConfig {
  id                  String   @id @default(uuid())
  insuranceType       InsuranceType
  mlModelId           String   @unique
  isActive            Boolean  @default(true)
  confidenceThreshold Float    @default(0.8)
  autoTrainEnabled    Boolean  @default(true)
  lastTrainedAt       DateTime?
  trainingFrequency   String   // 'daily' | 'weekly' | 'monthly' | 'quarterly'
  accuracyMetrics     Json     // ModelAccuracyMetrics
  features            String[] // Feature list for ML model
  hyperparameters     Json     // ML hyperparameters
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([insuranceType])
  @@index([mlModelId])
  @@index([isActive])
}

// Predictive model results for leads and clients
model PredictiveModels {
  id                    String           @id @default(uuid())
  leadId                String?
  clientId              String?
  insuranceType         InsuranceType
  predictionType        String           // 'conversion' | 'churn' | 'lifetime_value'
  probability           Float?           // 0-1 for conversion/churn
  predictedValue        Float?           // USD for LTV
  confidence            Float            // 0-1
  primaryFactors        Json             // Factors array
  timelinePrediction    Json?            // Timeline-based predictions
  recommendations       Json             // Recommendations array
  modelAccuracy         Float?           // Actual vs predicted for feedback loop
  createdAt             DateTime         @default(now())
  
  @@index([leadId])
  @@index([clientId])
  @@index([predictionType])
  @@index([insuranceType])
  @@index([createdAt])
}

// Document processing results for OCR and AI analysis
model DocumentProcessingResult {
  id                    String                @id @default(uuid())
  documentId            String                @unique
  documentType          String                // 'LICENSE' | 'REGISTRATION' | 'POLICY' | 'CLAIM_FORM' | 'MEDICAL_RECORD' | 'INSPECTION_REPORT' | 'PHOTO' | 'OTHER'
  insuranceType         InsuranceType
  extractedFields       Json                  // Key-value pairs of extracted data
  confidenceScores      Json                  // Confidence scores per field
  extractedText         String                @db.Text
  entities              Json                  // EntityExtraction[]
  classification        Json                  // DocumentClassification
  validationResult      Json                  // DocumentValidation
  ocrQuality            Json                  // OCR quality metrics
  processingTime        Int                   // milliseconds
  requiresReview        Boolean               @default(false)
  reviewerNotes         String[]              @default([])
  createdAt             DateTime              @default(now())
  
  @@index([documentId])
  @@index([documentType])
  @@index([insuranceType])
  @@index([requiresReview])
  @@index([createdAt])
}

// Image analysis results for damage assessment and verification
model ImageAnalysisResult {
  id                    String                @id @default(uuid())
  imageId               String                @unique
  analysisType          String                // 'vehicle_damage' | 'property_damage' | 'document_photo' | 'id_verification' | 'property_inspection'
  insuranceType         InsuranceType
  detectedObjects       Json                  // DetectedObject[]
  classification        Json                  // ImageClassification
  damageAssessment      Json?                 // DamageAssessment
  qualityAssessment     Json                  // ImageQualityAssessment
  confidence            Float                 // 0-1
  requiresExpertReview  Boolean               @default(false)
  createdAt             DateTime              @default(now())
  
  @@index([imageId])
  @@index([analysisType])
  @@index([insuranceType])
  @@index([requiresExpertReview])
  @@index([createdAt])
}

// Voice processing results for call transcripts and analysis
model VoiceProcessingResult {
  id                    String                @id @default(uuid())
  audioId               String                @unique
  transcript            String                @db.Text
  confidence            Float                 // 0-1
  speakerDiarization    Json?                 // SpeakerDiarization[]
  sentimentAnalysis     Json                  // SentimentAnalysis
  intentRecognition     Json                  // IntentRecognition
  callQuality           Json                  // Call quality metrics
  keywords              String[]              @default([])
  entities              Json                  // EntityExtraction[]
  actionItems           String[]              @default([])
  duration              Int                   // seconds
  silencePercentage     Float                 // percentage
  createdAt             DateTime              @default(now())
  
  @@index([audioId])
  @@index([confidence])
  @@index([createdAt])
}

// Chatbot conversation storage for training and analysis
model ChatbotConversation {
  id                      String                @id @default(uuid())
  conversationId          String                @unique
  leadId                  String?
  agentId                 String?
  status                  String                // 'active' | 'completed' | 'escalated' | 'abandoned'
  channel                 String                // 'web' | 'mobile' | 'sms' | 'whatsapp' | 'messenger'
  startedAt               DateTime              @default(now())
  endedAt                 DateTime?
  messages                Json                  // ChatMessage[]
  summary                 Json                  // ConversationSummary
  nextActions             Json                  // RecommendedAction[]
  handoffRequired         Boolean               @default(false)
  handoffReason           String?
  createdAt               DateTime              @default(now())
  
  @@index([leadId])
  @@index([status])
  @@index([channel])
  @@index([handoffRequired])
  @@index([startedAt])
  @@index([endedAt])
}

// AI analytics and model performance tracking
model AIAnalytics {
  id                      String                @id @default(uuid())
  analyticsType           String                // 'MODEL_PERFORMANCE' | 'PREDICTION_ACCURACY' | 'PROCESSING_STATISTICS' | 'BUSINESS_IMPACT'
  modelId                 String?
  insuranceType           InsuranceType?
  metrics                 Json                  // Performance metrics object
  timeframeStart          DateTime
  timeframeEnd            DateTime
  createdAt               DateTime              @default(now())
  
  @@index([analyticsType])
  @@index([modelId])
  @@index([insuranceType])
  @@index([timeframeStart])
  @@index([timeframeEnd])
  @@index([createdAt])
}

// Compliance and regulatory check results
model ComplianceCheck {
  id                      String                @id @default(uuid())
  insuranceType           InsuranceType
  regulationType          String
  isCompliant             Boolean
  violations              Json                  // ComplianceViolation[]
  warnings                Json                  // ComplianceWarning[]
  recommendations         String[]              @default([])
  riskLevel               String                // 'low' | 'medium' | 'high' | 'critical'
  checkedAt               DateTime              @default(now())
  
  @@index([insuranceType])
  @@index([isCompliant])
  @@index([riskLevel])
  @@index([checkedAt])
}
