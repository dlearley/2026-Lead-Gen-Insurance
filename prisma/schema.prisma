// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Organization model - stores company/broker information
model Organization {
  id                String   @id @default(uuid())
  name              String   @unique
  slug              String   @unique
  domain            String?
  logoUrl           String?
  primaryColor      String?  @default("#3B82F6")
  secondaryColor    String?  @default("#10B981")
  
  // Company Info
  companySize       String?  // '1-10', '11-50', '51-200', '201-500', '500+'
  industry          String?  // 'health', 'life', 'property', 'casualty', 'commercial', 'auto'
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String?
  phone             String?
  
  // Status & Configuration
  status            OrganizationStatus @default(PENDING)
  isActive          Boolean @default(false)
  setupComplete     Boolean @default(false)
  verifiedAt        DateTime?
  
  // Subscription
  subscriptionId    String?
  subscriptionStatus SubscriptionStatus @default(PENDING)
  subscriptionPlan  String?  // 'free', 'starter', 'professional', 'enterprise'
  
  // API & Security
  apiKeyHash        String?
  webhookUrl        String?
  
  // Metadata
  preferences       Json?    // Custom notification settings, etc.
  customFields      Json?    // Dynamic schema fields
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  users                 User[]
  teamInvitations       TeamInvitation[]
  auditLogs             AuditLog[]
  
  // Indexes
  @@index([slug])
  @@index([status])
  @@index([isActive])
  @@index([subscriptionStatus])
  @@index([createdAt])
}

// User model - enhanced with organization support
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  firstName         String?
  lastName          String?
  passwordHash      String?
  
  // Organization membership
  organizationId    String?
  role              UserRole @default(USER)
  permissions       Json?    // Custom permissions for fine-grained access control
  
  // Authentication
  isActive          Boolean  @default(false)  // Account is active
  emailVerified     Boolean  @default(false)  // Email verified
  lastLoginAt       DateTime?
  failedLoginCount  Int      @default(0)
  lockoutUntil      DateTime?
  
  // Profile
  avatarUrl         String?
  phone             String?
  jobTitle          String?
  department        String?
  
  // Social Auth
  googleId          String?  @unique
  microsoftId       String?  @unique
  
  // Onboarding & Preferences
  onboardingStep    Int?     @default(0)  // Current step in onboarding wizard
  preferences       Json?    // User preferences (notifications, theme, etc.)
  
  // Security & Tokens
  resetPasswordToken String?  @unique
  resetPasswordExpires DateTime?
  emailVerificationToken String? @unique
  emailVerificationExpires DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  sentInvitations   TeamInvitation[] @relation("inviter")
  receivedInvitations TeamInvitation[] @relation("invitee")
  
  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([role])
  @@index([isActive])
  @@index([emailVerified])
  @@index([lastLoginAt])
  @@index([createdAt])
}

// TeamInvitation model - for inviting team members
model TeamInvitation {
  id              String   @id @default(uuid())

  email           String   // Email of the invited user
  organizationId  String
  role            UserRole @default(USER)  // Role they will have in the organization
  permissions     Json?    // Custom permissions for this invitation
  
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime
  acceptedAt      DateTime?
  
  // Inviter info
  inviterId       String   // Who sent the invitation
  
  // Token for accepting invitation
  token           String   @unique
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter         User @relation("inviter", fields: [inviterId], references: [id])
  invitee         User? @relation("invitee", fields: [email], references: [email])
  
  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([status])
  @@index([token])
  @@index([expiresAt])
}

// AuditLog model - comprehensive audit trail for all actions
model AuditLog {
  id              String   @id @default(uuid())
  organizationId  String?
  userId          String?
  
  entityType      String?  // 'user', 'lead', 'policy', etc.
  entityId        String?
  action          String   // 'create', 'update', 'delete', 'login', etc.
  
  // What changed
  oldValues       Json?    // Previous values (for updates)
  newValues       Json?    // New values
  
  // Additional context
  ipAddress       String?
  userAgent       String?
  metadata        Json?    // Additional context
  
  createdAt       DateTime @default(now())

  // Relationships
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User? @relation(fields: [userId], references: [id])
  
  // Indexes
  @@index([organizationId])
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  organizationId  String?    // Optional: null for global/leads before organization assignment
  
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  routingHistory  LeadRoutingHistory[]
  assignmentQueue AssignmentQueue?
  routingEvents   RoutingEvent[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([organizationId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  
  // Organization & User relationship
  userId              String?    @unique      // Links to User if agent is also a platform user
  organizationId      String?                 // Organization this agent belongs to
  
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]
  specializationsDetail AgentSpecialization[]
  availability        AgentAvailability?
  routingHistory      LeadRoutingHistory[]
  performanceMetrics  AgentPerformanceMetrics[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([organizationId])
  @@index([city])
  @@index([state])
} 

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  organizationId String?
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?
  assignedBy    String?    // User who assigned this lead

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([organizationId])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  organizationId String?  // Optional: organization context for events
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([organizationId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  
  organizationId      String?    // Optional: carrier specific to organization
  
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([organizationId])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  organizationId        String?    // Optional: org-specific metrics
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([organizationId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, organizationId, year, month])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// ========================================
// REGULATORY REPORTING & SUBMISSIONS (Phase 25.1F)
// ========================================

model ComplianceReport {
  id                  String   @id @default(cuid())
  reportId            String   @unique
  reportType          String
  jurisdiction        String
  reportPeriod        String
  startDate           DateTime
  endDate             DateTime

  title               String
  summary             String
  reportContent       String
  attachments         String[]

  metrics             String
  keyFindings         String[]
  violations          Int      @default(0)
  violations_critical Int      @default(0)
  violations_high     Int      @default(0)
  violations_medium   Int      @default(0)
  violations_low      Int      @default(0)

  remediationActions  String?
  completedRemediation Int     @default(0)
  pendingRemediation  Int      @default(0)

  status              String
  generatedDate       DateTime @default(now())
  approvedDate        DateTime?
  approvedBy          String?
  submittedDate       DateTime?
  submittedTo         String?
  submissionRef       String?

  generateType        String
  generatedBy         String

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  submissions         RegulatorySubmission[]
  reportMetrics       ComplianceReportMetrics[]

  @@index([reportType])
  @@index([jurisdiction])
  @@index([status])
  @@index([startDate])
}

model RegulatorySubmission {
  id                     String   @id @default(cuid())
  submissionId           String   @unique
  reportId               String
  reportType             String

  regulatoryBody         String
  jurisdiction           String
  submissionUrl          String
  submissionMethod       String
  submissionDate         DateTime @default(now())

  status                 String
  referenceNumber        String?
  acknowledgmentDate     DateTime?
  acknowledgmentDocument String?

  regulatoryResponse     String?
  responseDate           DateTime?
  requiredActions        String?
  deadline               DateTime?

  submittedBy            String
  notes                  String?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  report                 ComplianceReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([submissionDate])
}

model DataBreachNotification {
  id                        String   @id @default(cuid())
  breachId                  String   @unique
  breachDate                DateTime
  discoveryDate             DateTime

  breachType                String
  description               String
  affectedDataTypes         String[]
  affectedRecords           Int
  affectedIndividuals       Int

  systemsAffected           String[]
  severity                  String
  potentialHarm             String
  remediation               String
  preventionMeasures        String?

  notificationSent          Boolean  @default(false)
  notificationDate          DateTime?
  notificationMethod        String?
  templateUsed              String?
  individualsNotified       Int      @default(0)

  regulatorNotified         Boolean  @default(false)
  regulatorNotificationDate DateTime?
  regulators                String[]
  regulatoryRef             String?
  filingRequired            Boolean  @default(true)

  investigationStart        DateTime?
  investigationComplete     DateTime?
  rootCause                 String?
  investigationNotes        String?
  resolutionDate            DateTime?

  status                    String

  complianceRequirements    String[]
  legalCounsel              String?
  insuranceClaim            String?

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  recipients                BreachNotificationRecipient[]

  @@index([breachDate])
  @@index([status])
}

model BreachNotificationRecipient {
  id                  String   @id @default(cuid())
  breachId            String
  leadId              String
  email               String?
  phone               String?
  mailingAddress      String?

  notificationSent    Boolean  @default(false)
  notificationMethod  String?
  notificationDate    DateTime?
  readDate            DateTime?
  responseDate        DateTime?
  acknowledged        Boolean  @default(false)

  proof               String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  breach              DataBreachNotification @relation(fields: [breachId], references: [breachId], onDelete: Cascade)
  lead                Lead? @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([breachId, leadId])
}

model RegulatoryReportTemplate {
  id                  String   @id @default(cuid())
  templateName        String   @unique
  jurisdiction        String
  reportType          String
  description         String?

  sections            String
  requiredMetrics     String[]
  formatRequirements  String?
  frequency           String
  dueDate             String?

  regulatoryBody      String
  contactInfo         String?
  submissionURL       String?
  submissionEmail     String?

  status              String   @default("Active")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ScheduledReport {
  id              String   @id @default(cuid())
  reportType      String
  jurisdiction    String

  schedule        String
  frequency       String
  nextRunDate     DateTime
  lastRunDate     DateTime?

  autoGenerate    Boolean  @default(true)
  autoSubmit      Boolean  @default(false)
  requireApproval Boolean  @default(true)
  notifyOn        String[]

  status          String   @default("Active")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([reportType, jurisdiction])
}

model RegulatoryFilingChecklist {
  id               String   @id @default(cuid())
  filingId         String   @unique
  reportType       String
  jurisdiction     String
  dueDate          DateTime

  items            String
  completionStatus Int

  status           String
  submittedDate    DateTime?
  notes            String?

  assignedTo       String

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model RegulatoryFilingArchive {
  id                    String   @id @default(cuid())
  filingId              String   @unique
  reportId              String
  reportType            String
  jurisdiction          String
  filingYear            Int

  archivedDate          DateTime
  archiveLocation       String
  retention             String
  retentionExpiry       DateTime?
  checksum              String

  retrievalInstructions String?

  createdAt             DateTime @default(now())

  report                ComplianceReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
}

model RegulatoryDeadline {
  id                String     @id @default(cuid())
  deadlineId         String     @unique
  reportType         String
  jurisdiction       String

  description        String
  dueDate            DateTime
  reminderDates      DateTime[]

  isRecurring        Boolean    @default(false)
  recurrencePattern  String?

  status             String     @default("Upcoming")
  completionDate     DateTime?

  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@index([dueDate])
}

model ComplianceReportMetrics {
  id         String   @id @default(cuid())
  reportId   String
  metricType String

  data       String
  trend      String?

  createdAt  DateTime @default(now())

  report     ComplianceReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
}

model RegulatoryCommLog {
  id               String   @id @default(cuid())
  commId           String   @unique
  regulatoryBody   String
  jurisdiction     String

  commType         String
  subject          String
  content          String

  sentDate         DateTime
  sentBy           String
  sentTo           String
  deliveryProof    String?

  responseReceived Boolean  @default(false)
  responseDate     DateTime?
  responseContent  String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([sentDate])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// API Client model - represents external partner applications
model ApiClient {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  redirectUris        String[]
  website             String?
  logoUrl             String?
  contactEmail        String
  status              ApiClientStatus @default(ACTIVE)
  rateLimitTier       RateLimitTier @default(BASIC)
  webhookUrl          String?
  webhookSecret       String?
  scopes              String[]
  metadata            Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  apiKeys             ApiKey[]
  webhookSubscriptions WebhookSubscription[]
  apiUsageLogs        ApiUsageLog[]
  apiRateLimits       ApiRateLimit[]

  // Indexes
  @@index([status])
  @@index([rateLimitTier])
  @@index([contactEmail])
  @@index([createdAt])
}

// API Key model - for authentication
model ApiKey {
  id                  String     @id @default(uuid())
  clientId            String
  keyId               String     @unique
  keyHash             String
  keyPrefix           String
  name                String
  status              ApiKeyStatus @default(ACTIVE)
  lastUsedAt          DateTime?
  expiresAt           DateTime?
  scopes              String[]
  rateLimitOverride   Int?
  metadata            Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  apiClient           ApiClient   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([clientId])
  @@index([keyId])
  @@index([keyPrefix])
  @@index([status])
  @@index([expiresAt])
}

// Webhook Subscription model - for event subscriptions
model WebhookSubscription {
  id                  String     @id @default(uuid())
  clientId            String
  url                 String
  secret              String
  events              String[]
  status              WebhookStatus @default(ACTIVE)
  retryConfig         Json?
  metadata            Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  apiClient           ApiClient   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  deliveries          WebhookDelivery[]

  // Indexes
  @@index([clientId])
  @@index([status])
  @@index([events])
  @@index([createdAt])
}

// Webhook Delivery model - tracks webhook deliveries
model WebhookDelivery {
  id                  String     @id @default(uuid())
  subscriptionId      String
  eventType           String
  payload             Json
  responseCode        Int?
  responseBody        String?
  attemptCount        Int        @default(0)
  status              DeliveryStatus @default(PENDING)
  scheduledFor        DateTime   @default(now())
  deliveredAt         DateTime?
  nextRetryAt         DateTime?
  errorMessage        String?
  metadata            Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  subscription        WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([subscriptionId])
  @@index([eventType])
  @@index([status])
  @@index([scheduledFor])
  @@index([nextRetryAt])
  @@index([createdAt])
}

// API Usage Log model - tracks API usage
model ApiUsageLog {
  id                  String     @id @default(uuid())
  clientId            String
  apiKeyId            String?
  endpoint            String
  method              String
  statusCode          Int
  responseTimeMs      Int
  requestIp           String?
  userAgent           String?
  requestSize         Int?
  responseSize        Int?
  timestamp           DateTime   @default(now())

  // Relationships
  apiClient           ApiClient   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([clientId])
  @@index([endpoint])
  @@index([method])
  @@index([statusCode])
  @@index([timestamp])
  @@index([clientId, timestamp])
}

// API Rate Limit model - tracks rate limiting
model ApiRateLimit {
  id                  String     @id @default(uuid())
  clientId            String
  window              String
  requestCount        Int        @default(0)
  requestLimit        Int
  resetAt             DateTime
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  apiClient           ApiClient   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([clientId])
  @@index([window])
  @@index([resetAt])
  @@unique([clientId, window])
}

// Enums for API Ecosystem
enum ApiClientStatus {
  ACTIVE
  SUSPENDED
  REVOKED
  PENDING_VERIFICATION
}

enum ApiKeyStatus {
  ACTIVE
  SUSPENDED
  REVOKED
  EXPIRED
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
  MAX_RETRIES_EXCEEDED
}

enum RateLimitTier {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}