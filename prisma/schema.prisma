// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// Competitor model - tracks competitor information and intelligence
model Competitor {
  id                    String              @id @default(uuid())
  name                  String
  website               String?
  industry              String?
  tier                  CompetitorTier      @default(SECONDARY)
  category              CompetitorCategory  @default(INDIRECT)
  description           String?
  headquarters          String?
  foundedYear           Int?
  employeeCount         Int?
  fundingTotal          Float?
  lastFundingDate       DateTime?
  marketShare           Float?
  annualRevenue         Float?
  isActive              Boolean             @default(true)
  threatScore           Float              @default(0.0)
  opportunityScore      Float              @default(0.0)
  monitoringLevel       MonitoringLevel    @default(STANDARD)
  lastWebsiteScan       DateTime?
  lastNewsScan          DateTime?
  lastPricingCheck      DateTime?
  notes                 String?
  metadata              Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relationships
  activities            CompetitorActivity[]
  pricingHistory        PricingData[]
  winLosses             WinLoss[]
  marketShares          MarketShare[]
  alerts                CompetitiveAlert[]
  insights              CompetitiveInsight[]
  battleCards           BattleCard[]

  // Indexes
  @@index([name])
  @@index([tier])
  @@index([category])
  @@index([isActive])
  @@index([threatScore])
  @@index([createdAt])
}

// CompetitorActivity model - tracks competitor activities and events
model CompetitorActivity {
  id                    String              @id @default(uuid())
  competitorId          String
  activityType          ActivityType
  title                 String
  description           String?
  url                   String?
  source                String
  detectedAt            DateTime            @default(now())
  severity              AlertSeverity       @default(LOW)
  impact                ActivityImpact?
  notes                 String?
  metadata              Json?
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor          @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([competitorId])
  @@index([activityType])
  @@index([detectedAt])
  @@index([severity])
  @@index([createdAt])
}

// WinLoss model - tracks competitive win/loss data
model WinLoss {
  id                    String              @id @default(uuid())
  competitorId          String?
  dealId                String?
  dealAmount            Float?
  outcome               WinLossOutcome
  primaryReason         WinLossReason?
  secondaryReason       WinLossReason?
  salesRep              String?
  salesRepId            String?
  customerCompany       String?
  industry             String?
  vertical              String?
  dealDurationDays      Int?
  buyingCriteria        String[]
  decisionCriteria      String?
  competitorStrengths   String[]
  competitorWeaknesses  String[]
  ourStrengths         String[]
  ourWeaknesses         String[]
  pricingFactor         String?
  relationshipFactor    String?
  timingFactor          String?
  customerFeedback      String?
  lessonsLearned        String?
  actionItems           String[]
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor?         @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([competitorId])
  @@index([outcome])
  @@index([vertical])
  @@index([industry])
  @@index([createdAt])
}

// PricingData model - tracks competitor pricing information
model PricingData {
  id                    String              @id @default(uuid())
  competitorId          String
  productName           String?
  tier                  String?
  planName              String?
  monthlyPrice          Float?
  annualPrice           Float?
  currency              String              @default("USD")
  billingFrequency      String?
  features              String[]
  limitations           String[]
  discountAvailable     Boolean             @default(false)
  maxDiscount           Float?
  volumeDiscount        Boolean             @default(false)
  freeTierAvailable     Boolean             @default(false)
  freeTierLimits        String?
  trialDays             Int?
  notes                 String?
  detectedAt            DateTime            @default(now())
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor          @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([competitorId])
  @@index([detectedAt])
  @@index([createdAt])
}

// MarketShare model - tracks market share data
model MarketShare {
  id                    String              @id @default(uuid())
  competitorId          String?
  market                String
  vertical              String?
  period                String
  periodStart           DateTime
  periodEnd             DateTime
  customerCount         Int?
  estimatedRevenue      Float?
  marketShare           Float?
  growthRate            Float?
  customerAcquisition   Int?
  customerChurn        Int?
  dataConfidence        Float?
  dataSource            String?
  notes                 String?
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor?         @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([competitorId])
  @@index([market])
  @@index([vertical])
  @@index([period])
  @@index([createdAt])
  @@unique([competitorId, market, period])
}

// CompetitiveAlert model - manages competitive intelligence alerts
model CompetitiveAlert {
  id                    String              @id @default(uuid())
  competitorId          String?
  activityId            String?
  alertType             AlertType
  severity              AlertSeverity       @default(MEDIUM)
  title                 String
  description           String?
  recommendation         String?
  targetAudience        String[]
  status                AlertStatus         @default(ACTIVE)
  acknowledgedAt        DateTime?
  acknowledgedBy        String?
  actionTaken           String?
  resolvedAt            DateTime?
  metadata              Json?
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor?         @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([competitorId])
  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

// CompetitiveInsight model - stores generated insights and analysis
model CompetitiveInsight {
  id                    String              @id @default(uuid())
  competitorId          String?
  insightType           InsightType
  title                 String
  description           String?
  keyPoints             String[]
  dataSources           String[]
  confidence            Float?
  impact                ImpactLevel
  priority              Priority
  actionable            Boolean             @default(true)
  recommendations       String[]
  targetTeam            String[]
  relatedInsights       String[]
  expiresAt             DateTime?
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor?         @relation(fields: [competitorId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([competitorId])
  @@index([insightType])
  @@index([priority])
  @@index([createdAt])
}

// BattleCard model - sales battle cards for competitors
model BattleCard {
  id                    String              @id @default(uuid())
  competitorId          String
  title                 String
  competitorName        String
  tagline               String?
  overview              String?
  strengths             String[]
  weaknesses            String[]
  typicalObjections     String[]
  objectionResponses    Json?
  winStrategies         String[]
  talkingPoints         String[]
  proofPoints           String[]
  dealSizeRange         String?
  typicalSalesCycle     String?
  keyDecisionMakers     String[]
  pricingPosition       String?
  targetCustomers       String[]
  verticalFocus         String[]
  recentMoves           String[]
  actionItems           String[]
  lastUpdated           DateTime            @default(now())
  createdAt             DateTime            @default(now())

  // Relationships
  competitor            Competitor          @relation(fields: [competitorId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([competitorId])
  @@index([createdAt])
}

// Enums for competitive intelligence
enum CompetitorTier {
  PRIMARY
  SECONDARY
  EMERGING
  ADJACENT
}

enum CompetitorCategory {
  DIRECT
  INDIRECT
  ALTERNATIVE
}

enum MonitoringLevel {
  INTENSIVE
  STANDARD
  LIGHT
}

enum ActivityType {
  FEATURE_LAUNCH
  PRICING_CHANGE
  FUNDING_ANNOUNCEMENT
  HIRING_EXPANSION
  PARTNERSHIP_ANNOUNCEMENT
  PRODUCT_UPDATE
  MARKETING_CAMPAIGN
  PRESS_RELEASE
  NEWS_MENTION
  CUSTOMER_WIN
  EXECUTIVE_CHANGE
  ACQUISITION
  MARKET_ENTRY
  LEGAL_ACTION
  WEBSITE_UPDATE
  SOCIAL_MEDIA_ACTIVITY
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ActivityImpact {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

enum WinLossOutcome {
  WON
  LOST
  TIED
  NO_DECISION
}

enum WinLossReason {
  PRICE
  FEATURES
  RELATIONSHIP
  TIMING
  PRODUCT_MARKET_FIT
  INTEGRATION
  SUPPORT
  BRAND_RECOGNITION
  TECHNICAL_CAPABILITIES
  IMPLEMENTATION_SPEED
  CUSTOMER_SERVICE
  CONTRACT_TERMS
  SECURITY
  COMPLIANCE
  PERFORMANCE
  SCALABILITY
  EASE_OF_USE
  CUSTOMIZATION
  PARTNERSHIP
  GEOGRAPHIC_PRESENCE
}

enum AlertType {
  NEW_FEATURE
  PRICING_DROP
  PRICING_INCREASE
  MAJOR_FUNDING
  AGGRESSIVE_EXPANSION
  NEW_VERTICAL_ENTRY
  PARTNERSHIP_ANNOUNCEMENT
  CUSTOMER_WIN_ANNOUNCEMENT
  EXECUTIVE_CHANGE
  MARKET_SHARE_SHIFT
  WIN_LOSS_PATTERN
  FEATURE_GAP
  COMPETITIVE_WEAKNESS
  MARKET_OPPORTUNITY
  THREAT_ASSESSMENT
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

enum InsightType {
  MARKET_MOVEMENT
  WIN_LOSS_PATTERN
  FEATURE_GAP_ANALYSIS
  PRICING_STRATEGY
  GO_TO_MARKET
  VERTICAL_OPPORTUNITY
  COMPETITIVE_THREAT
  SWOT_ANALYSIS
  CUSTOMER_SENTIMENT
  TREND_ANALYSIS
}

enum ImpactLevel {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum Priority {
  IMMEDIATE
  HIGH
  MEDIUM
  LOW
}