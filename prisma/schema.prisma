// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  
  // New relations for Phase 16.3.8
  experimentAssignments ExperimentAssignment[]
  campaignLeads        CampaignLead[]
  state                LeadState?
  attributionLogs      AttributionLog[]
  orchestrationEvents  OrchestrationEvent[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Media Session model - tracks voice/video sessions
model MediaSession {
  id                   String            @id @default(uuid())
  sessionId            String            @unique
  sessionType          MediaSessionType
  sessionStatus        SessionStatus     @default(SCHEDULED)
  title                String
  description          String?
  createdBy            String
  maxParticipants      Int?
  isRecordingEnabled   Boolean           @default(false)
  isScreenShareEnabled Boolean           @default(true)
  isWaitingRoomEnabled Boolean           @default(false)
  isSecure             Boolean           @default(true)
  encryptionKey        String?
  roomUrl              String
  webhookUrl           String?
  metadata             Json?
  startTime            DateTime?
  endTime              DateTime?
  duration             Int               @default(0)
  qualityScore         Float?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relationships
  participants         RoomParticipant[]
  recordings           MediaRecording[]
  callLogs             CallLog[]
  signalMessages       SignalMessage[]

  // Indexes
  @@index([sessionId])
  @@index([sessionStatus])
  @@index([sessionType])
  @@index([createdBy])
  @@index([createdAt])
}

// RoomParticipant model - tracks participants in voice/video sessions
model RoomParticipant {
  id                   String            @id @default(uuid())
  sessionId            String
  participantId        String
  userId               String?
  displayName          String
  email                String?
  phone                String?
  avatarUrl            String?
  role                 ParticipantRole
  status               ParticipantStatus @default(INVITED)
  isAudioEnabled       Boolean           @default(false)
  isVideoEnabled       Boolean           @default(false)
  isScreenSharing      Boolean           @default(false)
  isHandRaised         Boolean           @default(false)
  hasRecordingConsent  Boolean           @default(false)
  browserInfo          Json?
  deviceInfo           Json?
  networkStats         Json?
  joinedAt             DateTime          @default(now())
  leftAt               DateTime?
  lastSeenAt           DateTime          @updatedAt

  // Relationships
  session              MediaSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Indexes
  @@index([sessionId])
  @@index([participantId])
  @@index([userId])
  @@index([status])
  @@index([joinedAt])
  @@unique([sessionId, participantId])
}

// MediaRecording model - tracks voice/video recordings
model MediaRecording {
  id                String           @id @default(uuid())
  recordingId       String           @unique
  sessionId         String
  participantId     String?
  format            RecordingFormat
  status            RecordingStatus  @default(STARTED)
  storageUrl        String?
  fileSize          Int?
  duration          Int              @default(0)
  quality           RecordingQuality @default(MEDIUM)
  isAudioOnly       Boolean          @default(false)
  isComposite       Boolean          @default(false)
  startTime         DateTime         @default(now())
  endTime           DateTime?
  transcriptionId   String?
  metadata          Json?
  createdAt         DateTime         @default(now())

  // Relationships
  session           MediaSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Indexes
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
}

// CallLog model - tracks call events for analytics
model CallLog {
  id          String        @id @default(uuid())
  sessionId   String
  participantId String
  eventType   CallEventType
  timestamp   DateTime      @default(now())
  details     Json?
  qualityMetrics Json?

  // Relationships
  session     MediaSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Indexes
  @@index([sessionId])
  @@index([participantId])
  @@index([eventType])
  @@index([timestamp])
}

// SignalMessage model - tracks WebRTC signaling messages
model SignalMessage {
  id               String     @id @default(uuid())
  sessionId        String
  fromParticipantId String
  toParticipantId  String?
  messageType      SignalType
  payload          Json
  isBroadcast      Boolean    @default(false)
  timestamp        DateTime   @default(now())

  // Relationships
  session          MediaSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  // Indexes
  @@index([sessionId])
  @@index([fromParticipantId])
  @@index([toParticipantId])
  @@index([messageType])
  @@index([timestamp])
}


// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// Voice/Video Enums
enum MediaSessionType {
  VOICE
  VIDEO
  SCREEN_SHARE
  BROADCAST
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  ENDED
  FAILED
  CANCELLED
}

enum ParticipantRole {
  HOST
  CO_HOST
  PARTICIPANT
  VIEWER
  MODERATOR
}

enum ParticipantStatus {
  INVITED
  JOINING
  CONNECTED
  DISCONNECTED
  REMOVED
  ERROR
}

enum RecordingFormat {
  MP4
  WEBM
  MP3
  WAV
  M4A
}

enum RecordingStatus {
  STARTED
  IN_PROGRESS
  STOPPED
  COMPLETED
  FAILED
  PROCESSING
  READY
  DELETED
}

enum RecordingQuality {
  LOW
  MEDIUM
  HIGH
  HD
  FULL_HD
  _4K
}

enum CallEventType {
  SESSION_STARTED
  SESSION_ENDED
  PARTICIPANT_JOINED
  PARTICIPANT_LEFT
  AUDIO_ENABLED
  AUDIO_DISABLED
  VIDEO_ENABLED
  VIDEO_DISABLED
  SCREEN_SHARE_STARTED
  SCREEN_SHARE_STOPPED
  RECORDING_STARTED
  RECORDING_STOPPED
  HAND_RAISED
  HAND_LOWERED
  CONNECTION_ESTABLISHED
  CONNECTION_LOST
  QUALITY_DEGRADED
  QUALITY_IMPROVED
  ERROR
}

enum SignalType {
  OFFER
  ANSWER
  ICE_CANDIDATE
  JOIN
  LEAVE
  MUTE
  UNMUTE
  START_SCREEN_SHARE
  STOP_SCREEN_SHARE
  HAND_RAISE
  MESSAGE
  CONNECTION_STATE
  ROOM_UPDATE
  ERROR
}