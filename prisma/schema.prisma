// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}
// Insurance License Management
model InsuranceLicense {
  id                String      @id @default(cuid())
  agentId           String
  licenseNumber     String
  licenseType       String      // "Property", "Casualty", "Health", "Life", "Variable", "Universal", "Title"
  states            String[]    // Array of states where licensed
  lines             String[]    // Lines of authority (e.g., ["Auto", "Home", "Life"])
  issuanceDate      DateTime
  expiryDate        DateTime
  status            String      @default("Active") // "Active", "Suspended", "Revoked", "Expired", "Pending"
  verificationDate  DateTime?
  verificationSource String?    // e.g., "NIPR", "StateBoard", "Manual"
  producerNumber    String?
  appointmentStatus String?     // "Appointed", "Terminated", "Pending"
  backgroundCheck   String      // "Passed", "Failed", "Pending", "Waived"
  fingerprintedDate DateTime?
  complianceIssues  String[]    // Array of known compliance issues
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([agentId, licenseNumber])
  @@index([status])
  @@index([expiryDate])
}

// Carrier Appointment & Authority
model CarrierAppointment {
  id                String      @id @default(cuid())
  agentId           String
  carrierId         String      // Reference to insurance carrier
  carrierName       String      // Carrier name for audit
  appointmentDate   DateTime
  terminationDate   DateTime?
  authorizedLines   String[]    // Lines authorized by carrier (may be subset of license)
  appointmentStatus String      @default("Active") // "Active", "Suspended", "Terminated", "Inactive"
  commissionSplit   String?     // JSON with commission structure
  contractUrl       String?     // URL to appointment contract
  complianceStatus  String      // "Compliant", "NonCompliant", "UnderReview"
  violations        String[]    // Array of violation descriptions
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([agentId, carrierId])
  @@index([appointmentStatus])
}

// Product Compliance Rules
model InsuranceProductRule {
  id                String      @id @default(cuid())
  productType       String      // "Auto", "Home", "Health", "Life", "Umbrella", etc.
  jurisdiction      String      // State code (CA, NY, TX) or "Federal"
  ruleType          String      // "MinPremium", "MaxDeductible", "RequiredDisclosure", "AgeLimit", "MedicalUnderwriting"
  ruleDescription   String
  ruleCondition     String      // JSON schema or expression for rule evaluation
  severity          String      // "Critical", "High", "Medium", "Low"
  effectiveDate     DateTime
  expiryDate        DateTime?
  status            String      @default("Active") // "Active", "Draft", "Archived"
  sourceReference   String?     // e.g., "Insurance Commissioner Bulletin", "Statute Section"
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([productType, jurisdiction, ruleType])
}

// Fair Lending Compliance Rules (ECOA, FHA, etc.)
model FairLendingRule {
  id                String      @id @default(cuid())
  ruleType          String      // "ECOA", "FHA", "CRA", "FCRA", "StateLaw", "InsuranceRegulation"
  regulation        String      // e.g., "ECOA Section 701", "FHA Section 3605"
  description       String      // Full description of the regulation
  prohibitedFactors String[]    // Array of prohibited factors (race, color, religion, sex, national origin, etc.)
  jurisdiction      String      // "Federal" or state code
  affectedProducts  String[]    // Products affected by this rule
  complianceActions String[]    // Required compliance actions
  testingMethod     String?     // How to test compliance
  penalties         String?     // Potential penalties
  effectiveDate     DateTime
  status            String      @default("Active")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Disparate Impact Testing & Monitoring
model DisparateImpactMonitor {
  id                String      @id @default(cuid())
  monitoringPeriod  String      // YYYY-MM (month) or YYYY-Q# (quarter) or YYYY (annual)
  protectedClass    String      // "Race", "Color", "Religion", "Sex", "NationalOrigin", "Age", "Disability"
  product           String      // Product type monitored
  totalApplications Int
  approvedByClass   String      // JSON with approval counts by class
  deniedByClass     String      // JSON with denial counts by class
  approvalRateByClass String    // JSON with approval rate % by class
  disparateImpact   Boolean     // Calculated disparate impact (80% rule)
  disparityRatio    Float       // Actual approval rate difference
  flagged           Boolean     @default(false)
  reviewedDate      DateTime?
  reviewNotes       String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([monitoringPeriod, protectedClass, product])
}

// Quote & Premium Compliance
model QuoteCompliance {
  id                String      @id @default(cuid())
  quoteId           String
  productType       String
  state             String
  appliedRules      String[]    // Rules that were applied to this quote
  violations        String[]    // Violations detected
  premiumBefore     Float       // Premium before adjustments
  premiumAfter      Float       // Premium after compliance adjustments
  adjustments       String      // JSON with adjustment details
  complianceStatus  String      // "Compliant", "NonCompliant", "ManualReview"
  reviewedBy        String?
  reviewNotes       String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([quoteId])
  @@index([complianceStatus])
}

// Required Disclosures
model RequiredDisclosure {
  id                String      @id @default(cuid())
  jurisdiction      String      // State code or "Federal"
  productType       String      // "Auto", "Home", "Health", "Life", etc.
  disclosureType    String      // "RateDisclosure", "UnderwritingFactors", "CancellationPolicy", "AppealsProcess", "GLBA", "CCPA"
  disclosureText    String      // Full disclosure text
  format            String      // "Email", "PDF", "WebPage", "Paper", "Verbal"
  timing            String      // When disclosure must be made (e.g., "Before Quote", "Before Binding", "Upon Request")
  isRequired        Boolean     @default(true)
  isSensitive       Boolean     @default(false) // Requires special tracking
  effectiveDate     DateTime
  expiryDate        DateTime?
  status            String      @default("Active")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([jurisdiction, productType, disclosureType])
}

// Disclosure Delivery Tracking
model DisclosureDelivery {
  id                String      @id @default(cuid())
  leadId            String
  disclosureId      String
  disclosureType    String
  productType       String
  state             String
  deliveryMethod    String      // "Email", "WebPage", "PDF", "Paper"
  deliveryDate      DateTime    @default(now())
  deliveredAt       DateTime?
  readDate          DateTime?   // When lead viewed disclosure
  acknowledged      Boolean     @default(false)
  acknowledgmentDate DateTime?
  proof             String?     // URL to delivery proof (signed document, read receipt, etc.)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([leadId])
  @@index([deliveryDate])
  @@index([acknowledged])
}

// Underwriting & Declination Rules
model UnderwritingRule {
  id                String      @id @default(cuid())
  productType       String
  state             String
  ruleDescription   String
  ruleExpression    String      // JSON schema or DSL for rule evaluation
  action            String      // "Approve", "Decline", "ManualReview", "RequestInfo", "CounterOffer"
  reasoning         String      // Why rule triggers this action
  auditTrail        Boolean     @default(true)
  requiresManual    Boolean     @default(false) // Requires human review
  effectiveDate     DateTime
  expiryDate        DateTime?
  status            String      @default("Active")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Agent Compliance History
model AgentComplianceRecord {
  id                String      @id @default(cuid())
  agentId           String
  eventType         String      // "Complaint", "Investigation", "Sanction", "Training", "Audit", "Violation"
  severity          String      // "Critical", "High", "Medium", "Low"
  description       String
  source            String?     // "RegulatoryComplaint", "InternalAudit", "CustomerComplaint", "ExternalReview"
  state             String?     // Which state it occurred in
  dateOccurred      DateTime
  dateResolved      DateTime?
  resolution        String?
  status            String      // "Open", "Resolved", "Suspended", "Terminated"
  attachments       String[]    // URLs to supporting documents
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([agentId])
  @@index([eventType])
  @@index([status])
}

// Anti-Discrimination Rules
model AntiDiscriminationRule {
  id                String      @id @default(cuid())
  regulation        String      // "ECOA", "FHA", "ADA", "StateLaw"
  jurisdiction      String      // State code or "Federal"
  prohibitedFactors String[]    // Prohibited discrimination factors
  applicableProducts String[]   // Which products this applies to
  checkMethod       String      // How to check for discrimination
  actionRequired    String      // Action if discrimination detected
  effectiveDate     DateTime
  status            String      @default("Active")
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

// Insurance Statutes & Regulations Repository
model InsuranceRegulation {
  id                String      @id @default(cuid())
  jurisdiction      String      // State code or "Federal"
  regulationType    String      // "UnfairPractice", "DiscriminationProhibition", "DisclosureRequirement", "RateRegulation", "ReserveRequirement"
  statute           String      // Statute name/number
  description       String
  fullText          String?     // Full regulation text (optional)
  effectiveDate     DateTime
  expiryDate        DateTime?
  penalties         String?     // Potential penalties
  enforcingAgency   String      // "Insurance Commissioner", "Attorney General", etc.
  contactInfo       String?     // Contact info for enforcing agency
  lastReviewedDate  DateTime
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}
