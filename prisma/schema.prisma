// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Organization model - stores company/broker information
model Organization {
  id                String   @id @default(uuid())
  name              String   @unique
  slug              String   @unique
  domain            String?
  logoUrl           String?
  primaryColor      String?  @default("#3B82F6")
  secondaryColor    String?  @default("#10B981")
  
  // Company Info
  companySize       String?  // '1-10', '11-50', '51-200', '201-500', '500+'
  industry          String?  // 'health', 'life', 'property', 'casualty', 'commercial', 'auto'
  address           String?
  city              String?
  state             String?
  zipCode           String?
  country           String?
  phone             String?
  
  // Status & Configuration
  status            OrganizationStatus @default(PENDING)
  isActive          Boolean @default(false)
  setupComplete     Boolean @default(false)
  verifiedAt        DateTime?
  
  // Subscription
  subscriptionId    String?
  subscriptionStatus SubscriptionStatus @default(PENDING)
  subscriptionPlan  String?  // 'free', 'starter', 'professional', 'enterprise'
  
  // API & Security
  apiKeyHash        String?
  webhookUrl        String?
  
  // Metadata
  preferences       Json?    // Custom notification settings, etc.
  customFields      Json?    // Dynamic schema fields
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  users                 User[]
  teamInvitations       TeamInvitation[]
  auditLogs             AuditLog[]
  
  // Indexes
  @@index([slug])
  @@index([status])
  @@index([isActive])
  @@index([subscriptionStatus])
  @@index([createdAt])
}

// User model - enhanced with organization support
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  firstName         String?
  lastName          String?
  passwordHash      String?
  
  // Organization membership
  organizationId    String?
  role              UserRole @default(USER)
  permissions       Json?    // Custom permissions for fine-grained access control
  
  // Authentication
  isActive          Boolean  @default(false)  // Account is active
  emailVerified     Boolean  @default(false)  // Email verified
  lastLoginAt       DateTime?
  failedLoginCount  Int      @default(0)
  lockoutUntil      DateTime?
  
  // Profile
  avatarUrl         String?
  phone             String?
  jobTitle          String?
  department        String?
  
  // Social Auth
  googleId          String?  @unique
  microsoftId       String?  @unique
  
  // Onboarding & Preferences
  onboardingStep    Int?     @default(0)  // Current step in onboarding wizard
  preferences       Json?    // User preferences (notifications, theme, etc.)
  
  // Security & Tokens
  resetPasswordToken String?  @unique
  resetPasswordExpires DateTime?
  emailVerificationToken String? @unique
  emailVerificationExpires DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  sentInvitations   TeamInvitation[] @relation("inviter")
  receivedInvitations TeamInvitation[] @relation("invitee")
  
  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([role])
  @@index([isActive])
  @@index([emailVerified])
  @@index([lastLoginAt])
  @@index([createdAt])
}

// TeamInvitation model - for inviting team members
model TeamInvitation {
  id              String   @id @default(uuid())

  email           String   // Email of the invited user
  organizationId  String
  role            UserRole @default(USER)  // Role they will have in the organization
  permissions     Json?    // Custom permissions for this invitation
  
  status          InvitationStatus @default(PENDING)
  expiresAt       DateTime
  acceptedAt      DateTime?
  
  // Inviter info
  inviterId       String   // Who sent the invitation
  
  // Token for accepting invitation
  token           String   @unique
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter         User @relation("inviter", fields: [inviterId], references: [id])
  invitee         User? @relation("invitee", fields: [email], references: [email])
  
  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([status])
  @@index([token])
  @@index([expiresAt])
}

// AuditLog model - comprehensive audit trail for all actions
model AuditLog {
  id              String   @id @default(uuid())
  organizationId  String?
  userId          String?
  
  entityType      String?  // 'user', 'lead', 'policy', etc.
  entityId        String?
  action          String   // 'create', 'update', 'delete', 'login', etc.
  
  // What changed
  oldValues       Json?    // Previous values (for updates)
  newValues       Json?    // New values
  
  // Additional context
  ipAddress       String?
  userAgent       String?
  metadata        Json?    // Additional context
  
  createdAt       DateTime @default(now())

  // Relationships
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User? @relation(fields: [userId], references: [id])
  
  // Indexes
  @@index([organizationId])
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  organizationId  String?    // Optional: null for global/leads before organization assignment
  
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  routingHistory  LeadRoutingHistory[]
  assignmentQueue AssignmentQueue?
  routingEvents   RoutingEvent[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([organizationId])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  
  // Organization & User relationship
  userId              String?    @unique      // Links to User if agent is also a platform user
  organizationId      String?                 // Organization this agent belongs to
  
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]
  specializationsDetail AgentSpecialization[]
  availability        AgentAvailability?
  routingHistory      LeadRoutingHistory[]
  performanceMetrics  AgentPerformanceMetrics[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([organizationId])
  @@index([city])
  @@index([state])
} 

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  organizationId String?
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?
  assignedBy    String?    // User who assigned this lead

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([organizationId])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  organizationId String?  // Optional: organization context for events
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([organizationId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  
  organizationId      String?    // Optional: carrier specific to organization
  
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([organizationId])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  organizationId        String?    // Optional: org-specific metrics
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([organizationId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, organizationId, year, month])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Financial Products
model FinancialProduct {
  id                    String              @id @default(uuid())
  organizationId        String?
  productName           String
  productType           ProductType
  providerId            String
  description           String?
  category              String
  subcategory           String?
  status                ProductStatus       @default(ACTIVE)
  minInvestment         Decimal?            @db.Decimal(15, 2)
  maxInvestment         Decimal?            @db.Decimal(15, 2)
  fees                  Json?
  terms                 Json?
  regulatoryClassification Json?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([organizationId])
  @@index([providerId])
  @@index([productType])
  @@index([status])
  @@index([createdAt])
  @@map("financial_products")
}

model ProductVariant {
  id              String   @id @default(uuid())
  productId       String
  variantName     String
  variantCode     String?
  tierLevel       Int?
  features        Json?
  pricing         Json?
  requirements    Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
  @@index([tierLevel])
  @@map("product_variants")
}

// Financial Advisors
model FinancialAdvisor {
  id                  String           @id @default(uuid())
  organizationId      String?
  userId              String?
  licenseNumber       String           @unique
  licenseType         String[]
  specializations     String[]
  credentials         Json?
  maxClients          Int              @default(50)
  currentClients      Int              @default(0)
  aum                 Decimal?         @db.Decimal(15, 2)
  status              AdvisorStatus    @default(ACTIVE)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("financial_advisors")
}

// Financial Planning
model FinancialPlan {
  id                 String        @id @default(uuid())
  customerId         String
  advisorId          String?
  planType           String?
  status             PlanStatus    @default(DRAFT)
  creationDate       DateTime?
  lastReviewDate     DateTime?
  nextReviewDate     DateTime?
  planDocumentUrl    String?
  recommendations    Json?
  goals              Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([customerId])
  @@index([advisorId])
  @@index([status])
  @@index([creationDate])
  @@index([nextReviewDate])
  @@map("financial_plans")
}

model FinancialGoal {
  id                 String       @id @default(uuid())
  customerId         String
  goalType           String?
  goalDescription    String?
  targetAmount       Decimal?     @db.Decimal(15, 2)
  targetDate         DateTime?
  currentProgress    Decimal?     @db.Decimal(15, 2) @default(0)
  priorityLevel      Int          @default(3)
  status             GoalStatus   @default(NOT_STARTED)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([targetDate])
  @@index([priorityLevel])
  @@map("financial_goals")
}

// Wealth Management
model CustomerAccount {
  id                    String   @id @default(uuid())
  customerId            String
  accountName           String?
  accountType           String?
  externalAccountId     String?
  institutionName       String?
  balance               Decimal? @default(0) @db.Decimal(15, 2)
  currency              String   @default("USD")
  isAggregated          Boolean  @default(false)
  aggregationSource     String?
  lastSyncedAt          DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([customerId])
  @@index([externalAccountId])
  @@index([isAggregated])
  @@index([lastSyncedAt])
  @@map("customer_accounts")
}

model Portfolio {
  id                 String         @id @default(uuid())
  customerId         String
  portfolioName      String?
  portfolioType      PortfolioType?
  status             PortfolioStatus @default(ACTIVE)
  totalValue         Decimal?       @default(0) @db.Decimal(15, 2)
  cashPosition       Decimal?       @default(0) @db.Decimal(15, 2)
  targetAllocation   Json?
  actualAllocation   Json?
  performanceYtd     Decimal?       @default(0) @db.Decimal(10, 4)
  performance1yr     Decimal?       @default(0) @db.Decimal(10, 4)
  riskScore          Int?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([customerId])
  @@index([portfolioType])
  @@index([status])
  @@index([riskScore])
  @@index([createdAt])
  @@map("portfolios")
}

model PortfolioHolding {
  id                 String   @id @default(uuid())
  portfolioId        String
  securityId         String?
  symbol             String?
  quantity           Decimal? @db.Decimal(15, 4)
  costBasis          Decimal? @default(0) @db.Decimal(15, 2)
  currentValue       Decimal? @default(0) @db.Decimal(15, 2)
  purchaseDate       DateTime?
  unrealizedGainLoss Decimal? @default(0) @db.Decimal(15, 2)
  allocationPercentage Decimal? @default(0) @db.Decimal(5, 4)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([portfolioId])
  @@index([symbol])
  @@index([securityId])
  @@map("portfolio_holdings")
}

// Open Banking & Data
model LinkedAccount {
  id                     String   @id @default(uuid())
  customerId             String
  externalAccountId      String?
  externalInstitutionId  String?
  institutionName        String?
  accountType            String?
  accountNumberMasked    String?
  routingNumber          String?
  balance                Decimal? @default(0) @db.Decimal(15, 2)
  currency               String   @default("USD")
  isActive               Boolean  @default(true)
  lastSyncedAt           DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([customerId])
  @@index([externalAccountId])
  @@index([isActive])
  @@index([lastSyncedAt])
  @@map("linked_accounts")
}

model FinancialTransaction {
  id                  String   @id @default(uuid())
  customerId          String
  accountId           String?
  transactionDate     DateTime
  transactionType     String?
  category            String?
  amount              Decimal  @db.Decimal(15, 2)
  merchant            String?
  description         String?
  transactionIdExternal String?
  createdAt           DateTime @default(now())

  @@index([customerId])
  @@index([accountId])
  @@index([transactionDate])
  @@index([category])
  @@index([transactionIdExternal])
  @@map("financial_transactions")
}

model SpendingAnalytics {
  id                  String   @id @default(uuid())
  customerId          String
  periodMonth         DateTime
  totalSpending       Decimal? @default(0) @db.Decimal(15, 2)
  categoryBreakdown   Json?
  incomeTotal         Decimal? @default(0) @db.Decimal(15, 2)
  savingsRate         Decimal? @default(0) @db.Decimal(5, 4)
  debtPayments        Decimal? @default(0) @db.Decimal(15, 2)
  createdAt           DateTime @default(now())

  @@index([customerId])
  @@index([periodMonth])
  @@unique([customerId, periodMonth])
  @@map("spending_analytics")
}

// Product Applications
model ProductApplication {
  id                 String           @id @default(uuid())
  customerId         String
  productId          String?
  variantId          String?
  advisorId          String?
  applicationDate    DateTime         @default(now())
  status             ApplicationStatus @default(DRAFT)
  applicationData    Json?
  documents          Json?
  approvedDate       DateTime?
  enrollmentDate     DateTime?
  decisionReason     String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([customerId])
  @@index([productId])
  @@index([advisorId])
  @@index([status])
  @@index([applicationDate])
  @@index([approvedDate])
  @@map("product_applications")
}

model CustomerProduct {
  id                String              @id @default(uuid())
  customerId        String
  productId         String?
  variantId         String?
  enrollmentDate    DateTime?
  accountNumber     String?
  status            CustomerProductStatus @default(ACTIVE)
  balance           Decimal?            @default(0) @db.Decimal(15, 2)
  currentValue      Decimal?            @default(0) @db.Decimal(15, 2)
  performance       Decimal?            @default(0) @db.Decimal(10, 4)
  lastStatementDate DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([customerId])
  @@index([productId])
  @@index([status])
  @@index([enrollmentDate])
  @@map("customer_products")
}

// Recommendations
model ProductRecommendation {
  id                  String   @id @default(uuid())
  customerId          String
  productId           String?
  recommendationType  String?
  confidenceScore     Decimal? @default(0) @db.Decimal(5, 4)
  reason              String?
  recommendedDate     DateTime @default(now())
  viewed              Boolean  @default(false)
  clicked             Boolean  @default(false)
  applied             Boolean  @default(false)
  createdAt           DateTime @default(now())

  @@index([customerId])
  @@index([productId])
  @@index([confidenceScore])
  @@index([recommendedDate])
  @@index([viewed])
  @@index([clicked])
  @@index([applied])
  @@map("product_recommendations")
}

// Financial Wellness
model WellnessProgram {
  id              String   @id @default(uuid())
  organizationId  String?
  programName     String
  description     String?
  programType     String?
  targetSegments  Json?
  status          WellnessStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("wellness_programs")
}

model WellnessEnrollment {
  id                String          @id @default(uuid())
  customerId        String
  programId         String
  enrollmentDate    DateTime        @default(now())
  completionStatus  Decimal?        @default(0) @db.Decimal(5, 4)
  score             Int?
  status            WellnessStatus  @default(ACTIVE)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([customerId])
  @@index([programId])
  @@index([status])
  @@index([enrollmentDate])
  @@map("wellness_enrollments")
}

model WellnessActivity {
  id                 String   @id @default(uuid())
  enrollmentId       String
  activityType       String?
  activityName       String?
  completedDate      DateTime?
  pointsEarned       Int      @default(0)
  createdAt          DateTime @default(now())

  @@index([enrollmentId])
  @@index([completedDate])
  @@map("wellness_activities")
}

// Compliance
model ComplianceDocument {
  id                  String   @id @default(uuid())
  organizationId      String?
  documentType        String?
  documentVersion     Int      @default(1)
  effectiveDate       DateTime?
  documentUrl         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([organizationId])
  @@index([documentType])
  @@index([effectiveDate])
  @@index([documentVersion])
  @@map("compliance_documents")
}

model AuditLog {
  id                  String   @id @default(uuid())
  organizationId      String?
  userId              String?
  actionType          String?
  entityType          String?
  entityId            String?
  changes             Json?
  timestamp           DateTime @default(now())
  ipAddress           String?
  createdAt           DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([actionType])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([ipAddress])
  @@map("audit_logs")
}

// Partnerships
model FinancialPartner {
  id                  String          @id @default(uuid())
  organizationId      String?
  partnerName         String
  partnerType         String?
  status              PartnerStatus   @default(ACTIVE)
  agreementDate       DateTime?
  terms               Json?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([organizationId])
  @@index([partnerType])
  @@index([status])
  @@index([agreementDate])
  @@map("financial_partners")
}

model CommissionTracking {
  id                   String          @id @default(uuid())
  partnerId            String
  productId            String?
  customerId           String?
  applicationId        String?
  commissionAmount     Decimal?        @default(0) @db.Decimal(15, 2)
  commissionPercentage Decimal?        @default(0) @db.Decimal(5, 4)
  status               CommissionStatus @default(PENDING)
  paymentDate          DateTime?
  createdAt            DateTime        @default(now())

  @@index([partnerId])
  @@index([productId])
  @@index([customerId])
  @@index([status])
  @@index([paymentDate])
  @@map("commission_tracking")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  firstName       String?
  lastName        String?
  phone           String?
  status          UserStatus @default(ACTIVE)
  role            UserRole   @default(CUSTOMER)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([role])
  @@index([createdAt])
}

model Organization {
  id              String    @id @default(uuid())
  name            String
  type            String?
  status          OrgStatus @default(ACTIVE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([name])
  @@index([status])
  @@index([createdAt])
}

// Financial Analytics
model FinancialAnalytics {
  id                     String   @id @default(uuid())
  customerId             String   @unique
  analysisDate           DateTime @default(now())
  netWorth               Decimal? @default(0) @db.Decimal(15, 2)
  assetAllocation        Json?
  debtToIncomeRatio      Decimal? @default(0) @db.Decimal(5, 4)
  savingsRate            Decimal? @default(0) @db.Decimal(5, 4)
  financialHealthScore   Int?
  riskProfile            String?
  createdAt              DateTime @default(now())

  @@index([customerId])
  @@index([analysisDate])
  @@index([financialHealthScore])
  @@index([riskProfile])
  @@map("financial_analytics")
}

// Enums for Financial Services
enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum UserRole {
  CUSTOMER
  ADVISOR
  ADMIN
  SUPER_ADMIN
}

enum OrgStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum ProductType {
  BANKING
  INVESTMENT
  INSURANCE
  RETIREMENT
  WEALTH
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum AdvisorStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PlanStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_TRACK
  AT_RISK
  COMPLETED
}

enum PortfolioType {
  MODEL
  ROBO
  DIRECT
  MANAGED
}

enum PortfolioStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DECLINED
  ENROLLED
}

enum CustomerProductStatus {
  ACTIVE
  INACTIVE
  CLOSED
}

enum WellnessStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

// Original Enums
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// AGENT SPECIALIZATION (Phase 27.2)
// ========================================

model AgentSpecialization {
  id                   String   @id @default(uuid())
  agentId              String
  insuranceLine        String   // Auto, Home, Life, Health, Commercial
  customerSegment      String   // Individual, SMB, Enterprise
  proficiencyLevel     Int      @default(1) // 1-5 (Novice to Expert)
  maxConcurrentLeads   Int      @default(5)
  languages            Json     // ['English', 'Spanish']
  territories          Json     // ['CA', 'NY', 'TX']
  isEliteAgent         Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  agent                Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, insuranceLine, customerSegment])
  @@index([agentId])
  @@index([insuranceLine])
  @@index([customerSegment])
}

// ========================================
// AGENT AVAILABILITY (Phase 27.2)
// ========================================

model AgentAvailability {
  id              String   @id @default(uuid())
  agentId         String   @unique
  status          String   @default("Available") // Available, In_Call, Break, Training, Offline
  currentLoad     Int      @default(0)
  maxCapacity     Int
  lastUpdated     DateTime @updatedAt
  updatedAt       DateTime @updatedAt

  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([status, currentLoad])
}

// ========================================
// LEAD ROUTING HISTORY (Phase 27.2)
// ========================================

model LeadRoutingHistory {
  id                     String   @id @default(uuid())
  leadId                 String
  assignedAgentId        String
  routingStrategy        String   @default("greedy") // greedy, optimal, reinforcement, manual
  leadScore              Float
  assignmentReason       Json
  routingTimestamp       DateTime @default(now())
  assignmentDurationHours Float?
  conversionOutcome      Boolean?
  assignmentQualityScore Float?
  feedback               String?
  createdAt              DateTime @default(now())

  lead                   Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent                  Agent    @relation(fields: [assignedAgentId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([assignedAgentId])
  @@index([routingTimestamp])
}

// ========================================
// AGENT PERFORMANCE METRICS (Phase 27.2)
// ========================================

model AgentPerformanceMetrics {
  id                       String   @id @default(uuid())
  agentId                  String
  periodDate               DateTime @db.Date
  leadsAssigned            Int      @default(0)
  leadsConverted           Int      @default(0)
  conversionRate           Float    @default(0.0)
  avgHandlingTimeMinutes   Float    @default(0.0)
  customerSatisfactionRating Float @default(0.0)
  crossSellRate           Float    @default(0.0)
  upsellRate              Float    @default(0.0)
  repeatCustomerRate      Float    @default(0.0)
  avgLeadScore            Float    @default(0.0)
  tier1ConversionRate     Float    @default(0.0)
  tier2ConversionRate     Float    @default(0.0)
  tier3ConversionRate     Float    @default(0.0)
  updatedAt               DateTime @updatedAt

  agent                   Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, periodDate])
  @@index([agentId, periodDate(sort: Desc)])
}

// ========================================
// ROUTING EXPERIMENTS (Phase 27.2)
// ========================================

model RoutingExperiment {
  id                String   @id @default(uuid())
  name              String
  strategyType      String   // greedy, optimal, reinforcement, hybrid
  description       String?
  status            String   @default("active") // active, paused, completed, archived
  trafficPercentage Float    @default(50.0)
  startDate         DateTime
  endDate           DateTime?
  controlStrategyId String?
  successMetric     String   @default("conversion_rate")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  controlStrategy   RoutingExperiment? @relation("ControlStrategy", fields: [controlStrategyId], references: [id], onDelete: SetNull)
  variants          RoutingExperimentVariant[]
  leadAssignments   LeadExperimentAssignment[]

  @@index([status])
  @@index([startDate, endDate])
}

model RoutingExperimentVariant {
  id                String   @id @default(uuid())
  experimentId      String
  name              String
  strategy          String
  parameters        Json
  trafficAllocation Float    @default(50.0)
  createdAt         DateTime @default(now())

  experiment        RoutingExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  assignments       LeadExperimentAssignment[]

  @@index([experimentId])
}

model LeadExperimentAssignment {
  id           String   @id @default(uuid())
  leadId       String
  experimentId String
  variantId    String
  assignedAt   DateTime @default(now())

  experiment   RoutingExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant      RoutingExperimentVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([experimentId, variantId])
}

// ========================================
// ASSIGNMENT QUEUES (Phase 27.2)
// ========================================

model AssignmentQueue {
  id                  String   @id @default(uuid())
  queueType           String   @default("active") // hot, active, nurture, waiting, reassignment
  leadId              String   @unique
  leadScore           Float
  timeInQueue         Interval @default("0 seconds")
  assignmentAttempts  Int      @default(0)
  lastAttempted       DateTime?
  estimatedWaitMinutes Int
  slaExpiry           DateTime?
  queuePosition       Int
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  lead                Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([queueType, leadScore(sort: Desc)])
  @@index([slaExpiry])
}

// ========================================
// ROUTING RULES (Phase 27.2)
// ========================================

model RoutingRule {
  id          String   @id @default(uuid())
  ruleName    String
  ruleType    String   // matching, capacity, geographic, business_logic, temporal
  condition   Json
  action      String
  priority    Int      @default(50)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([priority(sort: Desc), isActive])
}

// ========================================
// ROUTING EVENTS (Phase 27.2)
// ========================================

model RoutingEvent {
  id         String   @id @default(uuid())
  leadId     String
  eventType  String   // assigned, reassigned, escalated, failed_assignment, sla_warning
  agentId    String?
  eventData  Json
  timestamp  DateTime @default(now())

  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, timestamp(sort: Desc)])
  @@index([eventType])
}