// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  routingHistory  LeadRoutingHistory[]
  assignmentQueue AssignmentQueue?
  routingEvents   RoutingEvent[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]
  specializationsDetail AgentSpecialization[]
  availability        AgentAvailability?
  routingHistory      LeadRoutingHistory[]
  performanceMetrics  AgentPerformanceMetrics[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// AGENT SPECIALIZATION (Phase 27.2)
// ========================================

model AgentSpecialization {
  id                   String   @id @default(uuid())
  agentId              String
  insuranceLine        String   // Auto, Home, Life, Health, Commercial
  customerSegment      String   // Individual, SMB, Enterprise
  proficiencyLevel     Int      @default(1) // 1-5 (Novice to Expert)
  maxConcurrentLeads   Int      @default(5)
  languages            Json     // ['English', 'Spanish']
  territories          Json     // ['CA', 'NY', 'TX']
  isEliteAgent         Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  agent                Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, insuranceLine, customerSegment])
  @@index([agentId])
  @@index([insuranceLine])
  @@index([customerSegment])
}

// ========================================
// AGENT AVAILABILITY (Phase 27.2)
// ========================================

model AgentAvailability {
  id              String   @id @default(uuid())
  agentId         String   @unique
  status          String   @default("Available") // Available, In_Call, Break, Training, Offline
  currentLoad     Int      @default(0)
  maxCapacity     Int
  lastUpdated     DateTime @updatedAt
  updatedAt       DateTime @updatedAt

  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([status, currentLoad])
}

// ========================================
// LEAD ROUTING HISTORY (Phase 27.2)
// ========================================

model LeadRoutingHistory {
  id                     String   @id @default(uuid())
  leadId                 String
  assignedAgentId        String
  routingStrategy        String   @default("greedy") // greedy, optimal, reinforcement, manual
  leadScore              Float
  assignmentReason       Json
  routingTimestamp       DateTime @default(now())
  assignmentDurationHours Float?
  conversionOutcome      Boolean?
  assignmentQualityScore Float?
  feedback               String?
  createdAt              DateTime @default(now())

  lead                   Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent                  Agent    @relation(fields: [assignedAgentId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([assignedAgentId])
  @@index([routingTimestamp])
}

// ========================================
// AGENT PERFORMANCE METRICS (Phase 27.2)
// ========================================

model AgentPerformanceMetrics {
  id                       String   @id @default(uuid())
  agentId                  String
  periodDate               DateTime @db.Date
  leadsAssigned            Int      @default(0)
  leadsConverted           Int      @default(0)
  conversionRate           Float    @default(0.0)
  avgHandlingTimeMinutes   Float    @default(0.0)
  customerSatisfactionRating Float @default(0.0)
  crossSellRate           Float    @default(0.0)
  upsellRate              Float    @default(0.0)
  repeatCustomerRate      Float    @default(0.0)
  avgLeadScore            Float    @default(0.0)
  tier1ConversionRate     Float    @default(0.0)
  tier2ConversionRate     Float    @default(0.0)
  tier3ConversionRate     Float    @default(0.0)
  updatedAt               DateTime @updatedAt

  agent                   Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, periodDate])
  @@index([agentId, periodDate(sort: Desc)])
}

// ========================================
// ROUTING EXPERIMENTS (Phase 27.2)
// ========================================

model RoutingExperiment {
  id                String   @id @default(uuid())
  name              String
  strategyType      String   // greedy, optimal, reinforcement, hybrid
  description       String?
  status            String   @default("active") // active, paused, completed, archived
  trafficPercentage Float    @default(50.0)
  startDate         DateTime
  endDate           DateTime?
  controlStrategyId String?
  successMetric     String   @default("conversion_rate")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  controlStrategy   RoutingExperiment? @relation("ControlStrategy", fields: [controlStrategyId], references: [id], onDelete: SetNull)
  variants          RoutingExperimentVariant[]
  leadAssignments   LeadExperimentAssignment[]

  @@index([status])
  @@index([startDate, endDate])
}

model RoutingExperimentVariant {
  id                String   @id @default(uuid())
  experimentId      String
  name              String
  strategy          String
  parameters        Json
  trafficAllocation Float    @default(50.0)
  createdAt         DateTime @default(now())

  experiment        RoutingExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  assignments       LeadExperimentAssignment[]

  @@index([experimentId])
}

model LeadExperimentAssignment {
  id           String   @id @default(uuid())
  leadId       String
  experimentId String
  variantId    String
  assignedAt   DateTime @default(now())

  experiment   RoutingExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant      RoutingExperimentVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([experimentId, variantId])
}

// ========================================
// ASSIGNMENT QUEUES (Phase 27.2)
// ========================================

model AssignmentQueue {
  id                  String   @id @default(uuid())
  queueType           String   @default("active") // hot, active, nurture, waiting, reassignment
  leadId              String   @unique
  leadScore           Float
  timeInQueue         Interval @default("0 seconds")
  assignmentAttempts  Int      @default(0)
  lastAttempted       DateTime?
  estimatedWaitMinutes Int
  slaExpiry           DateTime?
  queuePosition       Int
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  lead                Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([queueType, leadScore(sort: Desc)])
  @@index([slaExpiry])
}

// ========================================
// ROUTING RULES (Phase 27.2)
// ========================================

model RoutingRule {
  id          String   @id @default(uuid())
  ruleName    String
  ruleType    String   // matching, capacity, geographic, business_logic, temporal
  condition   Json
  action      String
  priority    Int      @default(50)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([priority(sort: Desc), isActive])
}

// ========================================
// ROUTING EVENTS (Phase 27.2)
// ========================================

model RoutingEvent {
  id         String   @id @default(uuid())
  leadId     String
  eventType  String   // assigned, reassigned, escalated, failed_assignment, sla_warning
  agentId    String?
  eventData  Json
  timestamp  DateTime @default(now())

  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, timestamp(sort: Desc)])
  @@index([eventType])
}