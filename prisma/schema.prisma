// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  importRecords   DataImportRecord[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// CustomerHealthScore model - predictive health scoring for customer success
model CustomerHealthScore {
  id                 String                   @id @default(uuid())
  customerId         String                   @unique
  overallScore       Int                      @default(0)
  lastCalculated     DateTime                 @default(now())
  previousScore      Int?
  scoreChange        Int?
  calculationVersion String                   @default("v1.0")
  churnRisk          ChurnRiskLevel           @default(LOW)
  churnProbability   Float                    @default(0.0)
  riskFactors        Json?
  recommendedActions String[]
  autoTriggerActions String[]
  scoringCategories  Json? // Store detailed category scores: engagement, satisfaction, usage, etc.
  engagementScore    Int? // 0-100
  satisfactionScore  Int? // 0-100
  usageScore         Int? // 0-100
  supportScore       Int? // 0-100
  financialScore     Int? // 0-100
  trend              ScoreTrend               @default(STABLE)
  nextReviewDate     DateTime?
  notes              String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  // Relationships
  interventions      CustomerIntervention[]

  // Indexes
  @@index([overallScore])
  @@index([churnRisk])
  @@index([lastCalculated])
  @@index([customerId])
}

// CustomerIntervention model - tracks retention efforts and outcomes
model CustomerIntervention {
  id                 String                 @id @default(uuid())
  healthScoreId      String
  customerId         String
  interventionType   InterventionType
  priority           PriorityLevel          @default(MEDIUM)
  status             InterventionStatus     @default(PENDING)
  title              String
  description        String?
  assignedTo         String? // Agent or team member ID
  assignedAt         DateTime?
  completedAt        DateTime?
  dueDate            DateTime?
  notes              String?
  outcome            String? // SUCCESS, PARTIAL, FAILED, CUSTOMER_RESPONDED, etc.
  outcomeNotes       String?
  cost               Float? // Resource cost of intervention
  effectivenessScore Int? // 0-100 - how effective was this intervention
  triggerSource      String? // What triggered this intervention (alert, manual, scheduled)
  metadata           Json? // Additional context
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  // Relationships
  healthScore        CustomerHealthScore    @relation(fields: [healthScoreId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([healthScoreId])
  @@index([customerId])
  @@index([interventionType])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([dueDate])
  @@index([createdAt])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// PHASE 12.5: COMMUNITY NETWORK EFFECTS
// ========================================

// Connection & Following
model Connection {
  id           String           @id @default(uuid())
  requesterId  String
  addresseeId  String
  status       ConnectionStatus @default(PENDING)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
  @@unique([requesterId, addresseeId])
}

model AgentFollow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  @@index([followerId])
  @@index([followingId])
  @@unique([followerId, followingId])
}

// Mentorship
model Mentor {
  id                  String         @id @default(uuid())
  agentId             String         @unique
  specialties         String[]
  bio                 String
  yearsOfExperience   Int
  maxMentees          Int            @default(5)
  currentMentees      Int            @default(0)
  status              MentorStatus   @default(AVAILABLE)
  rating              Float          @default(0.0)
  totalSessions       Int            @default(0)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  mentorshipRequests  MentorshipRequest[]

  @@index([agentId])
  @@index([status])
}

model MentorshipRequest {
  id        String                    @id @default(uuid())
  mentorId  String
  menteeId  String
  message   String
  status    MentorshipRequestStatus   @default(PENDING)
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt

  mentor    Mentor                    @relation(fields: [mentorId], references: [id], onDelete: Cascade)
  sessions  MentorshipSession[]

  @@index([mentorId])
  @@index([menteeId])
  @@index([status])
}

model MentorshipSession {
  id                    String         @id @default(uuid())
  mentorshipRequestId   String
  scheduledAt           DateTime
  durationMinutes       Int
  status                SessionStatus  @default(SCHEDULED)
  notes                 String?
  rating                Int?
  feedback              String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  mentorshipRequest     MentorshipRequest @relation(fields: [mentorshipRequestId], references: [id], onDelete: Cascade)

  @@index([mentorshipRequestId])
  @@index([status])
  @@index([scheduledAt])
}

// Community Groups
model CommunityGroup {
  id          String      @id @default(uuid())
  name        String
  description String
  type        GroupType   @default(PUBLIC)
  category    String?
  region      String?
  specialty   String?
  coverImage  String?
  createdBy   String
  memberCount Int         @default(0)
  postCount   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  memberships GroupMembership[]

  @@index([createdBy])
  @@index([type])
  @@index([category])
  @@index([region])
  @@index([specialty])
}

model GroupMembership {
  id        String           @id @default(uuid())
  groupId   String
  agentId   String
  role      GroupMemberRole  @default(MEMBER)
  status    MembershipStatus @default(ACTIVE)
  joinedAt  DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  group     CommunityGroup   @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([agentId])
  @@index([status])
  @@unique([groupId, agentId])
}

// Referral Network
model AgentReferral {
  id                   String         @id @default(uuid())
  referrerId           String
  refereeId            String
  leadId               String
  reason               String
  status               ReferralStatus @default(PENDING)
  commissionPercentage Float          @default(10.0)
  commissionAmount     Float?
  paidAt               DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@index([referrerId])
  @@index([refereeId])
  @@index([leadId])
  @@index([status])
}

// Events & Webinars
model CommunityEvent {
  id               String       @id @default(uuid())
  title            String
  description      String
  type             EventType
  status           EventStatus  @default(DRAFT)
  hostId           String
  startTime        DateTime
  endTime          DateTime
  timezone         String       @default("UTC")
  maxAttendees     Int?
  currentAttendees Int          @default(0)
  meetingUrl       String?
  recordingUrl     String?
  materials        String[]
  tags             String[]
  coverImage       String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  registrations    EventRegistration[]

  @@index([hostId])
  @@index([type])
  @@index([status])
  @@index([startTime])
}

model EventRegistration {
  id           String             @id @default(uuid())
  eventId      String
  agentId      String
  status       RegistrationStatus @default(REGISTERED)
  registeredAt DateTime           @default(now())
  attendedAt   DateTime?
  rating       Int?
  feedback     String?

  event        CommunityEvent     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([agentId])
  @@index([status])
  @@unique([eventId, agentId])
}

// Reputation & Recognition
model Badge {
  id          String    @id @default(uuid())
  name        String
  description String
  type        BadgeType
  icon        String
  criteria    Json
  points      Int       @default(0)
  rarity      Int       @default(1)
  createdAt   DateTime  @default(now())

  agentBadges AgentBadge[]

  @@index([type])
}

model AgentBadge {
  id        String   @id @default(uuid())
  agentId   String
  badgeId   String
  awardedAt DateTime @default(now())

  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([badgeId])
  @@unique([agentId, badgeId])
}

model Endorsement {
  id         String   @id @default(uuid())
  agentId    String
  endorserId String
  skill      String
  message    String?
  createdAt  DateTime @default(now())

  @@index([agentId])
  @@index([endorserId])
  @@index([skill])
  @@unique([agentId, endorserId, skill])
}

model ExpertTopic {
  id                String    @id @default(uuid())
  agentId           String
  topic             String
  endorsementCount  Int       @default(0)
  articlesWritten   Int       @default(0)
  questionsAnswered Int       @default(0)
  score             Float     @default(0.0)
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([agentId])
  @@index([topic])
  @@index([score])
  @@unique([agentId, topic])
}

model ActivityStreak {
  id             String   @id @default(uuid())
  agentId        String
  streakType     String
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActivityAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([agentId])
  @@index([streakType])
  @@unique([agentId, streakType])
}

// Collaboration
model Collaboration {
  id              String               @id @default(uuid())
  leadId          String
  initiatorId     String
  title           String
  description     String
  status          CollaborationStatus  @default(PROPOSED)
  estimatedValue  Float
  splitPercentage Json
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  completedAt     DateTime?

  participants    CollaborationParticipant[]

  @@index([leadId])
  @@index([initiatorId])
  @@index([status])
}

model CollaborationParticipant {
  id               String        @id @default(uuid())
  collaborationId  String
  agentId          String
  role             String
  splitPercentage  Float
  invitedAt        DateTime      @default(now())
  acceptedAt       DateTime?
  status           String        @default("INVITED")

  collaboration    Collaboration @relation(fields: [collaborationId], references: [id], onDelete: Cascade)

  @@index([collaborationId])
  @@index([agentId])
  @@unique([collaborationId, agentId])
}

model KnowledgeArticle {
  id          String   @id @default(uuid())
  authorId    String
  title       String
  content     String
  category    String
  tags        String[]
  views       Int      @default(0)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId])
  @@index([category])
  @@index([isPublished])
  @@index([publishedAt])
}

// Enums for Phase 12.5
enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum MentorStatus {
  AVAILABLE
  BUSY
  UNAVAILABLE
}

enum MentorshipRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
  CANCELLED
}

enum SessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum GroupType {
  PUBLIC
  PRIVATE
  SECRET
}

enum GroupMemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum MembershipStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BANNED
}

enum ReferralStatus {
  PENDING
  ACCEPTED
  REJECTED
  CONVERTED
  EXPIRED
}

enum EventType {
  WEBINAR
  WORKSHOP
  TRAINING
  NETWORKING
  CONFERENCE
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELLED
}

enum RegistrationStatus {
  REGISTERED
  ATTENDED
  NO_SHOW
  CANCELLED
}

enum BadgeType {
  MILESTONE
  ACHIEVEMENT
  SKILL
  PARTICIPATION
  LEADERSHIP
}

enum CollaborationStatus {
  PROPOSED
  ACTIVE
  COMPLETED
  CANCELLED
}