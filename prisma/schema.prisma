// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  enrichmentProfile LeadEnrichmentProfile?
  personalizedOffers PersonalizedOffer[]
  coachingSuggestions CoachingSuggestion[]
  riskValidations RiskValidationResult[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// LEAD ENRICHMENT & PERSONALIZATION MODELS (Phase 16.3.7)
// ========================================

// DataProvider - Third-party data enrichment providers
model DataProvider {
  id                  String   @id @default(uuid())
  name                String
  type                String   // zoominfo, apollo, clearbit, etc.
  description         String?
  apiEndpoint         String?
  apiKey              String?
  apiSecret           String?
  rateLimitPerMinute  Int?
  rateLimitPerDay     Int?
  status              String   @default("active")
  priority            Int      @default(0)
  cacheTtlMinutes     Int      @default(1440) // 24 hours default
  isEnabled           Boolean  @default(true)
  lastSuccessfulAt    DateTime?
  lastErrorAt         DateTime?
  lastErrorMessage    String?
  totalCalls          Int      @default(0)
  failedCalls         Int      @default(0)
  successRate         Float    @default(1.0)
  config              Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships
  enrichmentProfiles  LeadEnrichmentProfile[]

  // Indexes
  @@index([type])
  @@index([status])
  @@index([isEnabled])
  @@index([priority])
}

// LeadEnrichmentProfile - Cached enriched lead data
model LeadEnrichmentProfile {
  id                  String   @id @default(uuid())
  leadId              String   @unique
  enrichmentVersion   Int      @default(1)
  demographics        Json?    // EnrichmentDemographics
  firmographics       Json?    // EnrichmentFirmographics
  behavioral          Json?    // EnrichmentBehavioral
  risk                Json?    // EnrichmentRisk
  propertyData        Json?    // EnrichmentProperty
  vehicleData         Json?    // EnrichmentVehicle[]
  confidenceScore     Float    @default(0.0)
  dataSources         String[] // Provider IDs
  dataFreshness       Json?    // Map of field -> {enrichedAt, providerId, expiresAt}
  dataConflicts       Json?    // DataConflict[]
  enrichmentMetadata  Json     // Total data points, duration, etc.
  lastEnrichedAt      DateTime @default(now())
  expiresAt           DateTime
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships
  lead                Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  dataProviders       DataProvider[] @relation("EnrichmentProviders")
  personalizedOffers  PersonalizedOffer[]
  coachingSuggestions CoachingSuggestion[]
  riskValidations     RiskValidationResult[]

  // Indexes
  @@index([leadId])
  @@index([confidenceScore])
  @@index([lastEnrichedAt])
  @@index([expiresAt])
}

// PersonalizedOffer - Recommended offers for leads
model PersonalizedOffer {
  id                    String   @id @default(uuid())
  leadId                String
  callId                String?
  tier                  String   // primary, secondary, tertiary
  offerType             String   // auto, home, life, health, commercial, bundle
  title                 String
  description           String
  coverageDetails       Json
  premium               Json     // {amount, currency, frequency}
  coverageLimits        Json
  deductibles           Json
  reasoning             Json[]   // OfferReasoning[]
  fitScore              Float    @default(0.0)
  confidence            Float    @default(0.0)
  estimatedConversionProbability Float @default(0.0)
  competitiveAdvantages String[]
  abTestVariant         String?
  validUntil            DateTime
  status                String   @default("suggested")
  metadata              Json?
  presentedAt           DateTime?
  acceptedAt            DateTime?
  rejectedAt            DateTime?
  rejectionReason       String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  lead                  Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  enrichmentProfile     LeadEnrichmentProfile @relation(fields: [leadId], references: [id], onDelete: Cascade)
  acceptanceHistory     OfferAcceptanceHistory[]

  // Indexes
  @@index([leadId])
  @@index([callId])
  @@index([offerType])
  @@index([tier])
  @@index([status])
  @@index([validUntil])
  @@index([createdAt])
}

// OfferAcceptanceHistory - Track offer conversion outcomes
model OfferAcceptanceHistory {
  id                  String   @id @default(uuid())
  offerId             String
  leadId              String
  agentId             String?
  callId              String?
  status              String
  presentedAt         DateTime
  acceptedAt          DateTime?
  rejectedAt          DateTime?
  rejectionReason     String?
  agentFeedback       String?
  outcomeMetadata     Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relationships
  offer               PersonalizedOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([offerId])
  @@index([leadId])
  @@index([agentId])
  @@index([callId])
  @@index([status])
  @@index([presentedAt])
}

// CoachingSuggestion - Real-time coaching for agents
model CoachingSuggestion {
  id                    String   @id @default(uuid())
  leadId                String
  callId                String?
  agentId               String?
  type                  String   // sentiment_adjustment, objection_handling, etc.
  title                 String
  content               String
  suggestedScript       String?
  talkingPoints         String[]
  confidence            String   // high, medium, low
  priority              String   @default("medium")
  triggeredBy           Json[]   // SuggestionTrigger[]
  context               Json     // SuggestionContext
  estimatedImpact       String
  expiresAt             DateTime
  status                String   @default("pending")
  acknowledgedAt        DateTime?
  usedAt                DateTime?
  dismissedAt           DateTime?
  feedback              Json?    // SuggestionFeedback
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relationships
  lead                  Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  enrichmentProfile     LeadEnrichmentProfile @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([callId])
  @@index([agentId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([expiresAt])
  @@index([createdAt])
}

// RiskValidationResult - Fraud and compliance validation
model RiskValidationResult {
  id                    String   @id @default(uuid())
  leadId                String
  validationType        String   // fraud, compliance, quality
  overallRiskScore      Float    @default(0.0)
  severity              String   // low, medium, high, critical
  isApproved            Boolean  @default(true)
  requiresReview        Boolean  @default(false)
  autoEscalate          Boolean  @default(false)
  validationChecks      Json[]   // ValidationCheck[]
  validationMetadata    Json     // checksPerformed, passed, failed, duration
  validatedAt           DateTime @default(now())
  expiresAt             DateTime
  createdAt             DateTime @default(now())

  // Relationships
  lead                  Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  enrichmentProfile     LeadEnrichmentProfile @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([validationType])
  @@index([severity])
  @@index([isApproved])
  @@index([validatedAt])
}

// PersonalizationEffectivenessMetrics - Analytics tracking
model PersonalizationEffectivenessMetrics {
  id                    String   @id @default(uuid())
  periodStart           DateTime
  periodEnd             DateTime
  leadsWithPersonalization      Int      @default(0)
  leadsWithoutPersonalization   Int      @default(0)
  conversionWithPersonalization Int      @default(0)
  conversionWithoutPersonalization Int  @default(0)
  conversionUplift      Float    @default(0.0)
  conversionUpliftAbsolute Float  @default(0.0)

  offerMetrics          Json
  suggestionMetrics     Json
  sentimentMetrics      Json
  costMetrics           Json
  topPerformingCombinations Json[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Indexes
  @@index([periodStart])
  @@index([periodEnd])
  @@unique([periodStart, periodEnd])
}