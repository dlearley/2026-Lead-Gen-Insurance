// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]
  importRecords   DataImportRecord[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// NLP and Document Processing Enums
enum DocumentType {
  POLICY_AUTO
  POLICY_HOME
  POLICY_LIFE
  POLICY_HEALTH
  POLICY_COMMERCIAL
  CLAIM_FORM
  MEDICAL_RECORD
  REPAIR_ESTIMATE
  PROOF_OF_LOSS
  INSPECTION_REPORT
  POLICE_REPORT
  FINANCIAL_STATEMENT
  IDENTITY_DOCUMENT
  OTHER
}

enum DocumentClass {
  INSURANCE_POLICY
  CLAIM_DOCUMENTATION
  MEDICAL_RECORDS
  ESTIMATE
  LEGAL_DOCUMENT
  FINANCIAL_DOCUMENT
  IDENTITY_VERIFICATION
  SUPPORTING_DOCUMENT
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
  MANUAL_REVIEW
}

enum EntityType {
  PARTY_INSURED
  PARTY_CLAIMANT
  PARTY_BENEFICIARY
  PARTY_PROVIDER
  PARTY_WITNESS
  COVERAGE_LIABILITY
  COVERAGE_COLLISION
  COVERAGE_COMPREHENSIVE
  COVERAGE_UNINSURED_MOTORIST
  COVERAGE_DEDUCTIBLE
  FINANCIAL_PREMIUM
  FINANCIAL_LIMIT
  FINANCIAL_COVERAGE_AMOUNT
  FINANCIAL_COPAY
  TEMPORAL_EFFECTIVE_DATE
  TEMPORAL_EXPIRATION
  TEMPORAL_CLAIM_DATE
  TEMPORAL_INCIDENT_DATE
  VEHICLE_VIN
  VEHICLE_MAKE
  VEHICLE_MODEL
  VEHICLE_YEAR
  VEHICLE_USAGE
  VEHICLE_MILEAGE
  PROPERTY_ADDRESS
  PROPERTY_SQUARE_FOOTAGE
  PROPERTY_TYPE
  PROPERTY_YEAR_BUILT
  PROPERTY_CONDITION
  MEDICAL_ICD_CODE
  MEDICAL_CPT_CODE
  MEDICAL_DIAGNOSIS
  MEDICAL_TREATMENT
  MEDICAL_PROVIDER
  RISK_AGE
  RISK_OCCUPATION
  RISK_LIFESTYLE
  RISK_SMOKING_STATUS
  RISK_HEALTH_CONDITION
}

enum ValidationType {
  PAGE_COUNT
  READABILITY
  COMPLETENESS
  SIGNATURE
  DATE_VALIDITY
  CONSISTENCY
}

enum ValidationSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ConversationType {
  PHONE
  CHAT
  EMAIL
  MEETING
}

enum ConversationChannel {
  INBOUND
  OUTBOUND
  INTERNAL
}

enum IntentType {
  QUOTE_REQUEST
  POLICY_INQUIRY
  CLAIMS_SUBMISSION
  CLAIMS_STATUS
  BILLING_PAYMENT_QUESTION
  COVERAGE_VERIFICATION
  COMPLAINT_ESCALATION
  DOCUMENT_REQUEST
  CANCELLATION_NON_RENEWAL
  PRODUCT_UPGRADE
  OTHER
}

enum SentimentType {
  POSITIVE
  NEUTRAL
  NEGATIVE
  VERY_NEGATIVE
}

enum NoteCreatedBy {
  AI_SYSTEM
  AGENT
  CUSTOMER
  SYSTEM
}

// ========================================
// NLP AND DOCUMENT PROCESSING MODELS
// ========================================

// Processed Documents - tracks all documents processed through NLP pipeline
model ProcessedDocument {
  id                          String            @id @default(uuid())
  originalDocumentId          String?
  leadId                      String?
  claimId                     String?
  customerId                  String?
  documentType                DocumentType?
  documentClass               DocumentClass?
  classificationConfidence    Float?
  documentLanguage            String?           @default("en")
  originalLanguage            String?
  filePath                    String?
  extractedText               String?           @db.Text
  pageCount                   Int?
  ocrConfidence               Float?
  isReadable                  Boolean?
  processingStatus            ProcessingStatus  @default(PENDING)
  processedAt                 DateTime?
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt

  // Relationships
  entities                    DocumentEntity[]
  validations                 DocumentValidation[]
  embeddings                  DocumentEmbedding[]
  policySummaries             PolicySummary[]

  @@index([leadId])
  @@index([claimId])
  @@index([customerId])
  @@index([documentType, classificationConfidence(sort: Desc)])
  @@index([processingStatus])
}

// Document Entities - extracted entities from documents
model DocumentEntity {
  id                String          @id @default(uuid())
  documentId        String
  entityType        EntityType
  entityValue       String
  entityConfidence  Float?
  pageNumber        Int?
  startPosition     Int?
  endPosition       Int?
  context           String?         @db.Text
  normalizedValue   String?
  linkedEntityId    String?
  createdAt         DateTime        @default(now())

  // Relationships
  document          ProcessedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([entityType, entityConfidence(sort: Desc)])
}

// Document Validation Results
model DocumentValidation {
  id                  String              @id @default(uuid())
  documentId          String
  validationType      ValidationType
  isValid             Boolean
  issueDescription    String?             @db.Text
  severity            ValidationSeverity?
  actionRequired      String?
  reviewerNotes       String?             @db.Text
  reviewedBy          String?
  reviewedAt          DateTime?
  createdAt           DateTime            @default(now())

  // Relationships
  document            ProcessedDocument   @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([validationType, isValid])
}

// Conversations - phone calls, chats, emails, meetings
model Conversation {
  id                      String              @id @default(uuid())
  customerId              String?
  agentId                 String?
  conversationType        ConversationType
  conversationChannel      ConversationChannel
  startedAt               DateTime?
  endedAt                 DateTime?
  durationSeconds         Int?
  transcription           String?             @db.Text
  transcriptionConfidence Float?
  originalLanguage        String?             @default("en")
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  // Relationships
  analysis                ConversationAnalysis?
  automatedNotes          AutomatedNote[]

  @@index([customerId, createdAt(sort: Desc)])
  @@index([agentId])
  @@index([conversationType])
}

// Conversation Analysis - NLP analysis of conversations
model ConversationAnalysis {
  id                        String              @id @default(uuid())
  conversationId            String              @unique
  primaryIntent             IntentType?
  secondaryIntents          Json?
  overallSentiment          SentimentType?
  sentimentScore            Float?
  emotionDetected           Json?
  customerSatisfactionScore Float?
  topicsDiscussed           Json?
  keyPhrases                Json?
  issuesRaised              Json?
  escalationFlag            Boolean             @default(false)
  escalationReason          String?             @db.Text
  createdAt                 DateTime            @default(now())

  // Relationships
  conversation              Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([overallSentiment])
  @@index([escalationFlag])
}

// Automated Notes - AI-generated notes from conversations/documents
model AutomatedNote {
  id                    String      @id @default(uuid())
  conversationId        String?
  customerId            String
  leadId                String?
  claimId               String?
  noteSummary           String      @db.Text
  customerSentiment     SentimentType?
  issuesIdentified      Json?
  productsDiscussed     Json?
  actionItems           Json?
  followUpRequired      Boolean     @default(false)
  followUpType          String?
  followUpDueDate       DateTime?
  noteQualityScore      Float?
  createdBy             NoteCreatedBy @default(AI_SYSTEM)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relationships
  conversation          Conversation? @relation(fields: [conversationId], references: [id])

  @@index([customerId, createdAt(sort: Desc)])
  @@index([leadId])
  @@index([claimId])
}

// Policy Summaries - AI-generated policy summaries
model PolicySummary {
  id                      String            @id @default(uuid())
  policyId                String?
  policyDocumentId       String?
  executiveSummary        String?           @db.Text
  coverageSummary         Json?
  keyHighlights           Json?
  plainEnglishSummary     String?           @db.Text
  importantExclusions     Json?
  customerActionItems     Json?
  summaryQualityScore     Float?
  generatedAt             DateTime?
  updatedAt               DateTime           @default(now())

  // Relationships
  document                ProcessedDocument @relation(fields: [policyDocumentId], references: [id])

  @@index([policyId])
}

// Document Embeddings - for semantic search
model DocumentEmbedding {
  id                String   @id @default(uuid())
  documentId        String
  embeddingModel    String
  embeddingVector   Unsupported("vector(1536)")?
  chunkIndex        Int?
  chunkText         String?  @db.Text
  createdAt         DateTime @default(now())

  // Relationships
  document          ProcessedDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

// NLP Models - model registry
model NLPModel {
  id                  String   @id @default(uuid())
  modelName           String
  modelType           String
  modelCategory       String
  baseModel           String?
  modelVersion        Int
  language            String?
  trainingDate        DateTime?
  performanceMetrics  Json?
  isActive            Boolean  @default(false)
  createdAt           DateTime @default(now())

  @@index([modelType, isActive])
}

// Document Processing Analytics
model DocumentAnalytics {
  id                           String   @id @default(uuid())
  periodDate                   DateTime @db.Date
  documentType                 String?
  totalDocumentsProcessed      Int      @default(0)
  successfulExtractions        Int      @default(0)
  extractionRate               Float?
  averageOcrConfidence         Float?
  averageClassificationConfidence Float?
  manualReviewsRequired        Int      @default(0)
  averageProcessingTimeSeconds Float?
  updatedAt                    DateTime @default(now())

  @@unique([periodDate, documentType])
  @@index([periodDate])
}

// Conversation Processing Analytics
model ConversationAnalytics {
  id                           String   @id @default(uuid())
  periodDate                   DateTime @db.Date
  conversationChannel          String?
  totalConversations           Int      @default(0)
  averageDurationSeconds       Float?
  transcriptionSuccessRate     Float?
  intentDetectionAccuracy      Float?
  sentimentAccuracy            Float?
  escalationRate               Float?
  averageSentimentScore        Float?
  automatedNotesGenerated      Int      @default(0)
  updatedAt                    DateTime @default(now())

  @@unique([periodDate, conversationChannel])
  @@index([periodDate])
}
