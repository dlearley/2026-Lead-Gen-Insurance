// Prisma schema for Insurance Lead Generation AI Platform
// This schema defines the relational data model for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client"
}

// Lead model - stores all lead information
model Lead {
  id              String     @id @default(uuid())
  source          String
  email           String?
  phone           String?
  firstName       String?
  lastName        String?
  street          String?
  city            String?
  state           String?
  zipCode         String?
  country         String?
  insuranceType   InsuranceType?
  qualityScore    Int?
  status          LeadStatus  @default(RECEIVED)
  metadata        Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relationships
  assignments     LeadAssignment[]
  events          Event[]

  // Indexes for performance
  @@index([email])
  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([insuranceType, qualityScore])
  @@index([zipCode, insuranceType])
  @@index([source, status])
}

// Agent model - stores insurance agent information
model Agent {
  id                  String     @id @default(uuid())
  firstName           String
  lastName            String
  email               String     @unique
  phone               String
  licenseNumber       String     @unique
  specializations     String[]
  city                String
  state               String
  country             String
  rating              Float      @default(0.0)
  isActive            Boolean    @default(true)
  maxLeadCapacity     Int        @default(10)
  currentLeadCount    Int        @default(0)
  averageResponseTime Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  assignments         LeadAssignment[]

  // Indexes
  @@index([email])
  @@index([licenseNumber])
  @@index([isActive])
  @@index([city])
  @@index([state])
  @@index([isActive, currentLeadCount])
  @@index([state, city, specializations])
  @@index([rating, isActive])
}

// LeadAssignment model - tracks lead to agent assignments
model LeadAssignment {
  id            String      @id @default(uuid())
  leadId        String
  agentId       String
  assignedAt    DateTime   @default(now())
  status        AssignmentStatus @default(PENDING)
  acceptedAt    DateTime?
  notes         String?

  // Relationships
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent         Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([assignedAt])
  @@index([status, assignedAt])
  @@index([agentId, status])
  @@index([leadId, status])
}

// Event model - event sourcing for all system events
model Event {
  id          String    @id @default(uuid())
  type        String
  source      String
  entityType  String
  entityId    String
  data        Json
  timestamp   DateTime @default(now())
  metadata    Json?

  // Relationships
  lead        Lead?     @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([type])
  @@index([source])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
  @@index([entityType, entityId, timestamp])
  @@index([type, timestamp])
  @@index([source, timestamp])
}

// Carrier model - stores insurance carrier information and partnership details
model Carrier {
  id                  String     @id @default(uuid())
  name                String
  description         String?
  website             String?
  contactEmail        String
  contactPhone        String
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  partnershipTier     PartnershipTier @default(BASIC)
  partnershipStatus   PartnershipStatus @default(ACTIVE)
  contractStartDate   DateTime
  contractEndDate     DateTime?
  commissionRate      Float      @default(0.0)
  isActive            Boolean    @default(true)
  integrationEnabled  Boolean    @default(false)
  apiEndpoint         String?
  apiKey              String?
  performanceScore    Float      @default(0.0)
  conversionRate      Float      @default(0.0)
  averageResponseTime Float      @default(0.0)
  totalLeadsReceived  Int        @default(0)
  totalLeadsConverted Int        @default(0)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relationships
  performanceMetrics CarrierPerformanceMetric[]

  // Indexes
  @@index([name])
  @@index([partnershipStatus])
  @@index([partnershipTier])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, partnershipStatus])
  @@index([partnershipTier, performanceScore])
}

// CarrierPerformanceMetric model - tracks carrier performance over time
model CarrierPerformanceMetric {
  id                    String     @id @default(uuid())
  carrierId             String
  month                 Int
  year                  Int
  leadsReceived         Int        @default(0)
  leadsConverted        Int        @default(0)
  conversionRate        Float      @default(0.0)
  averageResponseTime   Float      @default(0.0)
  averageQuoteValue     Float      @default(0.0)
  customerSatisfaction  Float      @default(0.0)
  onTimeDeliveryRate    Float      @default(0.0)
  createdAt             DateTime   @default(now())

  // Relationships
  carrier               Carrier    @relation(fields: [carrierId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([carrierId])
  @@index([year])
  @@index([month])
  @@index([createdAt])
  @@unique([carrierId, year, month])
}

// Enums for type safety
enum LeadStatus {
  RECEIVED
  PROCESSING
  QUALIFIED
  ROUTED
  CONVERTED
  REJECTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  TIMEOUT
}

enum InsuranceType {
  AUTO
  HOME
  LIFE
  HEALTH
  COMMERCIAL
}

enum PartnershipTier {
  BASIC
  STANDARD
  PREMIUM
  ELITE
  STRATEGIC
}

enum PartnershipStatus {
  ACTIVE
  PENDING
  SUSPENDED
  TERMINATED
  RENEWAL_NEEDED
}

// ========================================
// GLOBAL EXPANSION MODELS (Phase 28)
// ========================================

// Language model - supported languages
model Language {
  id                String   @id @default(uuid())
  code              String   @unique // 'en', 'es', 'fr', etc.
  name              String   // 'English', 'Spanish', etc.
  nativeName         String   // 'English', 'Español', etc.
  textDirection     TextDirection @default(LTR)
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  translations      Translation[]
  customerPreferences CustomerLocalizationPreferences[]
  agentCapabilities  AgentLanguageCapability[]
  leadRegionalData   LeadRegionalData[]

  @@index([code])
  @@index([isActive])
}

// Currency model - supported currencies
model Currency {
  id                String   @id @default(uuid())
  code              String   @unique // 'USD', 'EUR', etc.
  name              String   // 'US Dollar', 'Euro', etc.
  symbol            String   // ', '€', etc.
  decimalPlaces     Int      @default(2)
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  customerPreferences CustomerLocalizationPreferences[]
  agentCapabilities    AgentLanguageCapability[]
  leadRegionalData     LeadRegionalData[]

  @@index([code])
  @@index([isActive])
}

// RegionalSettings model - regional configuration
model RegionalSettings {
  id                    String   @id @default(uuid())
  regionCode            String   @unique // 'US', 'CA', 'GB', etc.
  name                  String   // 'United States', 'Canada', etc.
  defaultLocale         String   // 'en', 'es', etc.
  defaultCurrency       String   // 'USD', 'CAD', etc.
  defaultTimezone       String   // 'America/New_York', etc.
  gdprEnabled          Boolean  @default(false)
  ccpaEnabled          Boolean  @default(false)
  dataRetentionDays     Int      @default(2555) // 7 years default
  consentRequired       Boolean  @default(true)
  privacyPolicyUrl     String?
  termsOfServiceUrl    String?
  dateFormat           String   @default("MM/DD/YYYY")
  timeFormat           String   @default("12-hour")
  numberFormat         String   @default("1,234.56")
  currencyFormat       String   @default("$1,234.56")
  addressFormat        String   @default("street, city, state zip")
  phoneFormat          String   @default("+1 (XXX) XXX-XXXX")
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  customerPreferences CustomerLocalizationPreferences[]
  agentCapabilities    AgentLanguageCapability[]
  agentExpertise      AgentRegionalExpertise[]
  leadRegionalData     LeadRegionalData[]

  @@index([regionCode])
  @@index([isActive])
}

// Translation model - translation key-value storage
model Translation {
  id                String   @id @default(uuid())
  key               String   // 'common.save', 'nav.dashboard', etc.
  namespace         String   @default('common') // 'common', 'nav', 'forms', etc.
  value             String   // translated value
  locale            String   // 'en', 'es', 'fr', etc.
  context           String?  // optional context
  description       String?  // optional description
  isActive          Boolean  @default(true)
  lastUpdated       DateTime @default(now())
  updatedBy         String?  // user id who last updated

  // Relationships
  language          Language @relation(fields: [locale: code], references: [code])

  @@unique([key, locale])
  @@index([key])
  @@index([locale])
  @@index([namespace])
}

// CustomerLocalizationPreferences model - customer locale preferences
model CustomerLocalizationPreferences {
  id                    String   @id @default(uuid())
  customerId            String   @unique
  locale                String   @default('en')
  regionCode            String   @default('US')
  currencyCode          String   @default('USD')
  timezone              String   @default('UTC')
  dateFormat            String   @default('MM/DD/YYYY')
  numberFormat          String   @default('1,234.56')
  addressFormat        String   @default('street, city, state zip')
  phoneFormat          String   @default('+1 (XXX) XXX-XXXX')
  communicationLanguage String  @default('en')
  marketingConsent      Boolean  @default(false)
  privacyConsent        Boolean  @default(false)
  gdprConsent           Boolean?
  ccpaConsent           Boolean?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  language             Language?        @relation(fields: [locale: code], references: [code])
  region              RegionalSettings? @relation(fields: [regionCode: regionCode], references: [regionCode])
  currency            Currency?        @relation(fields: [currencyCode: code], references: [code])

  @@index([customerId])
  @@index([locale])
  @@index([regionCode])
  @@index([currencyCode])
}

// AgentLanguageCapability model - agent language skills
model AgentLanguageCapability {
  id                String   @id @default(uuid())
  agentId           String
  locale            String   @default('en')
  regionCode        String   @default('US')
  currencyCode      String   @default('USD')
  proficiencyLevel  ProficiencyLevel @default(BASIC)
  certification     String?
  isVerified        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  agent             Agent    @relation(fields: [agentId: id], references: [id], onDelete: Cascade)
  language          Language?        @relation(fields: [locale: code], references: [code])
  region           RegionalSettings? @relation(fields: [regionCode: regionCode], references: [regionCode])
  currency         Currency?        @relation(fields: [currencyCode: code], references: [code])

  @@unique([agentId, locale])
  @@index([agentId])
  @@index([locale])
  @@index([regionCode])
  @@index([proficiencyLevel])
}

// AgentRegionalExpertise model - agent regional expertise
model AgentRegionalExpertise {
  id                String   @id @default(uuid())
  agentId           String
  regionCode        String   @default('US')
  specialization    String[] // ['auto-insurance', 'commercial', etc.]
  experienceYears   Int      @default(0)
  localKnowledge    String[] // ['US-tax-law', 'state-regulations', etc.]
  culturalCompetence String[] // ['direct-communication', 'formal-greetings', etc.]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  agent             Agent    @relation(fields: [agentId: id], references: [id], onDelete: Cascade)
  region           RegionalSettings @relation(fields: [regionCode: regionCode], references: [regionCode])

  @@unique([agentId, regionCode])
  @@index([agentId])
  @@index([regionCode])
}

// LeadRegionalData model - lead regional information
model LeadRegionalData {
  id                  String   @id @default(uuid())
  leadId              String   @unique
  locale              String   @default('en')
  regionCode          String   @default('US')
  timezone            String   @default('UTC')
  currencyCode        String   @default('USD')
  addressCountry      String   @default('US')
  phoneCountry       String   @default('US')
  communicationStyle  CommunicationStyle @default(DIRECT)
  businessHoursStart  String?  // '09:00'
  businessHoursEnd    String?  // '17:00'
  holidays            String[] // ['2025-01-01', '2025-12-25']
  culturalPreferences Json?    // flexible storage for cultural data
  complianceFlags     Json?    // compliance requirements and status
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relationships
  lead                Lead     @relation(fields: [leadId: id], references: [id], onDelete: Cascade)
  language           Language?        @relation(fields: [locale: code], references: [code])
  region            RegionalSettings? @relation(fields: [regionCode: regionCode], references: [regionCode])
  currency          Currency?        @relation(fields: [currencyCode: code], references: [code])

  @@index([leadId])
  @@index([locale])
  @@index([regionCode])
  @@index([currencyCode])
}

// ========================================
// ENUMS FOR GLOBAL EXPANSION
// ========================================

enum TextDirection {
  LTR
  RTL
}

enum ProficiencyLevel {
  BASIC
  CONVERSATIONAL
  FLUENT
  NATIVE
}

enum CommunicationStyle {
  DIRECT
  INDIRECT
  FORMAL
  INFORMAL
}